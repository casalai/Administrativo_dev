<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci贸n de Acceso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Actualizado: quitar integrity incorrecto para evitar bloqueo y usar versi贸n 6.5.1 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
        #loading-overlay { background-color: rgba(255, 255, 255, 0.8); transition: opacity 0.3s ease-in-out; }
        .password-container { position: relative; }
        .password-toggle { position: absolute; top: 50%; right: 0.75rem; transform: translateY(-50%); cursor: pointer; }
        .permission-group { margin-bottom: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; }
        .permission-group-title { font-weight: 600; margin-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; }
        /* Est谩ndar de botones y contenedores */
        #admin-section button { display: inline-flex; align-items: center; justify-content: center; min-height: 2.5rem; line-height: 1; border-radius: 0.5rem; font-weight: 600; padding: 0.5rem 1rem; gap: 0.5rem; white-space: nowrap; }
        .btn-row { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; }
        .btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
        /* conos responsivos: ocultar texto en pantallas estrechas */
        @media (max-width: 640px) {
            .btn-row .btn-text, .btn-group .btn-text { display: none; }
            #admin-section button { min-width: 2.5rem; padding-left: 0.5rem; padding-right: 0.5rem; }
        }
        /* Ocultar texto un poco antes para evitar desbordes en layouts amplios con muchas acciones */
        @media (max-width: 1024px) {
            .btn-row .btn-text, .btn-group .btn-text { display: none; }
            #admin-section button { min-width: 2.5rem; padding-left: 0.5rem; padding-right: 0.5rem; }
        }
        /* Evitar que las acciones de tabla se rompan a otra l铆nea en desktop */
        .no-wrap-actions { flex-wrap: nowrap; }
        .table-actions button { padding: 0.375rem 0.5rem; font-size: 0.875rem; }
        .table-actions { gap: 0.375rem; }
        /* Acciones en modales: siempre mostrar texto y dar mayor 谩rea clickeable */
        .modal-actions .btn-text { display: inline !important; }
        .modal-actions button { min-height: 2.75rem; min-width: 9rem; font-size: 0.95rem; }
        @media (max-width: 640px) {
            .modal-actions { flex-direction: column; align-items: stretch; }
            .modal-actions button { width: 100%; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <div id="app-container" class="min-h-screen flex items-center justify-center p-4">

        <div id="login-section" class="w-full max-w-md">
            <div class="bg-white shadow-lg rounded-xl px-8 pt-6 pb-8 mb-4">
                <h1 class="text-2xl font-bold text-center text-gray-700 mb-6">Control de Procesos</h1>
                <h2 class="text-xl text-center text-gray-600 mb-4">Iniciar Sesi贸n</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="user-select" class="block text-gray-700 text-sm font-bold mb-2">Seleccione su Usuario:</label>
                        <select id="user-select" class="shadow border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option>Cargando usuarios...</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contrase帽a:</label>
                        <input id="password" type="password" placeholder="******************" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="flex items-center justify-between">
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">Acceder</button>
                    </div>
                    <div id="login-message" class="text-center text-red-500 text-sm mt-4 h-4"></div>
                </form>
            </div>
        </div>

        <div id="admin-section" class="hidden w-full max-w-6xl">
            <div class="bg-white shadow-lg rounded-xl p-6 space-y-8 overflow-hidden">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div><h1 class="text-3xl font-bold text-gray-800">Panel de Administraci贸n</h1><p id="welcome-message" class="text-gray-600 hidden"></p></div>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <span class="btn-text">Cerrar Sesi贸n</span>
                    </button>
                </div>
                
                <div class="border-t pt-6">
                    <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                        <h2 class="text-2xl font-semibold">Gesti贸n de Usuarios</h2>
                        <div class="btn-group">
                            <button id="reset-passwords-btn" class="bg-gray-700 hover:bg-gray-800 text-white" title="Eliminar contrase帽as de todos los usuarios">
                                <i class="fa-solid fa-key"></i>
                                <span class="btn-text">Resetear Contrase帽as</span>
                            </button>
                            <button id="create-user-btn" class="bg-purple-600 hover:bg-purple-700 text-white">
                                <i class="fa-solid fa-user-plus"></i>
                                <span class="btn-text">Crear Usuario</span>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <input id="user-search-input" type="text" placeholder="Buscar usuarios por nombre o rol..." class="w-full md:w-1/2 shadow appearance-none border rounded-lg py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" />
                    </div>
                    <div class="hidden lg:block overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-2 px-4 text-center">Posici贸n</th>
                                    <th class="py-2 px-4 text-center">Nombre</th>
                                    <th class="py-2 px-4 text-left">Roles</th>
                                    <th class="py-2 px-4 text-center">Estado</th>
                                    <th class="py-2 px-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body"></tbody>
                        </table>
                    </div>
                    <div id="user-cards" class="block lg:hidden grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                    <div id="user-pagination" class="flex items-center justify-center gap-2 mt-3"></div>
                </div>

                <div class="border-t pt-6">
                    <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                        <h2 class="text-2xl font-semibold">Gesti贸n de Roles</h2>
                        <div class="btn-row">
                            <div class="btn-group">
                                <button id="create-role-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center">
                                    <i class="fa-solid fa-plus btn-icon"></i>
                                    <span class="btn-text">Crear Rol</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <input id="role-search-input" type="text" placeholder="Buscar roles..." class="w-full md:w-1/3 shadow appearance-none border rounded-lg py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" />
                    </div>
                    <div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-200"><tr><th class="py-2 px-4 text-left">Nombre del Rol</th><th class="py-2 px-4 text-center">Acciones</th></tr></thead><tbody id="role-table-body"></tbody></table></div>
                    <div id="role-pagination" class="flex items-center justify-center gap-2 mt-3"></div>
                </div>

                <div class="border-t pt-6">
                    <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                        <h2 class="text-2xl font-semibold">Gesti贸n de Funciones (Permisos)</h2>
                        <div class="btn-row">
                            <div class="btn-group">
                                <button id="create-permission-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center">
                                    <i class="fa-solid fa-plus btn-icon"></i>
                                    <span class="btn-text">Crear Funci贸n</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <input id="perm-search-input" type="text" placeholder="Buscar funciones por clave, descripci贸n o m贸dulo..." class="w-full md:w-1/2 shadow appearance-none border rounded-lg py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" />
                    </div>
                    <div class="hidden lg:block overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-2 px-4 text-left">Funci贸n (Clave)</th>
                                    <th class="py-2 px-4 text-left">Descripci贸n</th>
                                    <th class="py-2 px-4 text-left">M贸dulo</th>
                                    <th class="py-2 px-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="permission-table-body"></tbody>
                        </table>
                    </div>
                    <div id="permission-cards" class="block lg:hidden grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                    <div id="permission-pagination" class="flex items-center justify-center gap-2 mt-3"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="user-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg"><div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg"><h2 id="user-modal-title" class="text-2xl font-bold mb-6"></h2><form id="user-form"></form></div></div>
    <div id="role-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg"><div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md"><h2 id="role-modal-title" class="text-2xl font-bold mb-6"></h2><form id="role-form"></form></div></div>
    <div id="permission-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg"><div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg"><h2 id="permission-modal-title" class="text-2xl font-bold mb-6"></h2><form id="permission-form"></form></div></div>
    <div id="assign-permission-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg"><div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[90vh] flex flex-col"><h2 id="assign-permission-modal-title" class="text-2xl font-bold mb-4 border-b pb-4"></h2><div id="permissions-container" class="overflow-y-auto flex-grow my-4"></div><div class="btn-row modal-actions justify-end pt-4 border-t"><button type="button" id="cancel-assign-btn" class="bg-gray-500 hover:bg-gray-600 text-white"><i class="fa-solid fa-xmark"></i><span class="btn-text">Cerrar</span></button><button type="button" id="save-assign-btn" class="bg-purple-600 hover:bg-purple-700 text-white"><i class="fa-solid fa-floppy-disk"></i><span class="btn-text">Guardar Permisos</span></button></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        // --- CONFIG & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC4ksfNjhE_31i-BnmV6lOZg2fMq201p0A",
            authDomain: "sistema-productividad-equipo.firebaseapp.com",
            projectId: "sistema-productividad-equipo",
            storageBucket: "sistema-productividad-equipo.appspot.com",
            messagingSenderId: "196802708765",
            appId: "1:196802708765:web:af4265d7ac7f50b6fecdf4",
        };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const employeesCol = db.collection('employees');
    const rolesCol = db.collection('roles');
    const permissionsCol = db.collection('permissions');
    const rolePermissionsCol = db.collection('role_permissions');
    let authInitializationPromise = null;
    let appReady = false;
    let waitingForParentContext = false;

        // ===== Utilidades de seguridad: PBKDF2 (hash de contrase帽as) =====
        const PBKDF2_ITERATIONS = 100000;
        const PBKDF2_HASH = 'SHA-256';
        function strToBytes(str) { return new TextEncoder().encode(str); }
        function bytesToBase64(bytes) {
            let bin = '';
            bytes = new Uint8Array(bytes);
            for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
            return btoa(bin);
        }
        function base64ToBytes(b64) {
            const bin = atob(b64);
            const out = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);
            return out;
        }
        async function pbkdf2Hash(password, saltB64) {
            const salt = saltB64 ? base64ToBytes(saltB64) : crypto.getRandomValues(new Uint8Array(16));
            const keyMaterial = await crypto.subtle.importKey('raw', strToBytes(password), { name: 'PBKDF2' }, false, ['deriveBits']);
            const derivedBits = await crypto.subtle.deriveBits({ name: 'PBKDF2', salt, iterations: PBKDF2_ITERATIONS, hash: PBKDF2_HASH }, keyMaterial, 256);
            const hashB64 = bytesToBase64(new Uint8Array(derivedBits));
            const saltB64Out = bytesToBase64(salt);
            return `pbkdf2$${PBKDF2_ITERATIONS}$${saltB64Out}$${hashB64}`;
        }
        async function pbkdf2Verify(password, stored) {
            try {
                if (!stored || typeof stored !== 'string' || !stored.startsWith('pbkdf2$')) return false;
                const parts = stored.split('$');
                const iterations = parseInt(parts[1], 10);
                const saltB64 = parts[2];
                const expectedHashB64 = parts[3];
                const salt = base64ToBytes(saltB64);
                const keyMaterial = await crypto.subtle.importKey('raw', strToBytes(password), { name: 'PBKDF2' }, false, ['deriveBits']);
                const derivedBits = await crypto.subtle.deriveBits({ name: 'PBKDF2', salt, iterations: iterations || PBKDF2_ITERATIONS, hash: PBKDF2_HASH }, keyMaterial, 256);
                const hashB64 = bytesToBase64(new Uint8Array(derivedBits));
                return hashB64 === expectedHashB64;
            } catch (e) {
                console.warn('Error verificando PBKDF2:', e);
                return false;
            }
        }

        function getDeviceId() {
            let parentHasFn = false;
            try {
                parentHasFn = (window.parent && window.parent !== window && typeof window.parent.getDeviceId === 'function');
            } catch (e) {
                parentHasFn = false;
            }
            if (parentHasFn) {
                try { return window.parent.getDeviceId(); } catch (err) {
                    console.warn('RBAC: getDeviceId del contenedor no disponible:', err);
                }
            }
            let deviceId = localStorage.getItem('rbacDeviceId');
            if (!deviceId) {
                deviceId = 'rbac-' + Math.random().toString(36).slice(2, 9) + '-' + Date.now();
                localStorage.setItem('rbacDeviceId', deviceId);
            }
            return deviceId;
        }

    let allUsers = [], allRoles = [], allPermissions = [], rolePermissionsMap = {}, currentUser = null, currentRoleIdForPermissions = null;
    const PAGE_SIZE = 6;
    let userFilter = '', userPage = 1;
    let roleFilter = '', rolePage = 1;
    let permFilter = '', permPage = 1;

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginSection = document.getElementById('login-section');
        const adminSection = document.getElementById('admin-section');
        const loginForm = document.getElementById('login-form');
        const userSelect = document.getElementById('user-select');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('login-message');
        const welcomeMessage = document.getElementById('welcome-message');
        const logoutButton = document.getElementById('logout-button');
        const userTableBody = document.getElementById('user-table-body');
    const createUserBtn = document.getElementById('create-user-btn');
    const resetPasswordsBtn = document.getElementById('reset-passwords-btn');
        const roleTableBody = document.getElementById('role-table-body');
        const createRoleBtn = document.getElementById('create-role-btn');
        const permissionTableBody = document.getElementById('permission-table-body');
        const createPermissionBtn = document.getElementById('create-permission-btn');
        const userModal = document.getElementById('user-modal');
        const roleModal = document.getElementById('role-modal');
        const permissionModal = document.getElementById('permission-modal');
        const assignPermissionModal = document.getElementById('assign-permission-modal');

        // --- CORE LOGIC ---
        function ensureFirebaseAuth() {
            const existingUser = firebase.auth().currentUser;
            if (existingUser) return Promise.resolve(existingUser);
            if (!authInitializationPromise) {
                authInitializationPromise = firebase.auth().signInAnonymously()
                    .catch(error => {
                        console.error('RBAC: error iniciando sesi贸n an贸nima:', error);
                        authInitializationPromise = null;
                        throw error;
                    });
            }
            return authInitializationPromise.then(cred => cred.user || firebase.auth().currentUser);
        }

        function applyParentContext(data) {
            const parentUser = data.appUser || (data.type === 'setCurrentUser' ? data.user : null);
            if (!parentUser) return;
            currentUser = parentUser;
            if (data.permissions) {
                currentUser.permissions = Array.isArray(data.permissions) ? data.permissions : [];
            }
            if (data.roles) {
                currentUser.roles = Array.isArray(data.roles) ? data.roles : [];
            }
            const displayName = currentUser.name || currentUser.displayName || 'Usuario';
            welcomeMessage.textContent = `Conectado como ${displayName}`;
            loginSection.classList.add('hidden');
            adminSection.classList.remove('hidden');
            renderUserTable();
            renderRoleTable();
            renderPermissionTable();
            toggleLoading(false);
            waitingForParentContext = false;
            const isInIframe = window !== window.parent;
            if (isInIframe && currentUser.id) {
                try { window.parent.postMessage({ type: 'currentUserReceived', userId: currentUser.id }, '*'); } catch (err) { console.warn('rbac: no se pudo enviar ACK al padre', err); }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                toggleLoading(true);
                setupModalTemplates();
                setupEventListeners();
                await ensureFirebaseAuth();
                await migrateDataStructure();
                await ensureBaseData();

                listenForRoleChanges();
                listenForPermissionChanges();
                listenForRolePermissionChanges(); // <-- A帽adido
                listenForUserChanges(); 
                // Si estamos embebidos en un iframe, solicitar currentUser al padre para auto-login
                const isInIframe = window !== window.parent;
                let waitForParentTimer = null;
                let unsubscribeActiveSession = null;
                if (isInIframe) {
                    try {
                        // En modo embebido, ocultar la UI de login local y mostrar solo loading hasta recibir usuario
                        loginSection.classList.add('hidden');
                        adminSection.classList.add('hidden');
                        toggleLoading(true);
                        window.parent.postMessage({ type: 'requestUserData' }, '*');
                        window.parent.postMessage({ type: 'requestCurrentUser' }, '*');
                    } catch (e) { console.warn('No se pudo solicitar currentUser al padre:', e); }
                    // Fallback: esperar un poco m谩s y adem谩s intentar leer active_sessions/{deviceId}
                    waitForParentTimer = setTimeout(() => { toggleLoading(true); }, 2500);
                    try { const deviceId = getDeviceId(); unsubscribeActiveSession = subscribeActiveSession(deviceId); } catch(e) { console.warn('rbac: no se pudo subscribir a active_session', e); }
                    // En modo embebido, ocultar el bot贸n de Cerrar Sesi贸n del panel interno (la sesi贸n la controla el padre)
                    try { logoutButton.style.display = 'none'; } catch(e) {}
                    waitingForParentContext = true;
                }

                window.addEventListener('message', (ev) => {
                    try {
                        const data = ev.data || {};
                        if (data && (data.type === 'setCurrentUser' || data.type === 'hostAuthReady')) {
                            appReady = true;
                            if (waitForParentTimer) { clearTimeout(waitForParentTimer); waitForParentTimer = null; }
                            applyParentContext(data);
                        }
                        if (data && data.type === 'noCurrentUserYet') {
                            // Si ya tenemos currentUser, ignorar se帽ales tard铆as para no reactivar el overlay
                            if (currentUser) return;
                            // extender la espera antes de habilitar cualquier fallback visual
                            if (waitForParentTimer) {
                                clearTimeout(waitForParentTimer);
                                waitForParentTimer = setTimeout(() => { toggleLoading(true); }, 8000);
                            }
                        }
                                if (data && data.type === 'parentLoggedOut') {
                                    appReady = false;
                            console.log('rbac: parentLoggedOut recibido -> limpiar estado local');
                            try { if (waitForParentTimer) { clearTimeout(waitForParentTimer); waitForParentTimer = null; } } catch(e) {}
                            try { if (unsubscribeActiveSession) { unsubscribeActiveSession(); unsubscribeActiveSession = null; } } catch(e) {}
                            currentUser = null;
                            adminSection.classList.add('hidden');
                            if (isInIframe) {
                                // en modo embebido volvemos a modo espera, no mostramos login local
                                loginSection.classList.add('hidden');
                                        waitingForParentContext = true;
                                        toggleLoading(true);
                            } else {
                                loginSection.classList.remove('hidden');
                                toggleLoading(false);
                            }
                        }
                    } catch (err) { console.warn('Mensaje inv谩lido en RBAC panel', err); }
                }, false);
            } catch (error) {
                console.error("Error fatal durante la inicializaci贸n:", error);
                document.body.innerHTML = `<div class="p-4 text-center text-red-700 bg-red-100">Error al cargar la aplicaci贸n. Revise la consola.</div>`;
                toggleLoading(false);
            }
        });

        function toggleLoading(show) { 
            loadingOverlay.style.display = show ? 'flex' : 'none'; 
        }

        async function migrateDataStructure() {
            const snapshot = await employeesCol.get();
            const batch = db.batch();
            let updatesNeeded = 0;
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                let update = {};
                if (data.rol_id !== undefined) {
                    update.rol_ids = data.rol_id ? [data.rol_id] : [];
                    update.rol_id = firebase.firestore.FieldValue.delete();
                }
                if (data.order === undefined) {
                    update.order = Date.now() + Math.random();
                }
                if (Object.keys(update).length > 0) {
                    batch.update(doc.ref, update);
                    updatesNeeded++;
                }
            });
            if (updatesNeeded > 0) await batch.commit();
        }

        async function ensureBaseData() {
            const batch = db.batch();
            
            // 1. Definici贸n de Roles y Permisos (actualizados a m贸dulos vigentes)
            const predefinedRoles = {
                'Administrador': [], // Se completa luego con todos los permisos
                'Supervisor': [
                    // Dashboard y Productividad
                    'view_dashboard','view_kpis','view_realtime_activity','view_productivity_charts','view_paused_tasks','view_activity_details','reassign_task',
                    // Inventario
                    'view_items_search','manage_items',
                    // Clientes
                    'manage_clients',
                    // Repuestos
                    'view_part_requests','update_part_request_status',
                    // Usuarios (gesti贸n b谩sica, no roles/permisos)
                    'manage_users'
                ],
                'T茅cnico': [
                    'view_dashboard','view_kpis','view_realtime_activity',
                    // Navegaci贸n/consulta de inventario
                    'view_items_search'
                ]
            };

            const predefinedPermissions = [
                // Dashboard / Productividad
                { key: 'view_dashboard', description: 'Ver el dashboard completo', module: 'Dashboard' },
                { key: 'view_kpis', description: 'Ver los indicadores clave (KPIs)', module: 'Dashboard' },
                { key: 'view_realtime_activity', description: 'Ver la actividad en tiempo real', module: 'Dashboard' },
                { key: 'view_productivity_charts', description: 'Ver los gr谩ficos de productividad', module: 'Dashboard' },
                { key: 'view_paused_tasks', description: 'Ver la lista de tareas en pausa', module: 'Tareas' },
                { key: 'reassign_task', description: 'Reasignar una tarea a otro t茅cnico o a la piscina', module: 'Tareas' },
                { key: 'view_activity_details', description: 'Ver los detalles completos de una actividad', module: 'Tareas' },
                // Repuestos
                { key: 'view_part_requests', description: 'Ver la lista de solicitudes de repuestos', module: 'Repuestos' },
                { key: 'update_part_request_status', description: 'Cambiar el estado de una solicitud de repuesto', module: 'Repuestos' },
                // Administraci贸n general
                { key: 'manage_users', description: 'Crear, editar y gestionar usuarios', module: 'Administraci贸n' },
                { key: 'manage_roles_permissions', description: 'Gestionar roles y asignar permisos', module: 'Administraci贸n' },
                // Inventario (铆tems)
                { key: 'view_items_search', description: 'Buscar y ver 铆tems del inventario', module: 'Inventario' },
                { key: 'manage_items', description: 'Crear y editar 铆tems', module: 'Inventario' },
                { key: 'delete_items', description: 'Eliminar 铆tems del inventario', module: 'Inventario' },
                { key: 'delete_item_media', description: 'Eliminar archivos multimedia/documentos de 铆tems', module: 'Inventario' },
                // Taxonom铆a (categor铆as y atributos)
                { key: 'manage_items_taxonomy', description: 'Gestionar categor铆as y atributos de inventario', module: 'Taxonom铆a' },
                // Clientes
                { key: 'manage_clients', description: 'Crear, editar y administrar clientes', module: 'Clientes' },
                // Presencia y registros
                { key: 'view_presence_dashboard', description: 'Ver panel de presencia', module: 'Presencia' },
                { key: 'view_activity_logs', description: 'Ver bit谩cora/historial de actividad', module: 'Registros' },
                // Tasas/Impuestos
                { key: 'manage_taxes', description: 'Gestionar tasas e impuestos', module: 'Tasas/Impuestos' },
                // Configuraci贸n auxiliar
                { key: 'manage_image_title_presets', description: 'Gestionar presets de t铆tulos de im谩genes', module: 'Configuraci贸n' },
                { key: 'view_incomplete_items', description: 'Ver reporte de 铆tems con datos faltantes', module: 'Inventario' }
            ];

            // El rol Administrador obtiene todos los permisos
            predefinedRoles['Administrador'] = predefinedPermissions.map(p => p.key);

            // 2. Create Permissions if they don't exist
            const permPromises = predefinedPermissions.map(async (perm) => {
                const q = await permissionsCol.where('key', '==', perm.key).limit(1).get();
                if (q.empty) {
                    const docRef = permissionsCol.doc();
                    batch.set(docRef, perm);
                    return { ...perm, id: docRef.id };
                }
                return { ...q.docs[0].data(), id: q.docs[0].id };
            });
            const createdPermissions = await Promise.all(permPromises);
            const permissionsMap = createdPermissions.reduce((acc, perm) => {
                acc[perm.key] = perm.id;
                return acc;
            }, {});

            // 3. Create Roles if they don't exist
            const rolePromises = Object.keys(predefinedRoles).map(async (roleName) => {
                const q = await rolesCol.where('name', '==', roleName).limit(1).get();
                if (q.empty) {
                    const docRef = rolesCol.doc();
                    batch.set(docRef, { name: roleName });
                    return { name: roleName, id: docRef.id };
                }
                return { name: q.docs[0].data().name, id: q.docs[0].id };
            });
            const createdRoles = await Promise.all(rolePromises);
            const rolesMap = createdRoles.reduce((acc, role) => {
                acc[role.name] = role.id;
                return acc;
            }, {});

            // 4. Link Roles and Permissions
            for (const roleName in predefinedRoles) {
                const roleId = rolesMap[roleName];
                const permissionKeys = predefinedRoles[roleName];
                for (const permKey of permissionKeys) {
                    const permissionId = permissionsMap[permKey];
                    const q = await rolePermissionsCol.where('rol_id', '==', roleId).where('permission_id', '==', permissionId).limit(1).get();
                    if (q.empty) {
                        batch.set(rolePermissionsCol.doc(), { rol_id: roleId, permission_id: permissionId });
                    }
                }
            }
            
            // 5. Ensure Superuser "Juan Lai"
            const adminRoleId = rolesMap['Administrador'];
            const juanLaiQuery = await employeesCol.where('name', '==', 'Juan Lai').get();
            if (juanLaiQuery.empty) {
                batch.set(employeesCol.doc(), { 
                    name: 'Juan Lai', 
                    is_active: true, 
                    // No establecer contrase帽a por defecto para forzar primer inicio seguro
                    passwordHash: null,
                    order: 0, 
                    rol_ids: [adminRoleId] 
                });
            } else {
                 const juanLaiDoc = juanLaiQuery.docs[0];
                 const juanLaiData = juanLaiDoc.data();
                 if(!juanLaiData.rol_ids || !juanLaiData.rol_ids.includes(adminRoleId) || juanLaiData.order !== 0) {
                     batch.update(juanLaiDoc.ref, { rol_ids: [adminRoleId], order: 0 });
                 }
            }

            await batch.commit();
        }

        // --- DATA LISTENERS ---
        function listenForUserChanges() {
            employeesCol.orderBy('order').onSnapshot(snapshot => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateUserDropdown();
                if (currentUser) renderUserTable();
                if (!waitingForParentContext) {
                    toggleLoading(false);
                }
            }, error => {
                console.error("Error al cargar usuarios: ", error);
                toggleLoading(false);
            });
        }

        function listenForRoleChanges() {
            rolesCol.orderBy('name').onSnapshot(async (snapshot) => {
                allRoles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // const rpSnapshot = await rolePermissionsCol.get(); // <-- Eliminado
                // rolePermissionsMap = {}; // <-- Eliminado
                // rpSnapshot.forEach(doc => { // <-- Eliminado
                //     const { rol_id, permission_id } = doc.data(); // <-- Eliminado
                //     if (!rolePermissionsMap[rol_id]) rolePermissionsMap[rol_id] = []; // <-- Eliminado
                //     rolePermissionsMap[rol_id].push(permission_id); // <-- Eliminado
                // }); // <-- Eliminado

                if (currentUser) {
                    renderRoleTable();
                    renderUserTable();
                }
            }, error => console.error("Error al cargar roles: ", error));
        }

        function listenForPermissionChanges() {
            permissionsCol.orderBy('module').orderBy('key').onSnapshot(snapshot => {
                allPermissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentUser) renderPermissionTable();
            }, error => console.error("Error al cargar permisos: ", error));
        }

        // --- Nueva funci贸n ---
        function listenForRolePermissionChanges() {
            rolePermissionsCol.onSnapshot(snapshot => {
                rolePermissionsMap = {};
                snapshot.forEach(doc => {
                    const { rol_id, permission_id } = doc.data();
                    if (!rolePermissionsMap[rol_id]) rolePermissionsMap[rol_id] = [];
                    rolePermissionsMap[rol_id].push(permission_id);
                });
                // No es necesario renderizar nada aqu铆, el mapa se usa
                // al abrir el modal de permisos.
            }, error => console.error("Error al cargar permisos de roles: ", error));
        }
        // --- Fin de la nueva funci贸n ---

        // --- RENDER FUNCTIONS ---
        function populateUserDropdown() {
            userSelect.innerHTML = '';
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                userSelect.appendChild(option);
            });
        }

        function renderUserTable() {
            userTableBody.innerHTML = '';
            const filtered = allUsers.filter(u => {
                if (!userFilter) return true;
                const name = (u.name || '').toLowerCase();
                const rolesText = ((u.rol_ids || []).map(rid => (allRoles.find(r => r.id === rid)?.name || '')).join(' ') || '').toLowerCase();
                return name.includes(userFilter) || rolesText.includes(userFilter);
            });
            const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
            if (userPage > totalPages) userPage = totalPages;
            const start = (userPage - 1) * PAGE_SIZE;
            const pageItems = filtered.slice(start, start + PAGE_SIZE);

            pageItems.forEach((user, indexOnPage) => {
                const index = start + indexOnPage;
                const userRoles = (user.rol_ids || []).map(roleId => {
                    const role = allRoles.find(r => r.id === roleId);
                    return role ? `<span class="bg-gray-200 text-gray-700 text-xs font-semibold px-2 py-1 rounded-full">${role.name}</span>` : '';
                }).filter(Boolean).join('');

                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50 align-middle';
                const statusClass = user.is_active ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800';
                const hasPassword = !!user.passwordHash;
                const passwordBadge = hasPassword
                    ? `<span class="ml-2 text-green-600" title="Contrase帽a configurada"></span>`
                    : `<span class="ml-2 text-red-500" title="Sin contrase帽a"></span>`;
                row.innerHTML = `
                    <td class="py-3 px-4 text-center align-middle">
                        <div class="flex items-center justify-center gap-2">
                        <button class="move-up-btn inline-flex w-8 h-8 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 hover:text-gray-900 hover:border-gray-400 disabled:opacity-30" data-index="${index}" ${index === 0 ? 'disabled' : ''} title="Subir posici贸n">
                            <i class="fa-solid fa-chevron-up"></i>
                        </button>
                        <button class="move-down-btn inline-flex w-8 h-8 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 hover:text-gray-900 hover:border-gray-400 disabled:opacity-30" data-index="${index}" ${index === allUsers.length - 1 ? 'disabled' : ''} title="Bajar posici贸n">
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                        </div>
                    </td>
                    <td class="py-3 px-4 text-center align-middle"><span class="inline-flex items-center justify-center">${user.name}${passwordBadge}</span></td>
                    <td class="py-3 px-4"><div class="flex flex-wrap gap-1">${userRoles || 'No asignado'}</div></td>
                    <td class="py-3 px-4 text-center"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${user.is_active ? 'Habilitado' : 'Deshabilitado'}</span></td>
                    <td class="py-3 px-4 text-center">
                        <div class="btn-group no-wrap-actions table-actions">
                            <button class="edit-user-btn bg-gray-600 hover:bg-gray-700 text-white text-sm rounded" data-id="${user.id}">
                                <i class="fa-solid fa-pen-to-square"></i>
                                <span class="btn-text">Editar</span>
                            </button>
                            <button class="reset-pass-btn bg-purple-600 hover:bg-purple-700 text-white text-sm rounded" data-id="${user.id}" title="Poner contrase帽a en null para este usuario">
                                <i class="fa-solid fa-key"></i>
                                <span class="btn-text">Reset Contrase帽a</span>
                            </button>
                            <button class="toggle-user-btn ${user.is_active ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-700 hover:bg-gray-800'} text-white text-sm rounded" data-id="${user.id}">
                                ${user.is_active ? '<i class="fa-solid fa-user-slash"></i><span class="btn-text">Deshabilitar</span>' : '<i class="fa-solid fa-user-check"></i><span class="btn-text">Habilitar</span>'}
                            </button>
                        </div>
                    </td>`;
                userTableBody.appendChild(row);
            });
            // Tambi茅n renderizar tarjetas en vista m贸vil con el mismo subconjunto
            renderUserCards(filtered, start, pageItems);
            // Paginaci贸n
            renderPagination('user-pagination', userPage, totalPages, (newPage) => { userPage = newPage; renderUserTable(); });
            if (filtered.length === 0) {
                userTableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">Sin resultados</td></tr>';
                const cards = document.getElementById('user-cards');
                if (cards) cards.innerHTML = '<div class="text-center text-gray-500">Sin resultados</div>';
            }
        }

        function renderUserCards(filteredAll, start, pageItems) {
            const container = document.getElementById('user-cards');
            if (!container) return;
            container.innerHTML = '';
            const source = Array.isArray(pageItems) ? pageItems : allUsers.slice(0, PAGE_SIZE);
            source.forEach((user, index) => {
                const userRolesBadges = (user.rol_ids || []).map(roleId => {
                    const role = allRoles.find(r => r.id === roleId);
                    return role ? `<span class=\"bg-gray-200 text-gray-700 text-xs font-semibold px-2 py-1 rounded-full\">${role.name}</span>` : '';
                }).filter(Boolean).join('');
                const statusBadge = user.is_active ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-200 text-green-800">Habilitado</span>' : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-200 text-red-800">Deshabilitado</span>';
                const hasPassword = !!user.passwordHash;
                const passwordBadge = hasPassword ? '<span class="ml-2 text-green-600" title="Contrase帽a configurada"></span>' : '<span class="ml-2 text-red-500" title="Sin contrase帽a"></span>';
                const card = document.createElement('div');
                card.className = 'bg-gray-50 border rounded-lg p-4 flex flex-col gap-3';
                card.innerHTML = `
                    <div class="flex items-center justify-between gap-4 flex-col md:flex-row">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-3 flex-wrap">
                                <div class="font-semibold text-gray-800 truncate">${user.name}${passwordBadge}</div>
                                <div>${statusBadge}</div>
                            </div>
                            <div class="mt-2 flex flex-wrap gap-1">${userRolesBadges || '<span class=\"text-gray-500\">No asignado</span>'}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="move-up-btn inline-flex w-8 h-8 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 hover:text-gray-900 hover:border-gray-400 disabled:opacity-30" data-index="${(start||0)+index}" ${((start||0)+index) === 0 ? 'disabled' : ''} title="Subir posici贸n">
                                <i class="fa-solid fa-chevron-up"></i>
                            </button>
                            <button class="move-down-btn inline-flex w-8 h-8 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 hover:text-gray-900 hover:border-gray-400 disabled:opacity-30" data-index="${(start||0)+index}" ${((start||0)+index) === allUsers.length - 1 ? 'disabled' : ''} title="Bajar posici贸n">
                                <i class="fa-solid fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    <div class="btn-group justify-center md:justify-end">
                        <button class="edit-user-btn bg-gray-600 hover:bg-gray-700 text-white text-sm rounded" data-id="${user.id}">
                            <i class="fa-solid fa-pen-to-square"></i>
                            <span class="btn-text">Editar</span>
                        </button>
                        <button class="reset-pass-btn bg-purple-600 hover:bg-purple-700 text-white text-sm rounded" data-id="${user.id}" title="Poner contrase帽a en null para este usuario">
                            <i class="fa-solid fa-key"></i>
                            <span class="btn-text">Reset</span>
                        </button>
                        <button class="toggle-user-btn ${user.is_active ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-700 hover:bg-gray-800'} text-white text-sm rounded" data-id="${user.id}">
                            ${user.is_active ? '<i class="fa-solid fa-user-slash"></i><span class="btn-text">Deshabilitar</span>' : '<i class="fa-solid fa-user-check"></i><span class="btn-text">Habilitar</span>'}
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
            // Delegar eventos una sola vez
            if (!container.dataset.listenerAttached) {
                container.addEventListener('click', handleUserTableClick);
                container.dataset.listenerAttached = 'true';
            }
        }

        function renderRoleTable() {
            roleTableBody.innerHTML = '';
            const filtered = allRoles.filter(r => !roleFilter || (r.name || '').toLowerCase().includes(roleFilter));
            const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
            if (rolePage > totalPages) rolePage = totalPages;
            const start = (rolePage - 1) * PAGE_SIZE;
            const pageItems = filtered.slice(start, start + PAGE_SIZE);

            pageItems.forEach(role => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">${role.name}</td>
                    <td class="py-3 px-4 text-center">
                        <div class="btn-group no-wrap-actions table-actions">
                            <button class="assign-perm-btn bg-gray-700 hover:bg-gray-800 text-white text-sm rounded" data-id="${role.id}" data-name="${role.name}">
                                <i class="fa-solid fa-shield-halved"></i>
                                <span class="btn-text">Permisos</span>
                            </button>
                            <button class="edit-role-btn bg-gray-600 hover:bg-gray-700 text-white text-sm rounded" data-id="${role.id}">
                                <i class="fa-solid fa-pen-to-square"></i>
                                <span class="btn-text">Editar</span>
                            </button>
                            <button class="delete-role-btn bg-red-600 hover:bg-red-700 text-white text-sm rounded" data-id="${role.id}" data-name="${role.name}">
                                <i class="fa-solid fa-trash"></i>
                                <span class="btn-text">Eliminar</span>
                            </button>
                        </div>
                    </td>`;
                roleTableBody.appendChild(row);
            });
            renderPagination('role-pagination', rolePage, totalPages, (newPage) => { rolePage = newPage; renderRoleTable(); });
            if (filtered.length === 0) {
                roleTableBody.innerHTML = '<tr><td colspan="2" class="py-4 text-center text-gray-500">Sin resultados</td></tr>';
            }
        }

          function renderPermissionTable() {
                 permissionTableBody.innerHTML = '';
                 const filtered = allPermissions.filter(p => {
                     if (!permFilter) return true;
                     const k = (p.key || '').toLowerCase();
                     const d = (p.description || '').toLowerCase();
                     const m = (p.module || '').toLowerCase();
                     return k.includes(permFilter) || d.includes(permFilter) || m.includes(permFilter);
                 });
                 const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
                 if (permPage > totalPages) permPage = totalPages;
                 const start = (permPage - 1) * PAGE_SIZE;
                 const pageItems = filtered.slice(start, start + PAGE_SIZE);

                 pageItems.forEach(perm => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 font-mono text-sm">${perm.key}</td>
                    <td class="py-3 px-4">${perm.description}</td>
                    <td class="py-3 px-4">${perm.module}</td>
                    <td class="py-3 px-4 text-center">
                        <div class="btn-group no-wrap-actions table-actions">
                            <button class="edit-perm-btn bg-gray-600 hover:bg-gray-700 text-white text-sm rounded" data-id="${perm.id}">
                                <i class="fa-solid fa-pen-to-square"></i>
                                <span class="btn-text">Editar</span>
                            </button>
                            <button class="delete-perm-btn bg-red-600 hover:bg-red-700 text-white text-sm rounded" data-id="${perm.id}" data-name="${perm.key}">
                                <i class="fa-solid fa-trash"></i>
                                <span class="btn-text">Eliminar</span>
                            </button>
                        </div>
                    </td>`;
                permissionTableBody.appendChild(row);
            });
            renderPermissionCards(pageItems);
            renderPagination('permission-pagination', permPage, totalPages, (newPage) => { permPage = newPage; renderPermissionTable(); });
            if (filtered.length === 0) {
                permissionTableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Sin resultados</td></tr>';
                const pcards = document.getElementById('permission-cards');
                if (pcards) pcards.innerHTML = '<div class="text-center text-gray-500">Sin resultados</div>';
            }
        }

        function renderPermissionCards(pageItems) {
            const container = document.getElementById('permission-cards');
            if (!container) return;
            container.innerHTML = '';
            const source = Array.isArray(pageItems) ? pageItems : allPermissions.slice(0, PAGE_SIZE);
            source.forEach(perm => {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 border rounded-lg p-4 flex flex-col gap-3';
                card.innerHTML = `
                    <div class="font-mono text-sm text-gray-800">${perm.key}</div>
                    <div class="text-gray-700">${perm.description}</div>
                    <div><span class="text-xs font-medium px-2 py-0.5 rounded bg-purple-100 text-purple-800">${perm.module}</span></div>
                    <div class="btn-group justify-center md:justify-end">
                        <button class="edit-perm-btn bg-gray-600 hover:bg-gray-700 text-white text-sm rounded" data-id="${perm.id}">
                            <i class="fa-solid fa-pen-to-square"></i>
                            <span class="btn-text">Editar</span>
                        </button>
                        <button class="delete-perm-btn bg-red-600 hover:bg-red-700 text-white text-sm rounded" data-id="${perm.id}" data-name="${perm.key}">
                            <i class="fa-solid fa-trash"></i>
                            <span class="btn-text">Eliminar</span>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
            if (!container.dataset.listenerAttached) {
                container.addEventListener('click', handlePermissionTableClick);
                container.dataset.listenerAttached = 'true';
            }
        }

        function renderPagination(containerId, current, total, onChange) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            const prev = document.createElement('button');
            prev.className = 'bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded disabled:opacity-40';
            prev.disabled = current <= 1;
            prev.innerHTML = '<i class="fa-solid fa-chevron-left"></i> <span class="btn-text">Anterior</span>';
            prev.addEventListener('click', () => onChange(Math.max(1, current - 1)));
            const next = document.createElement('button');
            next.className = 'bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded disabled:opacity-40';
            next.disabled = current >= total;
            next.innerHTML = '<span class="btn-text">Siguiente</span> <i class="fa-solid fa-chevron-right"></i>';
            next.addEventListener('click', () => onChange(Math.min(total, current + 1)));
            const label = document.createElement('span');
            label.className = 'text-sm text-gray-600 select-none';
            label.textContent = `P谩gina ${current} de ${total}`;
            container.appendChild(prev);
            container.appendChild(label);
            container.appendChild(next);
        }

        // --- SETUP FUNCTIONS ---
        function setupEventListeners() {
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
            createUserBtn.addEventListener('click', () => openUserModal('create'));
            resetPasswordsBtn.addEventListener('click', async () => {
                if (!confirm('Esto eliminar谩 la contrase帽a (passwordHash) de TODOS los usuarios. 驴Desea continuar?')) return;
                try {
                    const snap = await employeesCol.get();
                    const batch = db.batch();
                    snap.forEach(doc => batch.update(doc.ref, { passwordHash: null }));
                    await batch.commit();
                    alert('Contrase帽as reseteadas. Cada usuario deber谩 establecer una nueva en el primer inicio.');
                } catch (e) {
                    console.error('Error reseteando contrase帽as:', e);
                    alert('No se pudo resetear las contrase帽as. Revise la consola.');
                }
            });
            userTableBody.addEventListener('click', handleUserTableClick);
            document.getElementById('user-form').addEventListener('submit', handleUserFormSubmit);
            createRoleBtn.addEventListener('click', () => openRoleModal('create'));
            roleTableBody.addEventListener('click', handleRoleTableClick);
            document.getElementById('role-form').addEventListener('submit', handleRoleFormSubmit);
            createPermissionBtn.addEventListener('click', () => openPermissionModal('create'));
            permissionTableBody.addEventListener('click', handlePermissionTableClick);
            document.getElementById('permission-form').addEventListener('submit', handlePermissionFormSubmit);
            assignPermissionModal.querySelector('#cancel-assign-btn').addEventListener('click', closeAssignPermissionModal);
            assignPermissionModal.querySelector('#save-assign-btn').addEventListener('click', handleSaveRolePermissions);

            // Buscadores
            const userSearch = document.getElementById('user-search-input');
            if (userSearch) userSearch.addEventListener('input', (e) => { userFilter = (e.target.value || '').toLowerCase(); userPage = 1; renderUserTable(); });
            const roleSearch = document.getElementById('role-search-input');
            if (roleSearch) roleSearch.addEventListener('input', (e) => { roleFilter = (e.target.value || '').toLowerCase(); rolePage = 1; renderRoleTable(); });
            const permSearch = document.getElementById('perm-search-input');
            if (permSearch) permSearch.addEventListener('input', (e) => { permFilter = (e.target.value || '').toLowerCase(); permPage = 1; renderPermissionTable(); });
        }

        function setupModalTemplates() {
            document.getElementById('user-form').innerHTML = `
                <input type="hidden" id="user-id-input">
                <div class="mb-4">
                    <label for="username-input" class="block text-sm font-bold mb-2">Nombre de Usuario:</label>
                    <input type="text" id="username-input" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2">Roles:</label>
                    <div id="roles-checkbox-container" class="grid grid-cols-2 gap-2 border rounded p-2 max-h-32 overflow-y-auto"></div>
                </div>
                <div class="mb-4">
                    <label for="password-modal-input" class="block text-sm font-bold mb-2">Contrase帽a:</label>
                    <div class="password-container">
                        <input type="password" id="password-modal-input" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline pr-10" placeholder="Dejar en blanco para no cambiar">
                        <span class="password-toggle text-gray-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></span>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="confirm-password-input" class="block text-sm font-bold mb-2">Confirmar Contrase帽a:</label>
                     <div class="password-container">
                        <input type="password" id="confirm-password-input" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline pr-10" placeholder="Repetir contrase帽a">
                        <span class="password-toggle text-gray-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></span>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="flex items-center"><input type="checkbox" id="enabled-checkbox" class="form-checkbox h-5 w-5 text-purple-600"><span class="ml-2 text-sm">Usuario Habilitado</span></label>
                </div>
                <div id="modal-error-message" class="text-red-500 text-sm mb-1 h-4 text-center"></div>
                <div id="modal-success-message" class="text-green-600 text-sm mb-4 h-4 text-center"></div>
                <div class="btn-row modal-actions justify-end gap-3">
                    <button type="button" class="cancel-modal-btn bg-gray-500 hover:bg-gray-600 text-white">
                        <i class="fa-solid fa-xmark"></i>
                        <span class="btn-text">Cancelar</span>
                    </button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white">
                        <i class="fa-solid fa-floppy-disk"></i>
                        <span class="btn-text">Guardar Cambios</span>
                    </button>
                </div>`;

            document.getElementById('role-form').innerHTML = `
                <input type="hidden" id="role-id-input">
                <div class="mb-6">
                    <label for="role-name-input" class="block text-sm font-bold mb-2">Nombre del Rol:</label>
                    <input type="text" id="role-name-input" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div id="role-modal-error" class="text-red-500 text-sm mb-4 h-4 text-center"></div>
                <div class="btn-row modal-actions justify-end gap-3">
                    <button type="button" class="cancel-modal-btn bg-gray-500 hover:bg-gray-600 text-white">
                        <i class="fa-solid fa-xmark"></i>
                        <span class="btn-text">Cancelar</span>
                    </button>
                    <button type="submit" class="bg-purple-500 hover:bg-purple-700 text-white">
                        <i class="fa-solid fa-floppy-disk"></i>
                        <span class="btn-text">Guardar Rol</span>
                    </button>
                </div>`;
            
            document.getElementById('permission-form').innerHTML = `
                 <input type="hidden" id="permission-id-input">
                <div class="mb-4">
                    <label for="permission-key-input" class="block text-sm font-bold mb-2">Funci贸n (Clave nica):</label>
                    <input type="text" id="permission-key-input" placeholder="ej: crear_usuario" class="font-mono shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-4">
                     <label for="permission-desc-input" class="block text-sm font-bold mb-2">Descripci贸n:</label>
                    <input type="text" id="permission-desc-input" placeholder="ej: Permite crear un nuevo usuario" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-6">
                     <label for="permission-module-input" class="block text-sm font-bold mb-2">M贸dulo:</label>
                    <input type="text" id="permission-module-input" placeholder="ej: Administraci贸n" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div id="permission-modal-error" class="text-red-500 text-sm mb-4 h-4 text-center"></div>
                <div class="btn-row modal-actions justify-end gap-3">
                    <button type="button" class="cancel-modal-btn bg-gray-500 hover:bg-gray-600 text-white">
                        <i class="fa-solid fa-xmark"></i>
                        <span class="btn-text">Cancelar</span>
                    </button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white">
                        <i class="fa-solid fa-floppy-disk"></i>
                        <span class="btn-text">Guardar Funci贸n</span>
                    </button>
                </div>`;
            
            document.querySelectorAll('.cancel-modal-btn').forEach(btn => btn.addEventListener('click', () => {
                userModal.classList.add('hidden');
                roleModal.classList.add('hidden');
                permissionModal.classList.add('hidden');
            }));
            document.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    const inputContainer = e.currentTarget.closest('.password-container');
                    const input = inputContainer.querySelector('input');
                    const isPassword = input.type === 'password';
                    input.type = isPassword ? 'text' : 'password';
                });
            });
        }
        
        // --- EVENT HANDLERS ---
        function handleLogin(e) {
            e.preventDefault();
            const user = allUsers.find(u => u.id === userSelect.value);
            if (!user) { loginMessage.textContent = 'Usuario no encontrado.'; return; }
            if (!user.is_active) { loginMessage.textContent = 'Este usuario est谩 deshabilitado.'; return; }
            
            const entered = (passwordInput.value || '').trim();
            let isAuthenticated = false;
            const stored = user.passwordHash;
            if (!stored || typeof stored !== 'string' || !stored.startsWith('pbkdf2$')) {
                loginMessage.textContent = 'Este usuario no tiene contrase帽a v谩lida. Ed铆telo y establezca una.';
                return;
            }
            if (entered) {
                // Verificar PBKDF2
                pbkdf2Verify(entered, stored).then(ok => {
                    if (ok) {
                        currentUser = user; 
                        loginMessage.textContent = ''; 
                        passwordInput.value = '';
                        loginSection.classList.add('hidden');
                        adminSection.classList.remove('hidden');
                        welcomeMessage.textContent = `Bienvenido/a, ${user.name}.`;
                        renderUserTable();
                        renderRoleTable();
                        renderPermissionTable();
                    } else {
                        loginMessage.textContent = 'Contrase帽a incorrecta.';
                    }
                }).catch(() => {
                    loginMessage.textContent = 'Error validando contrase帽a.';
                });
                return;
            } else {
                loginMessage.textContent = 'Ingrese su contrase帽a.';
                return;
            }

            if (isAuthenticated) {
                currentUser = user; 
                loginMessage.textContent = ''; 
                passwordInput.value = '';
                loginSection.classList.add('hidden');
                adminSection.classList.remove('hidden');
                welcomeMessage.textContent = `Bienvenido/a, ${user.name}.`;
                renderUserTable();
                renderRoleTable();
                renderPermissionTable();
            } else { 
                loginMessage.textContent = 'Contrase帽a incorrecta.'; 
            }
        }
        function handleLogout() {
            currentUser = null;
            adminSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
        }

        async function handleUserTableClick(e) {
            const target = e.target.closest('button');
            if (!target) return;
            const userId = target.dataset.id;
            const userIndex = parseInt(target.dataset.index, 10);

            if (target.classList.contains('edit-user-btn')) openUserModal('edit', userId);
            if (target.classList.contains('reset-pass-btn')) {
                const user = allUsers.find(u => u.id === userId);
                if (!user) return;
                if (!confirm(`驴Resetear contrase帽a de "${user.name}"?`)) return;
                try {
                    await employeesCol.doc(user.id).update({ passwordHash: null });
                    alert('Contrase帽a reseteada. Al iniciar sesi贸n, se pedir谩 establecer una nueva.');
                } catch (e) {
                    console.error('Error reseteando contrase帽a del usuario:', e);
                    alert('No se pudo resetear la contrase帽a. Revise la consola.');
                }
                return;
            }
            if (target.classList.contains('toggle-user-btn')) {
                const user = allUsers.find(u => u.id === userId);
                if (user.name === 'Juan Lai') {
                    alert('No se puede deshabilitar al superusuario.');
                    return;
                }
                await employeesCol.doc(userId).update({ is_active: !user.is_active });
            }
            if (target.classList.contains('move-up-btn') || target.classList.contains('move-down-btn')) {
                const swapIndex = target.classList.contains('move-up-btn') ? userIndex - 1 : userIndex + 1;
                const userA = allUsers[userIndex];
                const userB = allUsers[swapIndex];
                const batch = db.batch();
                batch.update(employeesCol.doc(userA.id), { order: userB.order });
                batch.update(employeesCol.doc(userB.id), { order: userA.order });
                await batch.commit();
            }
        }

        async function handleRoleTableClick(e) {
            const target = e.target.closest('button');
            if (!target) return;
            const roleId = target.dataset.id;
            const roleName = target.dataset.name;

            if (target.classList.contains('edit-role-btn')) openRoleModal('edit', roleId);
            if (target.classList.contains('assign-perm-btn')) openAssignPermissionModal(roleId, roleName);
            if (target.classList.contains('delete-role-btn')) {
                 if (roleName === 'Administrador') {
                    alert('No se puede eliminar el rol de Administrador.');
                    return;
                }
                const usersWithRole = allUsers.filter(u => (u.rol_ids || []).includes(roleId));
                if (usersWithRole.length > 0) {
                    alert(`No se puede eliminar el rol "${roleName}" porque est谩 asignado a ${usersWithRole.length} usuario(s).`);
                    return;
                }
                if (confirm(`驴Est谩 seguro de que desea eliminar el rol "${roleName}"?`)) {
                    await rolesCol.doc(roleId).delete();
                }
            }
        }
        
        async function handlePermissionTableClick(e) {
            const target = e.target.closest('button');
            if (!target) return;
            const permId = target.dataset.id;
            const permName = target.dataset.name;
            if (target.classList.contains('edit-perm-btn')) openPermissionModal('edit', permId);
            if (target.classList.contains('delete-perm-btn')) {
                if (confirm(`驴Est谩 seguro de que desea eliminar el permiso "${permName}"? Esto lo remover谩 de todos los roles.`)) {
                    await permissionsCol.doc(permId).delete();
                    const batch = db.batch();
                    const snapshot = await rolePermissionsCol.where('permission_id', '==', permId).get();
                    snapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                }
            }
        }

        // --- MODAL & FORM LOGIC ---
        function openUserModal(mode, userId = null) {
            const form = document.getElementById('user-form');
            form.reset();
            document.getElementById('modal-error-message').textContent = '';
            const successMsg = document.getElementById('modal-success-message');
            if (successMsg) successMsg.textContent = '';
            const modalTitle = document.getElementById('user-modal-title');
            const idInput = document.getElementById('user-id-input');
            const rolesContainer = document.getElementById('roles-checkbox-container');
            
            rolesContainer.innerHTML = allRoles.map(role => `
                <label class="flex items-center space-x-2 p-1 rounded hover:bg-gray-100">
                    <input type="checkbox" value="${role.id}" class="form-checkbox h-4 w-4 text-purple-600">
                    <span class="text-sm">${role.name}</span>
                </label>
            `).join('');

            if (mode === 'create') {
                modalTitle.textContent = 'Crear Nuevo Usuario';
                idInput.value = '';
                document.getElementById('enabled-checkbox').checked = true;
            } else {
                modalTitle.textContent = 'Editar Usuario';
                const user = allUsers.find(u => u.id === userId);
                idInput.value = user.id;
                document.getElementById('username-input').value = user.name;
                document.getElementById('enabled-checkbox').checked = user.is_active;
                (user.rol_ids || []).forEach(roleId => {
                    const checkbox = rolesContainer.querySelector(`input[value="${roleId}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            userModal.classList.remove('hidden');
        }

        function openRoleModal(mode, roleId = null) {
            const form = document.getElementById('role-form');
            form.reset();
            document.getElementById('role-modal-error').textContent = '';
            const modalTitle = document.getElementById('role-modal-title');
            const idInput = document.getElementById('role-id-input');
            const nameInput = document.getElementById('role-name-input');
            if (mode === 'create') {
                modalTitle.textContent = 'Crear Nuevo Rol';
                idInput.value = '';
            } else {
                modalTitle.textContent = 'Editar Rol';
                const role = allRoles.find(r => r.id === roleId);
                idInput.value = role.id;
                nameInput.value = role.name;
            }
            roleModal.classList.remove('hidden');
        }

        function openPermissionModal(mode, permId = null) {
            const form = document.getElementById('permission-form');
            form.reset();
            document.getElementById('permission-modal-error').textContent = '';
            const modalTitle = document.getElementById('permission-modal-title');
            const idInput = document.getElementById('permission-id-input');
            if (mode === 'create') {
                modalTitle.textContent = 'Crear Nueva Funci贸n';
                idInput.value = '';
            } else {
                modalTitle.textContent = 'Editar Funci贸n';
                const perm = allPermissions.find(p => p.id === permId);
                idInput.value = perm.id;
                document.getElementById('permission-key-input').value = perm.key;
                document.getElementById('permission-desc-input').value = perm.description;
                document.getElementById('permission-module-input').value = perm.module;
            }
            permissionModal.classList.remove('hidden');
        }
        
        function openAssignPermissionModal(roleId, roleName) {
            currentRoleIdForPermissions = roleId;
            document.getElementById('assign-permission-modal-title').textContent = `Permisos para: ${roleName}`;
            const container = document.getElementById('permissions-container');
            
            const permissionsByModule = allPermissions.reduce((acc, perm) => {
                if (!acc[perm.module]) acc[perm.module] = [];
                acc[perm.module].push(perm);
                return acc;
            }, {});

            container.innerHTML = Object.entries(permissionsByModule).map(([module, perms]) => `
                <div class="permission-group">
                    <h3 class="permission-group-title">${module}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        ${perms.map(p => `
                            <label class="flex items-center space-x-2 p-2 rounded hover:bg-gray-100">
                                <input type="checkbox" value="${p.id}" class="form-checkbox h-5 w-5 text-purple-600 permission-checkbox">
                                <span>${p.description}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            const assignedPerms = rolePermissionsMap[roleId] || [];
            container.querySelectorAll('.permission-checkbox').forEach(cb => {
                if (assignedPerms.includes(cb.value)) {
                    cb.checked = true;
                }
            });
            assignPermissionModal.classList.remove('hidden');
        }
        
        function closeAssignPermissionModal() {
            assignPermissionModal.classList.add('hidden');
            currentRoleIdForPermissions = null;
        }

        async function handleUserFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('user-id-input').value;
            const name = document.getElementById('username-input').value.trim();
            const password = (document.getElementById('password-modal-input').value || '').trim();
            const confirmPassword = (document.getElementById('confirm-password-input').value || '').trim();
            const rol_ids = Array.from(document.querySelectorAll('#roles-checkbox-container input:checked')).map(cb => cb.value);
            const is_active = document.getElementById('enabled-checkbox').checked;
            const errorMsg = document.getElementById('modal-error-message');
            const successMsg = document.getElementById('modal-success-message');

            // Limpiar mensajes previos
            if (errorMsg) errorMsg.textContent = '';
            if (successMsg) successMsg.textContent = '';

            // Si intenta cambiar la contrase帽a, ambos campos deben llenarse
            const oneFilled = (!!password && !confirmPassword) || (!password && !!confirmPassword);
            if (oneFilled) {
                errorMsg.textContent = 'Debe llenar ambos campos de contrase帽a.';
                return;
            }

            if (password !== confirmPassword) {
                errorMsg.textContent = 'Las contrase帽as no coinciden.';
                return;
            }
            // Permitir crear usuario sin contrase帽a: si ambos est谩n vac铆os y es nuevo, se acepta.
            
            const data = { name, rol_ids, is_active };
            if (password) {
                // Generar hash real PBKDF2
                data.passwordHash = await pbkdf2Hash(password);
            }
            if (!id) data.order = Date.now();

            try {
                if (id) {
                    await employeesCol.doc(id).update(data);
                    if (password && successMsg) {
                        // Mostrar etiqueta de 茅xito si se cambi贸 la contrase帽a
                        successMsg.textContent = 'Contrase帽a cambiada satisfactoriamente.';
                        // Limpiar campos de contrase帽a luego del cambio
                        document.getElementById('password-modal-input').value = '';
                        document.getElementById('confirm-password-input').value = '';
                    } else {
                        userModal.classList.add('hidden');
                    }
                } else {
                    await employeesCol.add(data);
                    userModal.classList.add('hidden');
                }
            } catch(err) {
                console.error("Error guardando usuario: ", err);
                errorMsg.textContent = 'Error al guardar. Verifique la consola.';
            }
        }
        async function handleRoleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('role-id-input').value;
            const name = document.getElementById('role-name-input').value.trim();
            const errorMsg = document.getElementById('role-modal-error');
            if (!name) { errorMsg.textContent = 'El nombre es obligatorio.'; return; }

            try {
                if (id) await rolesCol.doc(id).update({ name });
                else await rolesCol.add({ name });
                roleModal.classList.add('hidden');
            } catch(err) {
                console.error("Error guardando rol: ", err);
                errorMsg.textContent = 'Error al guardar. Verifique la consola.';
            }
        }
        async function handlePermissionFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('permission-id-input').value;
            const key = document.getElementById('permission-key-input').value.trim();
            const description = document.getElementById('permission-desc-input').value.trim();
            const module = document.getElementById('permission-module-input').value.trim();
            const errorMsg = document.getElementById('permission-modal-error');
            if (!key || !description || !module) { errorMsg.textContent = 'Todos los campos son obligatorios.'; return; }
            
            const data = { key, description, module };
             try {
                if (id) await permissionsCol.doc(id).update(data);
                else await permissionsCol.add(data);
                permissionModal.classList.add('hidden');
            } catch(err) {
                console.error("Error guardando permiso: ", err);
                errorMsg.textContent = 'Error al guardar. Verifique la consola.';
            }
        }
        async function handleSaveRolePermissions() {
            if (!currentRoleIdForPermissions) return;
            const selectedPerms = Array.from(document.querySelectorAll('#permissions-container .permission-checkbox:checked')).map(cb => cb.value);
            const existingPerms = rolePermissionsMap[currentRoleIdForPermissions] || [];
            
            const permsToAdd = selectedPerms.filter(p => !existingPerms.includes(p));
            const permsToRemove = existingPerms.filter(p => !selectedPerms.includes(p));

            try {
                const batch = db.batch();
                // Add new permissions
                permsToAdd.forEach(permission_id => {
                    const ref = rolePermissionsCol.doc(); // Auto-generate ID
                    batch.set(ref, { rol_id: currentRoleIdForPermissions, permission_id });
                });
                // Remove old permissions
                if (permsToRemove.length > 0) {
                    const snapshot = await rolePermissionsCol.where('rol_id', '==', currentRoleIdForPermissions).where('permission_id', 'in', permsToRemove).get();
                    snapshot.forEach(doc => batch.delete(doc.ref));
                }
                await batch.commit();
                closeAssignPermissionModal();
            } catch(err) {
                console.error("Error guardando permisos del rol:", err);
            }
        }
    </script>
</body>
</html>

