<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión Integral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
    body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .view { display: none; }
        .view.active { display: block; }
        .nav-link {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
            border: 2px solid transparent;
        }
        .nav-link:hover {
            background-color: #e0f2f1;
            color: #00796b;
        }
        .nav-link.active {
            background-color: #00796b;
            color: white;
            font-weight: 600;
        }
        .modal-bg { background-color: rgba(0,0,0,0.6); }
        .kpi-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .password-container { position: relative; }
        .password-toggle { position: absolute; top: 50%; right: 0.75rem; transform: translateY(-50%); cursor: pointer; }
        .chart-range-btn {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
            font-weight: 600; /* font-semibold */
            padding: 0.25rem 0.75rem; /* py-1 px-3 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
        }
        .chart-range-btn.active {
            background-color: #0d9488; /* bg-cyan-600 */
            color: white;
        }

        /* Estilos de item_version_1.1.html (Corregidos) */
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: #ffffff; }
        .accordion-header.active { background-color: #eff6ff; }
        .accordion-header .chevron-icon { transition: transform 0.2s ease-out; }
        .accordion-header.active .chevron-icon { transform: rotate(180deg); }
        /* Fix: los dropdowns de categoría y DVD siempre abren hacia abajo */
        .dropdown-menu {
            position: absolute;
            left: 0;
            right: 0;
            z-index: 50;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            margin-top: 0.25rem;
            max-height: 16rem;
            overflow-y: auto;
            top: 100%; /* Fuerza abrir hacia abajo */
        }
        .sortable-ghost { opacity: 0.4; background: #cce7ff; border: 2px dashed #4a90e2; }
        .image-preview-item { position: relative; border: 2px solid transparent; border-radius: 0.5rem; overflow: hidden; cursor: pointer; }
        .image-preview-item img { width: 100%; height: 100px; object-fit: cover; }
        .image-preview-item .action-buttons { position: absolute; top: 0.5rem; right: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .image-preview-item:hover .action-buttons { opacity: 1; }
        .image-preview-item .action-btn { background-color: rgba(0, 0, 0, 0.6); color: white; border-radius: 9999px; width: 1.75rem; height: 1.75rem; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; }
        .image-preview-item .action-btn:hover { background-color: rgba(0, 0, 0, 0.8); }
        .image-preview-item .delete-btn:hover { background-color: #ef4444; }
        .image-preview-item.archived > img { opacity: 0.3; }
        .image-preview-item.archived .action-buttons { display: none; }
        .archive-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.7); display: none; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; }
        .image-preview-item.archived .archive-overlay { display: flex; }
        .conditional-content { display: none; }
        .conditional-content.visible { display: block; }
        .form-input.invalid-obligatorio { border-color: #ef4444; box-shadow: 0 0 0 2px #fecaca; }
        .form-input.invalid-necesario { border-color: #f97316; box-shadow: 0 0 0 2px #fed7aa; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); width: 90%; max-width: 500px; }
        .toast-notification { position: fixed; bottom: 1.25rem; right: 1.25rem; background-color: #22c55e; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transition: opacity 0.3s ease; z-index: 100; }
        /* Estándar de botones responsivos */
        .btn-row { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        @media (max-width: 640px){
            .btn-text { display: none; }
            .btn-icon { margin-right: 0 !important; }
        }
        /* Ocultar texto de tabs para evitar recorte y scroll horizontal en anchos medianos */
        @media (max-width: 1024px){
            #main-nav .tab-text { display: none; }
        }
    </style>
    <!-- Librerías para descarga ZIP de adjuntos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body class="bg-gray-100">

    <!-- =========== OVERLAYS Y ELEMENTOS GLOBALES =========== -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-white bg-opacity-80">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-cyan-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="mt-2 text-gray-600 font-medium">Cargando...</p>
        </div>
    </div>

    <!-- =========== SECCIÓN DE LOGIN =========== -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="bg-white shadow-xl rounded-2xl px-8 pt-6 pb-8">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Sistema de Gestión</h1>
                <p class="text-center text-gray-500 mb-6">Por favor, inicie sesión para continuar</p>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="user-select" class="block text-gray-700 text-sm font-bold mb-2">Usuario:</label>
                        <select id="user-select" class="shadow border rounded-lg w-full py-3 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option>Cargando...</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contraseña:</label>
                        <input id="password" type="password" placeholder="******************" class="shadow appearance-none border rounded-lg w-full py-3 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    </div>
                    <div class="flex items-center justify-between">
                        <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition flex items-center justify-center">
                            <i class="fa fa-right-to-bracket btn-icon mr-2"></i>
                            <span class="btn-text">Acceder</span>
                        </button>
                    </div>
                    <div id="login-message" class="text-center text-red-500 text-sm mt-4 h-4"></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- =========== APLICACIÓN PRINCIPAL (POST-LOGIN) =========== -->
    <div id="app-shell" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between py-2 md:py-3">
                    <div class="flex items-center space-x-4">
                        <svg class="h-8 w-8 text-cyan-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3M5.636 5.636l-1.414-1.414M19.778 19.778l-1.414-1.414M18.364 5.636l-1.414 1.414M4.222 19.778l-1.414 1.414M12 12a6 6 0 100-12 6 6 0 000 12z"/></svg>
                        <span class="text-xl font-bold text-gray-700">Gestor</span>
                        <!-- Botón menú móvil -->
                        <button id="mobile-menu-button" class="md:hidden ml-2 p-2 rounded hover:bg-gray-100" aria-label="Abrir menú">
                            <i class="fa fa-bars text-xl"></i>
                        </button>
                        <nav id="main-nav" class="hidden md:flex flex-wrap items-center gap-2 pl-4 border-l ml-4 min-w-0"></nav>
                    </div>
                    <div class="flex items-center">
                        <div id="welcome-message" class="text-right mr-4"></div>
                        <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition flex items-center">
                            <i class="fa fa-right-from-bracket btn-icon mr-2"></i>
                            <span class="btn-text">Cerrar Sesión</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Menú móvil desplegable -->
        <div id="mobile-menu" class="md:hidden hidden">
            <div class="absolute top-16 left-0 right-0 bg-white shadow-lg border-t z-40">
                <nav id="mobile-menu-list" class="flex flex-col p-2"></nav>
            </div>
        </div>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="view-dashboard" class="view"></div>
            <div id="view-technician" class="view"></div>
            <div id="view-clients" class="view"></div>
            <div id="view-bonus-report" class="view"></div>
            <div id="view-task-admin" class="view"></div>
            <div id="view-rbac-admin" class="view"></div>
            <div id="view-items" class="view"></div>
        </main>
    </div>

    <div id="modals-container"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC4ksfNjhE_31i-BnmV6lOZg2fMq201p0A",
            authDomain: "sistema-productividad-equipo.firebaseapp.com",
            projectId: "sistema-productividad-equipo",
            storageBucket: "sistema-productividad-equipo.appspot.com",
            messagingSenderId: "196802708765",
            appId: "1:196802708765:web:af4265d7ac7f50b6fecdf4",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    const storage = firebase.storage();

        let authInitializationPromise = null;

        const employeesCol = db.collection('employees');
        const rolesCol = db.collection('roles');
        const permissionsCol = db.collection('permissions');
        const rolePermissionsCol = db.collection('role_permissions');

        // ===== Utilidades de seguridad: PBKDF2 (hash de contraseñas) =====
        const PBKDF2_ITERATIONS = 100000;
        const PBKDF2_HASH = 'SHA-256';
        function strToBytes(str) { return new TextEncoder().encode(str); }
        function bytesToBase64(bytes) {
            let bin = '';
            bytes = new Uint8Array(bytes);
            for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
            return btoa(bin);
        }
        function base64ToBytes(b64) {
            const bin = atob(b64);
            const out = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);
            return out;
        }
        async function pbkdf2Hash(password, saltB64) {
            const salt = saltB64 ? base64ToBytes(saltB64) : crypto.getRandomValues(new Uint8Array(16));
            const keyMaterial = await crypto.subtle.importKey('raw', strToBytes(password), { name: 'PBKDF2' }, false, ['deriveBits']);
            const derivedBits = await crypto.subtle.deriveBits({ name: 'PBKDF2', salt, iterations: PBKDF2_ITERATIONS, hash: PBKDF2_HASH }, keyMaterial, 256);
            const hashB64 = bytesToBase64(new Uint8Array(derivedBits));
            const saltB64Out = bytesToBase64(salt);
            return `pbkdf2$${PBKDF2_ITERATIONS}$${saltB64Out}$${hashB64}`;
        }
        async function pbkdf2Verify(password, stored) {
            try {
                if (!stored || typeof stored !== 'string' || !stored.startsWith('pbkdf2$')) return false;
                const parts = stored.split('$');
                const iterations = parseInt(parts[1], 10);
                const saltB64 = parts[2];
                const expectedHashB64 = parts[3];
                // usar las mismas iteraciones para verificar, por si cambian en futuro
                const salt = base64ToBytes(saltB64);
                const keyMaterial = await crypto.subtle.importKey('raw', strToBytes(password), { name: 'PBKDF2' }, false, ['deriveBits']);
                const derivedBits = await crypto.subtle.deriveBits({ name: 'PBKDF2', salt, iterations: iterations || PBKDF2_ITERATIONS, hash: PBKDF2_HASH }, keyMaterial, 256);
                const hashB64 = bytesToBase64(new Uint8Array(derivedBits));
                return hashB64 === expectedHashB64;
            } catch (e) {
                console.warn('Error verificando PBKDF2:', e);
                return false;
            }
        }
    const processesCol = db.collection('processes');
    const subprocessesCol = db.collection('subprocesses');
    const activityLogsCol = db.collection('activity_logs');
    const partRequestsCol = db.collection('part_requests');
    const helpRequestsCol = db.collection('help_requests');
    const configCol = db.collection('config');
    const clientsCol = db.collection('clients');
    const itemsCol = db.collection('items');
    const taxesCol = db.collection('taxes');
    const imageTitlePresetsCol = db.collection('image_title_presets');
    const presenceCol = db.collection('presence');
    const incompleteItemsCol = db.collection('incomplete_items');
    const itemDraftsCol = db.collection('item_drafts');
    // Inventario: taxonomía
    const invAttrCol = db.collection('inventory_attributes');
    const invCatCol = db.collection('inventory_categories');
    // Plantillas de servicios (SLAs y Checklists)
    const serviceSlaTemplatesCol = db.collection('service_sla_templates');
    const serviceChecklistTemplatesCol = db.collection('service_checklist_templates');
    // Configuración por tipo y definiciones de campos
    const itemFieldDefinitionsCol = db.collection('item_field_definitions');
    const itemTypeFieldConfigCol = db.collection('item_type_field_config');
    const itemSectionDefinitionsCol = db.collection('item_section_definitions');

        // === Helper: Subida a Firebase Storage ===
        async function uploadFileToStorage(file, kind){
            try{
                const uidOrDev = (currentUser && currentUser.id) ? currentUser.id : getDeviceId();
                const base = kind==='image' ? 'uploads/items' : (kind==='doc' ? 'uploads/docs' : 'uploads/other');
                const safeName = (file.name || 'file').replace(/[^a-zA-Z0-9._-]/g, '_');
                const path = `${base}/${uidOrDev}/${Date.now()}_${safeName}`;
                const ref = storage.ref().child(path);
                const snap = await ref.put(file);
                const url = await snap.ref.getDownloadURL();
                return { url, path };
            }catch(e){ console.warn('uploadFileToStorage falló:', e); throw e; }
        }

        let currentUser = null;
        let userPermissions = new Set();
        let allUsers = [], allRoles = [], allPermissions = [], rolePermissionsMap = {};
        let viewsInitialized = false;
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const loginSection = document.getElementById('login-section');
        const appShell = document.getElementById('app-shell');
        const loginForm = document.getElementById('login-form');
        const userSelect = document.getElementById('user-select');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('login-message');
        const welcomeMessage = document.getElementById('welcome-message');
        const logoutButton = document.getElementById('logout-button');
        const mainNav = document.getElementById('main-nav');
        const modalsContainer = document.getElementById('modals-container');
    // Referencia al iframe del buscador para coordinar foco
    let itemsSearchIframeEl = null;
    // Actividad y tracking
    let sessionActivityId = null; // sesión de usuario
    let currentViewId = null; // vista activa
    let currentViewActivityId = null; // actividad de navegación por vista
    let itemCreateActivityId = null; // creación de ítem
    let searchSelectionActivityId = null; // selección en buscador
    let lastViewBeforeItems = null; // para devolver foco tras registrar/actualizar

        function toggleLoading(show, text = 'Cargando...') {
            loadingText.textContent = text;
            loadingOverlay.classList.toggle('hidden', !show);
            loadingOverlay.classList.toggle('flex', show);
        }

        function ensureFirebaseAuth() {
            if (firebase.auth().currentUser) {
                return Promise.resolve(firebase.auth().currentUser);
            }
            if (!authInitializationPromise) {
                authInitializationPromise = firebase.auth().signInAnonymously()
                    .catch(error => {
                        console.error('Error iniciando sesión anónima en Firebase:', error);
                        authInitializationPromise = null;
                        throw error;
                    });
            }
            return authInitializationPromise.then(credential => credential.user || firebase.auth().currentUser);
        }

        function buildAppUserContext() {
            if (!currentUser) return null;
            const roleDetails = (currentUser.rol_ids || []).map(roleId => {
                const role = allRoles.find(r => r.id === roleId);
                return role ? { id: role.id, name: role.name } : { id: roleId };
            });
            return {
                id: currentUser.id,
                name: currentUser.name,
                rol_ids: currentUser.rol_ids || [],
                roles: roleDetails,
                permissions: Array.from(userPermissions)
            };
        }

        async function notifyIframesAuthReady() {
            try {
                const user = await ensureFirebaseAuth();
                const token = await user.getIdToken();
                const appUser = buildAppUserContext();
                const payload = {
                    type: 'hostAuthReady',
                    firebaseConfig,
                    token,
                    user: {
                        uid: user.uid,
                        email: user.email || null,
                        displayName: user.displayName || null
                    },
                    appUser,
                    permissions: appUser ? appUser.permissions : [],
                    roles: appUser ? appUser.rol_ids || [] : []
                };
                document.querySelectorAll('iframe').forEach(iframe => {
                    const send = () => {
                        try {
                            if (iframe.contentWindow) {
                                iframe.contentWindow.postMessage(payload, '*');
                            }
                        } catch (err) {
                            console.warn('No se pudo enviar el contexto de autenticación al iframe', err);
                        }
                    };
                    send();
                    iframe.addEventListener('load', send, { once: true });
                });
            } catch (error) {
                console.error('No se pudo notificar a los iframes sobre la autenticación:', error);
            }
        }

        async function respondWithAuthContext(targetWindow) {
            if (!targetWindow) return;
            try {
                const user = await ensureFirebaseAuth();
                const token = await user.getIdToken();
                const appUser = buildAppUserContext();
                const roleNames = (appUser && appUser.rol_ids) ? (appUser.rol_ids.map(rid => (allRoles.find(ar=>ar.id===rid)?.name)).filter(Boolean)) : [];
                targetWindow.postMessage({
                    type: 'hostAuthReady',
                    firebaseConfig,
                    token,
                    user: {
                        uid: user.uid,
                        email: user.email || null,
                        displayName: user.displayName || null
                    },
                    appUser,
                    permissions: appUser ? appUser.permissions : [],
                    roles: appUser ? appUser.rol_ids || [] : [],
                    roleNames
                }, '*');
            } catch (error) {
                console.error('Error enviando datos de autenticación al iframe:', error);
            }
        }
        
        window.toggleModal = (modalId, show) => {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.toggle('hidden', !show);
            modal.classList.toggle('flex', show);
        };

        const views = {
            'dashboard': document.getElementById('view-dashboard'),
            'technician': document.getElementById('view-technician'),
            'clients': document.getElementById('view-clients'),
            'bonus-report': document.getElementById('view-bonus-report'),
            'task-admin': document.getElementById('view-task-admin'),
            'rbac-admin': document.getElementById('view-rbac-admin'),
            'items': document.getElementById('view-items'), // Crear Ítem
            'items-search': (() => { const d = document.createElement('div'); d.id = 'view-items-search'; d.className = 'view'; document.querySelector('main.container').appendChild(d); return d; })(),
            'items-taxonomy': (() => { const d = document.createElement('div'); d.id = 'view-items-taxonomy'; d.className = 'view'; document.querySelector('main.container').appendChild(d); return d; })(),
            'items-type-config': (() => { const d = document.createElement('div'); d.id = 'view-items-type-config'; d.className = 'view'; document.querySelector('main.container').appendChild(d); return d; })(),
        };

        function showView(viewId) {
            Object.values(views).forEach(view => view.classList.remove('active'));
            if (views[viewId]) {
                views[viewId].classList.add('active');
                document.dispatchEvent(new CustomEvent('viewchanged', { detail: { viewId } }));
            }
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.view === viewId);
            });
        }

        // Modal para establecer contraseña en primer inicio o formato legado
        function showSetPasswordModal(onSave) {
            let modal = document.getElementById('first-password-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'first-password-modal';
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                        <h3 class="text-xl font-bold mb-4">Establecer nueva contraseña</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">Nueva contraseña</label>
                                <input id="fpw1" type="password" class="w-full border rounded px-3 py-2" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Confirmar contraseña</label>
                                <input id="fpw2" type="password" class="w-full border rounded px-3 py-2" />
                            </div>
                            <div id="fpw-msg" class="text-sm h-5"></div>
                            <div class="btn-row justify-end pt-2">
                                <div class="btn-group">
                                    <button id="fpw-cancel" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded flex items-center">
                                        <i class="fa fa-times btn-icon mr-2"></i><span class="btn-text">Cancelar</span>
                                    </button>
                                    <button id="fpw-save" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center">
                                        <i class="fa fa-save btn-icon mr-2"></i><span class="btn-text">Guardar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
            const msg = modal.querySelector('#fpw-msg');
            msg.textContent = '';
            msg.className = 'text-sm h-5';
            modal.style.display = 'flex';
            modal.querySelector('#fpw-cancel').onclick = () => { modal.style.display = 'none'; };
            modal.querySelector('#fpw-save').onclick = async () => {
                const p1 = (modal.querySelector('#fpw1').value || '').trim();
                const p2 = (modal.querySelector('#fpw2').value || '').trim();
                if (!p1 || !p2) { msg.textContent = 'Complete ambos campos.'; msg.classList.add('text-red-600'); return; }
                if (p1 !== p2) { msg.textContent = 'Las contraseñas no coinciden.'; msg.classList.add('text-red-600'); return; }
                try {
                    await onSave(p1);
                    msg.textContent = 'Contraseña establecida.';
                    msg.classList.remove('text-red-600');
                    msg.classList.add('text-green-600');
                    setTimeout(() => { modal.style.display = 'none'; }, 600);
                } catch (err) {
                    console.error('Error guardando nueva contraseña:', err);
                    msg.textContent = (err && err.message) ? ('Error: ' + err.message) : 'Error al guardar.';
                    msg.classList.add('text-red-600');
                }
            };
        }

        async function handleLogin(e) {
            e.preventDefault();
            toggleLoading(true, 'Verificando...');
            const selectedUser = allUsers.find(u => u.id === userSelect.value);
            
            if (!selectedUser || !selectedUser.is_active) {
                loginMessage.textContent = 'Usuario inválido o deshabilitado.';
                toggleLoading(false); return;
            }

            const entered = (passwordInput.value || '').trim();
            let isAuthenticated = false;
            const stored = selectedUser.passwordHash;

            if (!stored || typeof stored !== 'string' || !stored.startsWith('pbkdf2$')) {
                // Primer inicio o formato legado: pedir que establezca contraseña
                toggleLoading(false);
                showSetPasswordModal(async (newPass) => {
                    const hashed = await pbkdf2Hash(newPass);
                    await employeesCol.doc(selectedUser.id).update({ passwordHash: hashed });
                    // Actualizar cache local para evitar re-pedir dentro de esta sesión
                    selectedUser.passwordHash = hashed;
                    const idx = allUsers.findIndex(u => u.id === selectedUser.id);
                    if (idx >= 0) allUsers[idx].passwordHash = hashed;
                    // tras establecer, iniciar sesión sin volver a pedir
                    currentUser = selectedUser;
                    loginMessage.textContent = '';
                    passwordInput.value = '';
                    await initializeMainApp();
                });
                return;
            }

            // Verificación PBKDF2
            if (entered) {
                isAuthenticated = await pbkdf2Verify(entered, stored);
            } else {
                // si hay hash y no ingresó password, no autenticar
                isAuthenticated = false;
            }

            if (isAuthenticated) {
                currentUser = selectedUser;
                loginMessage.textContent = '';
                passwordInput.value = '';
                await initializeMainApp();
                // Inicializar presencia con loginSince y viewSince
                try{
                    const presRef = presenceCol.doc(currentUser.id || getDeviceId());
                    await presRef.set({
                        userId: currentUser.id || null,
                        name: currentUser.name || null,
                        status: 'online',
                        loginSince: firebase.firestore.FieldValue.serverTimestamp(),
                        viewSince: firebase.firestore.FieldValue.serverTimestamp(),
                        activeView: 'dashboard',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    // Registrar inicio de sesión (actividad de sesión)
                    try{
                        const a = await activityLogsCol.add({
                            kind: 'session',
                            userId: currentUser.id || null,
                            userName: currentUser.name || null,
                            status: 'started',
                            startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            activeView: 'dashboard'
                        });
                        sessionActivityId = a.id;
                    }catch(e){ console.warn('No se pudo registrar inicio de sesión:', e); }
                    // Actualizar al cambiar de vista y registrar navegación
                    document.addEventListener('viewchanged', async (ev)=>{
                        const nextView = ev.detail?.viewId;
                        const prevView = currentViewId;
                        try{ await presRef.set({ activeView: nextView, viewSince: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }); }catch(e){}
                        // Cerrar actividad de vista anterior
                        if (currentViewActivityId){ try{ await activityLogsCol.doc(currentViewActivityId).update({ status:'exited', endedAt: firebase.firestore.FieldValue.serverTimestamp() }); }catch(e){}
                            currentViewActivityId = null;
                        }
                        // Iniciar actividad de nueva vista
                        try{
                            const nav = await activityLogsCol.add({
                                kind: 'view',
                                userId: currentUser.id || null,
                                userName: currentUser.name || null,
                                status: 'entered',
                                viewId: nextView || null,
                                startedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            currentViewId = nextView; currentViewActivityId = nav.id;
                        }catch(e){ console.warn('No se pudo registrar navegación de vista:', e); }
                        // Memorizar desde qué vista llegamos a Crear Ítem
                        if (nextView === 'items' && prevView && prevView !== 'items'){
                            lastViewBeforeItems = prevView;
                        }
                        // Al salir del buscador o de items, cerrar actividades contextuales
                        if (nextView !== 'items-search' && searchSelectionActivityId){ try{ await activityLogsCol.doc(searchSelectionActivityId).update({ status:'ended', endedAt: firebase.firestore.FieldValue.serverTimestamp() }); }catch(e){} searchSelectionActivityId = null; }
                        if (nextView !== 'items' && itemCreateActivityId){ try{ await activityLogsCol.doc(itemCreateActivityId).update({ status:'aborted', endedAt: firebase.firestore.FieldValue.serverTimestamp() }); }catch(e){} itemCreateActivityId = null; }
                    });
                    // Propagar básicos desde Crear Ítem
                    document.addEventListener('input', (ev)=>{
                        const t = ev.target; if (!t || !t.id) return;
                        if (['descripcion','costo','precioVenta'].includes(t.id)){
                            const basic = {
                                descripcion: (document.getElementById('descripcion')?.value||'').trim(),
                                costo: parseFloat(document.getElementById('costo')?.value||'')||null,
                                precioVenta: parseFloat(document.getElementById('precioVenta')?.value||'')||null
                            };
                            presRef.set({ basic, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }).catch(()=>{});
                        }
                    }, true);
                }catch(err){ console.warn('No se pudo inicializar presencia:', err); }
            } else {
                loginMessage.textContent = 'Contraseña incorrecta.';
                toggleLoading(false);
            }
        }
        
        function handleLogout() {
            // Cerrar actividades abiertas: sesión y vista
            (async ()=>{
                try{ if (currentViewActivityId){ await activityLogsCol.doc(currentViewActivityId).update({ status:'exited', endedAt: firebase.firestore.FieldValue.serverTimestamp() }); } }catch(e){}
                currentViewActivityId = null; currentViewId = null;
                try{ if (sessionActivityId){ await activityLogsCol.doc(sessionActivityId).update({ status:'ended', endedAt: firebase.firestore.FieldValue.serverTimestamp() }); } }catch(e){}
                sessionActivityId = null;
                // Marcar presencia como offline
                try{
                    const presRef = presenceCol.doc(currentUser?.id || getDeviceId());
                    await presRef.set({ status:'offline', updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                }catch(e){}
            })();
            currentUser = null;
            userPermissions.clear();
            appShell.classList.add('hidden');
            loginSection.style.display = 'flex';
            mainNav.innerHTML = '';
            // Notificar a iframes que ya no hay usuario de aplicación
            try { notifyIframesAuthReady(); } catch(e) { console.warn('No se pudo notificar logout a iframes', e); }
            // Al cerrar sesión, refrescar la lista de usuarios por si se crearon nuevos en el panel
            refreshLoginUsers().catch(err => console.warn('No se pudo refrescar usuarios de login:', err));
        }

        async function refreshLoginUsers() {
            try {
                toggleLoading(true, 'Actualizando usuarios...');
                const usersSnap = await employeesCol.orderBy('order').get();
                allUsers = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                userSelect.innerHTML = '';
                allUsers.filter(u => u.is_active).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    userSelect.appendChild(option);
                });
            } finally {
                toggleLoading(false);
            }
        }

        async function initializeMainApp() {
            await ensureFirebaseAuth();
            await fetchUserPermissions();
            if (!viewsInitialized) {
                initAllViews();
                viewsInitialized = true;
            }
            setupMainMenu();
            // Eventos menú móvil
            const mobileBtn = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileBtn && mobileMenu) {
                mobileBtn.onclick = () => mobileMenu.classList.toggle('hidden');
                // Cerrar al hacer clic fuera del panel (click en fondo)
                mobileMenu.addEventListener('click', (e) => {
                    if (e.target === mobileMenu) mobileMenu.classList.add('hidden');
                });
                // Cerrar al pasar a viewport md o más amplio
                window.addEventListener('resize', () => {
                    if (window.innerWidth >= 768) mobileMenu.classList.add('hidden');
                });
            }
            loginSection.style.display = 'none';
            appShell.classList.remove('hidden');
            welcomeMessage.innerHTML = `<p class="text-sm font-semibold text-gray-700">${currentUser.name}</p><p class="text-xs text-gray-500">${allRoles.find(r => r.id === (currentUser.rol_ids || [])[0])?.name || 'Sin rol'}</p>`;

            await notifyIframesAuthReady();

            const firstPermittedView = mainNav.querySelector('.nav-link')?.dataset.view;
            if (firstPermittedView) {
                showView(firstPermittedView);
            } else {
                views['dashboard'].innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow"><h2 class="text-2xl font-bold">Bienvenido, ${currentUser.name}</h2><p class="text-gray-600 mt-2">No tiene módulos asignados para visualizar.</p></div>`;
                showView('dashboard');
            }
            toggleLoading(false);
        }

        async function fetchUserPermissions() {
            userPermissions.clear();
            if (!currentUser || !currentUser.rol_ids) return;
            const userRoleIds = currentUser.rol_ids;
            let permissionIds = new Set();
            userRoleIds.forEach(roleId => { (rolePermissionsMap[roleId] || []).forEach(permId => permissionIds.add(permId)); });
            allPermissions.forEach(perm => { if (permissionIds.has(perm.id)) { userPermissions.add(perm.key); } });
        }
        
        function setupMainMenu() {
            mainNav.innerHTML = '';
            const mobileMenuList = document.getElementById('mobile-menu-list');
            if (mobileMenuList) mobileMenuList.innerHTML = '';
            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'M9 17v-2a4 4 0 00-4-4H3V9h2a4 4 0 004-4V3l5 4-5 4v-2a2 2 0 00-2 2v2h2l-2 2z', permissions: ['view_dashboard'] },
                { id: 'items', label: 'Crear Ítem', icon: 'M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z', permissions: ['manage_items'] },
                { id: 'items-search', label: 'Buscar Ítems', icon: 'M8 4h8M4 8h16M6 12h12M8 16h8', permissions: ['manage_items'] },
                { id: 'items-taxonomy', label: 'Categorías y Atributos', icon: 'M4 6a2 2 0 012-2h3l2 2h7a2 2 0 012 2v8a2 2 0 01-2 2H6a2 2 0 01-2-2V6z', permissions: ['manage_items'] },
                { id: 'items-type-config', label: 'Secciones por Tipo', icon: 'M12 8c1.657 0 3 1.343 3 3s-1.343 3-3 3-3-1.343-3-3 1.343-3 3-3zm0-6a9 9 0 100 18 9 9 0 000-18z', permissions: ['manage_items'] },
                { id: 'technician', label: 'Panel Técnico', icon: 'M10 20l4-16m4 4l-4 4-4-4 4-4', permissions: ['view_technician_panel'] },
                { id: 'clients', label: 'Clientes', icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-2a4 4 0 00-4-4H9.88a4 4 0 00-3.956 3.197', permissions: ['manage_clients'] },
                { id: 'bonus-report', label: 'Bonos', icon: 'M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z', permissions: ['view_bonus_report'] },
                { id: 'task-admin', label: 'Config. Tareas', icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z', permissions: ['manage_processes'] },
                { id: 'rbac-admin', label: 'Admin. Sistema', icon: 'M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z', permissions: ['manage_users', 'manage_roles_permissions'] },
            ];
            menuItems.forEach(item => {
                const canView = item.permissions.some(p => userPermissions.has(p));
                if (canView) {
                    const link = document.createElement('a');
                    link.className = 'nav-link flex items-center space-x-2 text-gray-600 font-medium';
                    link.dataset.view = item.id;
                    link.innerHTML = `<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"${item.icon}\" /></svg><span class=\"tab-text\">${item.label}</span>`;
                    link.onclick = () => showView(item.id);
                    mainNav.appendChild(link);

                    if (mobileMenuList) {
                        const mLink = document.createElement('a');
                        mLink.className = 'flex items-center justify-between px-4 py-3 border-b text-gray-700 hover:bg-gray-50';
                        mLink.dataset.view = item.id;
                        mLink.innerHTML = `<span>${item.label}</span><i class="fa fa-angle-right text-gray-400"></i>`;
                        mLink.onclick = () => {
                            showView(item.id);
                            const mobileMenu = document.getElementById('mobile-menu');
                            if (mobileMenu) mobileMenu.classList.add('hidden');
                        };
                        mobileMenuList.appendChild(mLink);
                    }
                }
            });
        }
        
        function initAllViews() {
            initDashboardView();
            initTechnicianView();
            initClientsView();
            initBonusReportView();
            initTaskAdminView();
            initRbacAdminView();
            initItemsView(); // <-- NUEVA INICIALIZACIÓN
            initItemsSearchView();
            initItemsTaxonomyView();
            initItemsTypeConfigView();
        }

        function getDeviceId() {
            // Implementación simple para compatibilidad con RBAC.
            // Puede ser mejorada para generar un ID único y persistente.
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'dev-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        function initDashboardView() {
            const view = views['dashboard'];
            view.innerHTML = `
                <section class="mb-4 bg-white rounded-xl border p-3">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-semibold text-gray-700">Usuarios en línea</h3>
                        <input id="presenceSearchInput" type="text" placeholder="Buscar usuario..." class="text-xs border rounded px-2 py-1" />
                    </div>
                    <div id="presenceBoard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 mb-2"></div>
                    <div id="presencePagination" class="flex items-center justify-end"></div>
                </section>
                <section class="mb-4 bg-white rounded-xl border p-3">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-semibold text-gray-700">Ítems con datos faltantes</h3>
                        <div class="flex gap-2 text-xs items-center">
                            <input id="incompleteSearchInput" type="text" placeholder="Buscar..." class="border rounded px-2 py-1" />
                            <button id="btnShowPending" class="px-2 py-1 bg-cyan-600 text-white rounded">Pendientes</button>
                            <button id="btnShowCompleted" class="px-2 py-1 bg-gray-200 text-gray-700 rounded">Completados</button>
                        </div>
                    </div>
                    <div id="incompleteList" class="space-y-2 mb-2"></div>
                    <div id="incompletePagination" class="flex items-center justify-end"></div>
                </section>
                <section class="mb-4 bg-white rounded-xl border p-3">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-semibold text-gray-700">Solicitudes de Ayuda</h3>
                        <input id="helpRequestsSearchInput" type="text" placeholder="Buscar solicitud..." class="text-xs border rounded px-2 py-1" />
                    </div>
                    <div id="helpRequestsList" class="space-y-2 mb-2"></div>
                    <div id="helpRequestsPagination" class="flex items-center justify-end"></div>
                </section>
                <section class="mb-4 bg-white rounded-xl border p-3">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-semibold text-gray-700">Histórico de actividades</h3>
                        <div class="flex gap-2 text-xs items-center">
                            <select id="activityFilter" class="border rounded px-2 py-1">
                                <option value="all">Todas</option>
                                <option value="session">Sesión</option>
                                <option value="view">Vistas</option>
                                <option value="item_create">Crear Ítem</option>
                                <option value="item_edit">Editar Ítem</option>
                                <option value="search_select">Selección en Buscador</option>
                                <option value="taxonomy_focus">Categoría/Atributo</option>
                                <option value="technician_task">Tareas Técnico</option>
                            </select>
                            <input id="activitySearchInput" type="text" placeholder="Buscar..." class="border rounded px-2 py-1" />
                        </div>
                    </div>
                    <div id="activityList" class="space-y-2 mb-2"></div>
                    <div id="activityPagination" class="flex items-center justify-end"></div>
                </section>
                <div class="rounded-xl overflow-hidden border">
                    <iframe src="Dashboard Gerencial 1.3.html" class="w-full min-h-[calc(100vh-180px)] bg-white" style="border:0;" loading="lazy"></iframe>
                </div>
                <!-- Modal de previsualización de adjuntos de Solicitudes de Ayuda -->
                <div id="hr-attach-modal" class="hidden fixed inset-0 bg-black/50 z-40 items-center justify-center">
                    <div class="bg-white rounded-lg shadow-lg max-w-[90vw] w-[720px] max-h-[85vh] flex flex-col">
                        <div class="flex items-center justify-between px-4 py-2 border-b">
                            <h4 id="hr-attach-title" class="text-sm font-semibold text-gray-800 truncate">Adjunto</h4>
                            <button id="hr-attach-close" class="text-gray-600 hover:text-gray-800 px-2 py-1"><i class="fa fa-times"></i></button>
                        </div>
                        <div class="p-4 flex-1 overflow-auto flex items-center justify-center bg-gray-50">
                            <img id="hr-attach-img" src="" alt="adjunto" class="hidden max-h-[70vh] max-w-[80vw] object-contain" />
                            <video id="hr-attach-video" controls class="hidden max-h-[70vh] max-w-[80vw]"></video>
                        </div>
                        <div class="px-4 py-2 border-t flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <button id="hr-attach-prev" class="px-2 py-1 text-xs bg-gray-200 text-gray-800 rounded"><i class="fa fa-chevron-left"></i></button>
                                <button id="hr-attach-next" class="px-2 py-1 text-xs bg-gray-200 text-gray-800 rounded"><i class="fa fa-chevron-right"></i></button>
                            </div>
                            <a id="hr-attach-open" href="#" target="_blank" class="text-xs underline text-cyan-700">Abrir archivo</a>
                        </div>
                    </div>
                </div>
            `;
            const PAGE_SIZE = 6;
            const makePaginator = (containerId, current, total, count, pageSize, onPage)=>{
                const host = view.querySelector('#'+containerId); if (!host) return;
                if (total <= 1){ host.innerHTML = ''; return; }
                const btn = (label, page, disabled=false, active=false)=>`<button data-p="${page}" class="px-2 py-1 rounded ${active? 'bg-cyan-600 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200'} ${disabled? 'opacity-50 cursor-not-allowed':''}" ${disabled? 'disabled':''}>${label}</button>`;
                let html = '<div class="w-full flex items-center justify-between text-xs">'
                    + `<div class="text-gray-500">${Math.min((current-1)*pageSize+1, count)}–${Math.min(current*pageSize, count)} de ${count}</div>`
                    + '<div class="flex items-center gap-1">'
                    + btn('«', 1, current===1) + btn('‹', current-1, current===1);
                const windowSize=5, start=Math.max(1,current-Math.floor(windowSize/2)), end=Math.min(total,start+windowSize-1);
                for(let p=start;p<=end;p++) html += btn(p,p,false,p===current);
                html += btn('›', current+1, current===total) + btn('»', total, current===total) + '</div></div>';
                host.innerHTML = html;
                host.querySelectorAll('button[data-p]')?.forEach(b=> b.addEventListener('click', ()=>{ const p=parseInt(b.dataset.p,10); if(!isNaN(p)) onPage(p); }));
            };
            // Suscripción a presencia con auto-refresco de duraciones
            const board = view.querySelector('#presenceBoard');
            const presenceSearchInput = view.querySelector('#presenceSearchInput');
            const presencePagination = view.querySelector('#presencePagination');
            let lastPresenceDocs = [];
            let presencePage = 1; let presenceSearch = '';
            const renderPresence = ()=>{
                const docs = lastPresenceDocs;
                const online = docs.filter(d=>d.data().status==='online');
                const filtered = online.filter(d=>{
                    if (!presenceSearch) return true;
                    const p = d.data();
                    const name = (p.name||'').toLowerCase();
                    const viewId = (p.activeView||'').toLowerCase();
                    return name.includes(presenceSearch) || viewId.includes(presenceSearch);
                });
                const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
                if (presencePage > totalPages) presencePage = totalPages;
                const start = (presencePage - 1) * PAGE_SIZE;
                const pageDocs = filtered.slice(start, start + PAGE_SIZE);
                board.innerHTML = pageDocs.map(d=>{
                    const p = d.data();
                    const basic = p.basic||{};
                    const loginSince = p.loginSince && p.loginSince.toDate ? p.loginSince.toDate() : null;
                    const viewSince = p.viewSince && p.viewSince.toDate ? p.viewSince.toDate() : null;
                    const selectionSince = p.selectionSince && p.selectionSince.toDate ? p.selectionSince.toDate() : null;
                    const taxonomySince = p.taxonomySince && p.taxonomySince.toDate ? p.taxonomySince.toDate() : null;
                    const taskSince = p.taskSince && p.taskSince.toDate ? p.taskSince.toDate() : null;
                    const mins = (ms)=> Math.max(0, Math.floor(ms/60000));
                    const now = new Date();
                    const sesionMin = loginSince ? mins(now - loginSince) : null;
                    const vistaMin = viewSince ? mins(now - viewSince) : null;
                    const selMin = selectionSince ? mins(now - selectionSince) : null;
                    const taxMin = taxonomySince ? mins(now - taxonomySince) : null;
                    const tMin = taskSince ? mins(now - taskSince) : null;
                    // Línea de detalle por vista
                    let detail = p.activeView||'-';
                    if (p.activeView === 'items'){
                        if (basic.descripcion) detail += ` · Creando: ${basic.descripcion}`;
                    } else if (p.activeView === 'items-search'){
                        if (basic.selectedItemDesc) detail += ` · Seleccionado: ${basic.selectedItemDesc}`;
                        if (selMin!==null) detail += ` · Selección: ${selMin} min`;
                    } else if (p.activeView === 'items-taxonomy'){
                        if (basic.taxonomyPath) detail += ` · En: ${basic.taxonomyPath}`;
                        if (taxMin!==null) detail += ` · Foco: ${taxMin} min`;
                    } else if (p.activeView === 'technician'){
                        if (basic.taskTitle) detail += ` · Tarea: ${basic.taskTitle}`;
                        if (tMin!==null) detail += ` · En tarea: ${tMin} min`;
                    } else {
                        if (basic.descripcion) detail += ` · ${basic.descripcion}`;
                    }
                    return `<div class=\"border rounded p-2 flex items-center gap-2\">`
                        + `<div class=\"w-2 h-2 rounded-full bg-green-500\"></div>`
                        + `<div class=\"min-w-0\">`
                        + `<div class=\"text-sm font-medium text-gray-800 truncate\">${p.name||'Usuario'}</div>`
                        + `<div class=\"text-xs text-gray-600 truncate\">${detail}</div>`
                        + `${sesionMin!==null ? `<div class=\"text-[11px] text-gray-500\">Sesión: ${sesionMin} min · Vista: ${vistaMin ?? '–'} min</div>`:''}`
                        + `</div>`
                        + `</div>`;
                }).join('');
                makePaginator('presencePagination', presencePage, totalPages, filtered.length, PAGE_SIZE, (p)=>{ presencePage=p; renderPresence(); });
            };
            presenceCol.orderBy('updatedAt','desc').limit(50).onSnapshot(snap=>{
                lastPresenceDocs = snap.docs;
                renderPresence();
            });
            // Refrescar cada minuto para actualizar los minutos transcurridos sin depender de snapshots
            setInterval(()=>{ if (lastPresenceDocs && lastPresenceDocs.length) renderPresence(); }, 60000);
            presenceSearchInput?.addEventListener('input', (e)=>{ presenceSearch = (e.target.value||'').toLowerCase(); presencePage = 1; renderPresence(); });
            // Suscripción a solicitudes de ayuda
            const helpRequestsSearchInput = view.querySelector('#helpRequestsSearchInput');
            const helpRequestsList = view.querySelector('#helpRequestsList');
            const helpRequestsPagination = view.querySelector('#helpRequestsPagination');
            let lastHelpRequestsDocs = [];
            let helpRequestsPage = 1; let helpRequestsSearch = '';
            const renderHelpRequests = () => {
                const docs = lastHelpRequestsDocs;
                const filtered = docs.filter(d => {
                    if (!helpRequestsSearch) return true;
                    const r = d.data();
                    const s = helpRequestsSearch;
                    return (r.part_description||r.description||'').toLowerCase().includes(s)
                        || (r.requesting_employee_name||'').toLowerCase().includes(s)
                        || (r.scope||'').toLowerCase().includes(s)
                        || (r.scope_name||'').toLowerCase().includes(s)
                        || (r.source||'').toLowerCase().includes(s);
                });
                const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
                if (helpRequestsPage > totalPages) helpRequestsPage = totalPages;
                const start = (helpRequestsPage - 1) * PAGE_SIZE;
                const pageDocs = filtered.slice(start, start + PAGE_SIZE);
                helpRequestsList.innerHTML = pageDocs.map(d => {
                    const r = d.data();
                    const when = r.created_at && r.created_at.toDate ? r.created_at.toDate().toLocaleString() : '';
                    const scopeText = r.scope_name ? `${r.scope||'-'} · ${r.scope_name}` : (r.scope||r.scope_id||'-');
                    const sourceBadge = r.source ? `<span class="ml-1 inline-block text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-700">${r.source}</span>` : '';
                    const attachCount = Array.isArray(r.attachments) ? r.attachments.length : 0;
                    const attachBadge = attachCount>0 ? `<span class=\"ml-2 text-[10px] px-1.5 py-0.5 rounded bg-indigo-100 text-indigo-800\">Adjuntos: ${attachCount}</span>` : '';
                    const attachmentsData = attachCount>0 ? encodeURIComponent(JSON.stringify(r.attachments)) : '';
                    const viewBtn = attachCount>0 ? `<button class=\"ml-2 text-[11px] text-cyan-700 underline hr-view-attachments\" data-attachments=\"${attachmentsData}\">ver</button>` : '';
                    const zipBtn = attachCount>0 ? `<button class=\"ml-2 text-[11px] text-gray-700 underline hr-zip-attachments\" data-attachments=\"${attachmentsData}\" data-name=\"${(r.scope_name||r.scope||'adjuntos').toString().replace(/\"/g,'\\\"')}\">descargar ZIP</button>` : '';
                    return `<div class="border rounded p-2 text-sm flex items-center justify-between">
                        <div class="min-w-0">
                            <div class="font-medium text-gray-800 truncate">${(r.part_description||r.description||'(sin descripción)')} <span class="text-[11px] text-gray-500">· ${r.requesting_employee_name||''} · ${when}</span></div>
                            <div class="text-xs text-gray-600 truncate">Ámbito: ${scopeText} ${sourceBadge}${attachBadge}${viewBtn}${zipBtn}</div>
                        </div>
                        <div class="flex gap-2">
                            <span class="text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800">${r.status||'Solicitado'}</span>
                        </div>
                    </div>`;
                }).join('');
                makePaginator('helpRequestsPagination', helpRequestsPage, totalPages, filtered.length, PAGE_SIZE, (p)=>{ helpRequestsPage=p; renderHelpRequests(); });
            };
            let unsubHelpRequests = null;
            const subHelp = ()=>{
                if (unsubHelpRequests) unsubHelpRequests();
                unsubHelpRequests = helpRequestsCol.orderBy('created_at','desc').limit(100).onSnapshot(snap=>{ lastHelpRequestsDocs = snap.docs; renderHelpRequests(); });
            };
            subHelp();
            helpRequestsSearchInput?.addEventListener('input', (e)=>{ helpRequestsSearch = (e.target.value||'').toLowerCase(); helpRequestsPage = 1; renderHelpRequests(); });
            // Preview y descarga de adjuntos de solicitudes
            let hrPreviewState = { attachments: [], index: 0 };
            const hrModal = document.getElementById('hr-attach-modal');
            const hrImg = document.getElementById('hr-attach-img');
            const hrVideo = document.getElementById('hr-attach-video');
            const hrTitle = document.getElementById('hr-attach-title');
            const hrOpen = document.getElementById('hr-attach-open');
            const hrClose = document.getElementById('hr-attach-close');
            const hrPrev = document.getElementById('hr-attach-prev');
            const hrNext = document.getElementById('hr-attach-next');
            const openHRModal = (attachments, startIndex=0)=>{
                hrPreviewState.attachments = attachments||[];
                hrPreviewState.index = Math.max(0, Math.min(startIndex, hrPreviewState.attachments.length-1));
                renderHRSlide();
                if (hrModal){ hrModal.classList.remove('hidden'); hrModal.classList.add('flex'); }
            };
            const closeHRModal = ()=>{ if (hrModal){ hrModal.classList.add('hidden'); hrModal.classList.remove('flex'); } };
            const renderHRSlide = ()=>{
                const a = hrPreviewState.attachments[hrPreviewState.index];
                if (!a){ return; }
                const ct = (a.contentType||'').toLowerCase();
                if (ct.startsWith('image/')){
                    if (hrVideo){ hrVideo.classList.add('hidden'); hrVideo.pause?.(); }
                    if (hrImg){ hrImg.src = a.url; hrImg.classList.remove('hidden'); }
                } else if (ct.startsWith('video/')){
                    if (hrImg) hrImg.classList.add('hidden');
                    if (hrVideo){ hrVideo.src = a.url; hrVideo.classList.remove('hidden'); }
                } else {
                    if (hrImg) hrImg.classList.add('hidden');
                    if (hrVideo){ hrVideo.classList.add('hidden'); hrVideo.pause?.(); }
                }
                if (hrTitle){ hrTitle.textContent = a.name || a.title || 'Adjunto'; }
                if (hrOpen){ if (a.url){ hrOpen.href = a.url; hrOpen.classList.remove('hidden'); } else { hrOpen.classList.add('hidden'); } }
            };
            hrClose?.addEventListener('click', closeHRModal);
            hrPrev?.addEventListener('click', ()=>{ if (hrPreviewState.index>0){ hrPreviewState.index--; renderHRSlide(); }});
            hrNext?.addEventListener('click', ()=>{ if (hrPreviewState.index < hrPreviewState.attachments.length-1){ hrPreviewState.index++; renderHRSlide(); }});
            helpRequestsList.addEventListener('click', async (e)=>{
                const viewBtn = e.target.closest('.hr-view-attachments');
                const zipBtn = e.target.closest('.hr-zip-attachments');
                if (viewBtn){
                    const data = viewBtn.getAttribute('data-attachments')||'';
                    try{ const arr = JSON.parse(decodeURIComponent(data)); openHRModal(arr, 0); }catch(err){ console.warn('Adjuntos inválidos', err); }
                } else if (zipBtn){
                    const data = zipBtn.getAttribute('data-attachments')||'';
                    const baseName = (zipBtn.getAttribute('data-name')||'adjuntos').replace(/\s+/g,'_');
                    let arr = [];
                    try{ arr = JSON.parse(decodeURIComponent(data)); }catch(err){ console.warn('Adjuntos inválidos', err); return; }
                    if (!arr.length) return;
                    try{
                        const zip = new JSZip();
                        let i=1;
                        for (const a of arr){
                            const url = a.url; if (!url) continue;
                            const resp = await fetch(url); const buf = await resp.arrayBuffer();
                            const ext = (a.name||'file').split('.').pop();
                            const fname = `${(a.name||a.title||`archivo_${i}`).toString().replace(/[^a-zA-Z0-9-_\.]/g,'_')}`;
                            zip.file(fname, buf);
                            i++;
                        }
                        const blob = await zip.generateAsync({ type:'blob' });
                        saveAs(blob, `${baseName}_adjuntos.zip`);
                    }catch(err){ console.error('ZIP error', err); alert('No se pudo generar el ZIP de adjuntos.'); }
                }
            });
            // Suscripción a incompletos
            const listEl = view.querySelector('#incompleteList');
            const incompleteSearchInput = view.querySelector('#incompleteSearchInput');
            const incompletePagination = view.querySelector('#incompletePagination');
            let showCompleted = false;
            let incompletePage = 1; let incompleteSearch = '';
            let lastIncompleteDocs = [];
            const renderIncomplete = () => {
                const docs = lastIncompleteDocs;
                const filteredByStatus = docs.filter(d=> (showCompleted? d.data().status==='completed' : d.data().status!=='completed'));
                const filtered = filteredByStatus.filter(d=>{
                    if (!incompleteSearch) return true;
                    const it = d.data();
                    const s = incompleteSearch;
                    return ((it.descripcion||'').toLowerCase().includes(s) || (it.userName||'').toLowerCase().includes(s));
                });
                const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
                if (incompletePage > totalPages) incompletePage = totalPages;
                const start = (incompletePage - 1) * PAGE_SIZE; const pageDocs = filtered.slice(start, start + PAGE_SIZE);
                listEl.innerHTML = pageDocs.map(d=>{
                    const it = d.data();
                    const when = it.createdAt && it.createdAt.toDate ? it.createdAt.toDate().toLocaleString() : '';
                    const missingLbl = (it.missingFields||[]).join(', ');
                    return `<div class=\"border rounded p-2 text-sm flex items-center justify-between\">
                        <div class=\"min-w-0\">
                            <div class=\"font-medium text-gray-800 truncate\">${it.descripcion||'(sin descripción)'} <span class=\"text-[11px] text-gray-500\">· ${it.userName||''} · ${when}</span></div>
                            <div class=\"text-xs text-gray-600 truncate\">Faltan: ${missingLbl||'-'} ${it.durationSec? `· Tardó: ${it.durationSec}s` : ''}</div>
                        </div>
                        <div class=\"flex gap-2\">
                            <button class=\"px-2 py-1 bg-cyan-600 text-white rounded edit-incomplete\" data-id=\"${d.id}\" data-item=\"${it.itemId}\"><i class=\"fa fa-pen\"></i></button>
                            ${it.status==='completed' ? '' : `<button class=\"px-2 py-1 bg-green-600 text-white rounded complete-incomplete\" data-id=\"${d.id}\"><i class=\"fa fa-check\"></i></button>`}
                        </div>
                    </div>`; 
                }).join('');
                makePaginator('incompletePagination', incompletePage, totalPages, filtered.length, PAGE_SIZE, (p)=>{ incompletePage=p; renderIncomplete(); });
            };
            let unsubIncomplete = null;
            const sub = ()=>{
                if (unsubIncomplete) unsubIncomplete();
                unsubIncomplete = incompleteItemsCol.orderBy('createdAt','desc').limit(100).onSnapshot(snap=>{
                    lastIncompleteDocs = snap.docs; renderIncomplete();
                });
            };
            sub();
            view.querySelector('#btnShowPending')?.addEventListener('click', ()=>{ showCompleted=false; view.querySelector('#btnShowPending').className='px-2 py-1 bg-cyan-600 text-white rounded'; view.querySelector('#btnShowCompleted').className='px-2 py-1 bg-gray-200 text-gray-700 rounded'; sub(); });
            view.querySelector('#btnShowCompleted')?.addEventListener('click', ()=>{ showCompleted=true; view.querySelector('#btnShowPending').className='px-2 py-1 bg-gray-200 text-gray-700 rounded'; view.querySelector('#btnShowCompleted').className='px-2 py-1 bg-cyan-600 text-white rounded'; sub(); });
            incompleteSearchInput?.addEventListener('input', (e)=>{ incompleteSearch = (e.target.value||'').toLowerCase(); incompletePage = 1; renderIncomplete(); });
            listEl?.addEventListener('click', async (e)=>{
                const editBtn = e.target.closest('.edit-incomplete');
                const compBtn = e.target.closest('.complete-incomplete');
                if (editBtn){
                    const itemId = editBtn.getAttribute('data-item');
                    if (itemId){ showView('items'); if (window.items_loadItemForEdit) window.items_loadItemForEdit(itemId, 'dashboard'); }
                } else if (compBtn){
                    const id = compBtn.getAttribute('data-id');
                    try{ await incompleteItemsCol.doc(id).update({ status:'completed', completedAt: firebase.firestore.FieldValue.serverTimestamp() }); }catch(err){ console.warn('No se pudo completar:', err); }
                }
            });

            // Histórico de actividades (CARLA)
            const activityList = view.querySelector('#activityList');
            const activityFilter = view.querySelector('#activityFilter');
            const activitySearchInput = view.querySelector('#activitySearchInput');
            const activityPagination = view.querySelector('#activityPagination');
            let unsubActivities = null; let lastActivityDocs = [];
            let activitySearch = ''; let activityPage = 1;
            const renderActivities = ()=>{
                const docs = lastActivityDocs;
                const fmt = (ts)=> ts && ts.toDate ? ts.toDate().toLocaleString() : '';
                const fKind = activityFilter?.value || 'all';
                const filteredKind = (fKind==='all') ? docs : docs.filter(d=> (d.data().kind===fKind));
                const filtered = filteredKind.filter(d=>{
                    if (!activitySearch) return true;
                    const a = d.data(); const s = activitySearch;
                    const detail = (a.viewId||'') + ' ' + (a.descripcion||'') + ' ' + (a.selectedDescripcion||'') + ' ' + (a.taskTitle||'') + ' ' + (a.path||'');
                    return (a.userName||'').toLowerCase().includes(s) || detail.toLowerCase().includes(s);
                });
                const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
                if (activityPage > totalPages) activityPage = totalPages;
                const start = (activityPage - 1) * PAGE_SIZE; const pageDocs = filtered.slice(start, start + PAGE_SIZE);
                activityList.innerHTML = pageDocs.map(d=>{
                    const a = d.data();
                    const dur = (a.startedAt && a.endedAt && a.startedAt.toDate && a.endedAt.toDate) ? Math.max(0, Math.round((a.endedAt.toDate() - a.startedAt.toDate())/1000)) : null;
                    let detail = '';
                    if (a.kind==='view') detail = `Vista: ${a.viewId||''}`;
                    else if (a.kind==='item_create') detail = `Crear: ${a.descripcion||''} ${a.itemId? '· ID '+a.itemId : ''}`;
                    else if (a.kind==='item_edit') detail = `Editar ID: ${a.itemId||''}`;
                    else if (a.kind==='search_select') detail = `Seleccionó: ${a.selectedDescripcion||''}`;
                    else if (a.kind==='taxonomy_focus') detail = `Taxonomía: ${a.path||''}`;
                    else if (a.kind==='technician_task') detail = `Tarea: ${a.taskTitle||''}`;
                    else if (a.kind==='session') detail = `Sesión`; 
                    return `<div class=\"border rounded p-2 text-sm\">`
                        + `<div class=\"flex items-center justify-between\">`
                        + `<div class=\"font-medium text-gray-800\">${a.userName||'Usuario'} · <span class=\"text-gray-600\">${a.kind}</span></div>`
                        + `<div class=\"text-xs text-gray-500\">${fmt(a.startedAt)}${a.endedAt? ' → '+fmt(a.endedAt): ''}</div>`
                        + `</div>`
                        + `<div class=\"text-xs text-gray-700 mt-1\">${detail} ${dur!==null? '· '+dur+'s':''}</div>`
                        + `</div>`;
                }).join('');
                makePaginator('activityPagination', activityPage, totalPages, filtered.length, PAGE_SIZE, (p)=>{ activityPage=p; renderActivities(); });
            };
            const subActs = ()=>{
                if (unsubActivities) unsubActivities();
                const q = activityLogsCol.orderBy('startedAt','desc').limit(100);
                unsubActivities = q.onSnapshot(snap=>{ lastActivityDocs = snap.docs; renderActivities(); });
            };
            subActs();
            activityFilter?.addEventListener('change', ()=>{ activityPage = 1; renderActivities(); });
            activitySearchInput?.addEventListener('input', (e)=>{ activitySearch = (e.target.value||'').toLowerCase(); activityPage = 1; renderActivities(); });
        }
        function initTechnicianView() {
            const view = views['technician'];
            view.innerHTML = `
                <div class="rounded-xl overflow-hidden border">
                    <iframe src="Sistema de productividad Taller VERSION 2.18.html" class="w-full min-h-[calc(100vh-180px)] bg-white" style="border:0;" loading="lazy"></iframe>
                </div>
            `;
        }
        function initClientsView() {
            const view = views['clients'];
            view.innerHTML = `
                <div class="rounded-xl overflow-hidden border">
                    <iframe src="Administración de Clientes.html" class="w-full min-h-[calc(100vh-180px)] bg-white" style="border:0;" loading="lazy"></iframe>
                </div>
            `;
        }
        function initBonusReportView() {
            const view = views['bonus-report'];
            view.innerHTML = `
                <div class="rounded-xl overflow-hidden border">
                    <iframe src="Dashboard Gerencial Reporte de Bonos.html" class="w-full min-h-[calc(100vh-180px)] bg-white" style="border:0;" loading="lazy"></iframe>
                </div>
            `;
        }
        function initTaskAdminView() {
            const view = views['task-admin'];
            view.innerHTML = `
                <div class="rounded-xl overflow-hidden border">
                    <iframe src="Panel de Administración de Tareas BIEN.html" class="w-full min-h-[calc(100vh-180px)] bg-white" style="border:0;" loading="lazy"></iframe>
                </div>
            `;
        }
        
        function initRbacAdminView() {
            const view = views['rbac-admin'];
            view.innerHTML = `
                <div class="rounded-xl overflow-hidden border">
                    <iframe src="Panel de Autenticación y Administración (RBAC)1.1.html" class="w-full min-h-[calc(100vh-180px)] bg-white" style="border:0;" loading="lazy"></iframe>
                </div>
            `;
        }

        function initItemsView() {
            const view = views['items'];
            // Insertar el HTML del formulario de item_version_1.1.html
            view.innerHTML = `
                <div class="container mx-auto max-w-5xl p-4 md:p-8">
                    <header class="mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Creación de Items</h1>
                        <p class="text-gray-600">Formulario principal de inventario.</p>
                    </header>
                    <div class="mb-6 bg-white p-6 rounded-lg shadow-md">
                        <div class="flex items-center justify-between gap-3 mb-2">
                            <label for="itemTypeSwitcher" class="block text-sm font-medium text-gray-700">1. Tipo de Item <span class="text-red-500">*</span></label>
                            <button id="btnRefreshSections" type="button" class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200" title="Refrescar secciones y reglas"><i class="fa fa-rotate"></i> Refrescar secciones</button>
                        </div>
                        <select id="itemTypeSwitcher" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="producto" selected>Producto (Ítem físico)</option>
                            <option value="servicio">Servicio (Item intangible)</option>
                            <option value="combo">Ítem Compuesto (Combo)</option>
                        </select>
                    </div>
                    <!-- Stepper tipo Jotform -->
                    <nav class="mb-6">
                        <ol class="flex flex-wrap items-center gap-2">
                            <li><a href="#basicos" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm"><span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-gray-700 text-white text-xs">1</span><span class="hidden sm:inline">Datos Básicos</span></a></li>
                            <li><a href="#sectionLogistica" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm"><span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-gray-700 text-white text-xs">2</span><span class="hidden sm:inline">Logística</span></a></li>
                            <li><a href="#sectionTrazabilidad" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm"><span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-gray-700 text-white text-xs">3</span><span class="hidden sm:inline">Trazabilidad</span></a></li>
                            <li><a href="#precios" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm"><span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-gray-700 text-white text-xs">4</span><span class="hidden sm:inline">Precios</span></a></li>
                            <li><a href="#ofertas" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm"><span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-gray-700 text-white text-xs">5</span><span class="hidden sm:inline">Ofertas</span></a></li>
                            <li><a href="#multimedia" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm"><span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-gray-700 text-white text-xs">6</span><span class="hidden sm:inline">Multimedia</span></a></li>
                            <li><a href="#sectionCombo" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm"><span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-gray-700 text-white text-xs">7</span><span class="hidden sm:inline">Combo</span></a></li>
                        </ol>
                    </nav>

                    <div id="itemSimpleView" class="space-y-4">
                        <!-- 1. Datos Básicos -->
                        <section id="basicos" class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">1. Datos Básicos</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="md:col-span-2">
                                    <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <input type="text" id="descripcion" data-validation="obligatorio" class="form-input mt-1 block w-full p-2 pr-10 border border-gray-300 rounded-md shadow-sm" placeholder="Ej: Impresora Epson L3250" autocomplete="off">
                                        <button id="descripcion-new-btn" type="button" title="Nuevo ítem" class="hidden absolute top-1.5 right-1.5 p-2 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300" aria-label="Nuevo ítem">
                                            <i class="fa fa-file-circle-plus"></i>
                                        </button>
                                        <div id="descripcion-suggestions" class="absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-64 overflow-auto hidden z-20"></div>
                                        <div id="descripcion-index-hint" class="hidden mt-2 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded px-2 py-1">La búsqueda requiere índices de Firestore para los campos "descripcion" y "sku". Si aparece un enlace en la consola (FAILED_PRECONDITION), ábrelo para crear el índice automáticamente.</div>
                                    </div>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="categoriaItem" class="block text-sm font-medium text-gray-700">Categoría</label>
                                    <select id="categoriaItem" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-white">
                                        <option value="">Sin categoría</option>
                                    </select>
                                    <div id="taxonomyAttributesContainer" class="mt-2 space-y-3"></div>
                                </div>
                                <div>
                                    <label for="marca" class="block text-sm font-medium text-gray-700">Marca <span class="text-orange-500">*</span></label>
                                    <input type="text" id="marca" data-validation="necesario" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="modelo" class="block text-sm font-medium text-gray-700">Modelo <span class="text-orange-500">*</span></label>
                                    <input type="text" id="modelo" data-validation="necesario" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="sku" class="block text-sm font-medium text-gray-700">Referencia / SKU <span class="text-red-500">*</span></label>
                                    <input type="text" id="sku" data-validation="obligatorio" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="proposito" class="block text-sm font-medium text-gray-700">Propósito del ítem <span class="text-red-500">*</span></label>
                                    <select id="proposito" data-validation="obligatorio" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-white">
                                        <option>Para la Venta</option>
                                        <option>Uso Interno/Consumo</option>
                                    </select>
                                </div>
                                <!-- (Extras de Servicio reubicado como sección independiente) -->
                                <div class="md:col-span-2 mt-2">
                                    <label class="flex items-center space-x-3">
                                        <input type="checkbox" id="chkUsaCodigoBarra" class="dynamic-toggle h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" data-target="#codigoBarraContent">
                                        <span class="text-sm font-medium text-gray-700 whitespace-nowrap">Usa Código de Barra</span>
                                    </label>
                                </div>
                                <div id="codigoBarraContent" class="conditional-content md:col-span-2 ml-8">
                                    <label for="codigoBarra" class="block text-sm font-medium text-gray-700">Código de Barra</label>
                                    <input type="text" id="codigoBarra" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                </div>
                            </div>
                        </section>

                        <!-- Sección opcional: Categoría y Atributos (movible desde editor) -->
                        <section id="sectionCategoria" class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Categoría y Atributos</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="categoriaSectionGrid"></div>
                        </section>

                        <!-- Sección independiente: Extras de Servicio -->
                        <section id="sectionServicio" class="bg-white p-6 rounded-lg shadow-sm hidden">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Extras de Servicio</h3>
                            <div id="serviceExtras" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <div class="flex items-center justify-between">
                                            <label for="serviceSLA" class="block text-sm font-medium text-gray-700">SLA predeterminado</label>
                                            <button type="button" id="btnManageSLA" class="px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300" title="Gestionar SLAs"><i class="fa fa-cog"></i></button>
                                        </div>
                                        <select id="serviceSLA" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-white">
                                            <option value="">Sin SLA</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-2">
                                        <div class="flex items-center justify-between">
                                            <label for="serviceChecklists" class="block text-sm font-medium text-gray-700">Checklist(s) por defecto</label>
                                            <button type="button" id="btnManageChecklists" class="px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300" title="Gestionar checklists"><i class="fa fa-cog"></i></button>
                                        </div>
                                        <select id="serviceChecklists" multiple size="4" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-white">
                                        </select>
                                        <div class="text-[11px] text-gray-500 mt-1">Sugerencia: podrás gestionar plantillas más adelante desde Configuración.</div>
                                    </div>
                                    <div class="md:col-span-3 col-span-1 -mx-6">
                                        <div class="px-6">
                                            <div class="relative">
                                                <input type="text" id="svcMatSearch" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Escribe para buscar (Descripción, SKU, Marca, Modelo)…">
                                                <div id="svcMatSuggestions" class="absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-64 overflow-auto hidden z-20"></div>
                                            </div>
                                            <p id="svcMatSearchModeHint" class="text-[11px] text-gray-500 mt-1">Modo: buscar por descripción, SKU, marca o modelo. Presiona Enter o haz clic para agregar a la lista.</p>
                                            <p id="svcMatIndexHint" class="text-[11px] text-amber-600 mt-1 hidden">Nota: si no aparecen resultados, puede requerirse un índice compuesto en Firestore para algunos campos.</p>
                                        </div>
                                        <div class="mt-3 overflow-x-auto px-6">
                                            <table class="w-full text-sm border rounded overflow-hidden">
                                                <thead class="bg-gray-50 text-gray-600">
                                                    <tr>
                                                        <th class="p-2 text-left">Descripción</th>
                                                        <th class="p-2 text-left">SKU</th>
                                                        <th class="p-2 text-center">Cantidad</th>
                                                        <th class="p-2 text-center">Sustitución</th>
                                                        <th class="p-2 text-center">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="svcMatTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- 2. Logística y Stock -->
                        <section id="sectionLogistica" class="bg-white p-6 rounded-lg shadow-sm" >
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">2. Logística y Stock</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div>
                                    <label for="stockMinimo" class="block text-xs text-gray-600">Stock Mínimo <span class="text-orange-500">*</span></label>
                                    <input type="number" id="stockMinimo" class="form-input mt-1 p-2 border border-gray-300 rounded-md" data-validation="necesario">
                                </div>
                                <div>
                                    <label for="stockMaximo" class="block text-xs text-gray-600">Stock Máximo</label>
                                    <input type="number" id="stockMaximo" class="form-input mt-1 p-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="tiempoReposicion" class="block text-xs text-gray-600">Tiempo de Reposición (días) <span class="text-orange-500">*</span></label>
                                    <input type="number" id="tiempoReposicion" class="form-input mt-1 p-2 border border-gray-300 rounded-md" data-validation="necesario">
                                </div>
                                <div>
                                    <label for="altoCm" class="block text-xs text-gray-600">Alto (cm) <span class="text-orange-500">*</span></label>
                                    <input type="number" id="altoCm" class="form-input mt-1 p-2 border border-gray-300 rounded-md" data-validation="necesario">
                                </div>
                                <div>
                                    <label for="anchoCm" class="block text-xs text-gray-600">Ancho (cm) <span class="text-orange-500">*</span></label>
                                    <input type="number" id="anchoCm" class="form-input mt-1 p-2 border border-gray-300 rounded-md" data-validation="necesario">
                                </div>
                                <div>
                                    <label for="profundoCm" class="block text-xs text-gray-600">Profundo (cm) <span class="text-orange-500">*</span></label>
                                    <input type="number" id="profundoCm" class="form-input mt-1 p-2 border border-gray-300 rounded-md" data-validation="necesario">
                                </div>
                                <div>
                                    <label for="pesoKg" class="block text-xs text-gray-600">Peso (kg) <span class="text-orange-500">*</span></label>
                                    <input type="number" id="pesoKg" class="form-input mt-1 p-2 border border-gray-300 rounded-md" data-validation="necesario">
                                </div>
                            </div>
                        </section>

                        <!-- 3. Trazabilidad -->
                        <section id="sectionTrazabilidad" class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">3. Trazabilidad</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="llevaNumeroSerie" class="block text-xs text-gray-600">¿Lleva Número de Serie? <span class="text-red-500">*</span></label>
                                    <select id="llevaNumeroSerie" class="form-input mt-1 p-2 border border-gray-300 rounded-md bg-white" data-validation="obligatorio">
                                        <option value="">Seleccione…</option>
                                        <option>Sí</option>
                                        <option>No</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="manejaLote" class="block text-xs text-gray-600">¿Maneja Lote? <span class="text-red-500">*</span></label>
                                    <select id="manejaLote" class="form-input mt-1 p-2 border border-gray-300 rounded-md bg-white" data-validation="obligatorio">
                                        <option value="">Seleccione…</option>
                                        <option>Sí</option>
                                        <option>No</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="manejaVencimiento" class="block text-xs text-gray-600">¿Maneja Fecha de Vencimiento? <span class="text-red-500">*</span></label>
                                    <select id="manejaVencimiento" class="form-input mt-1 p-2 border border-gray-300 rounded-md bg-white" data-validation="obligatorio">
                                        <option value="">Seleccione…</option>
                                        <option>Sí</option>
                                        <option>No</option>
                                    </select>
                                </div>
                            </div>
                        </section>

                        <!-- 4. Precios e Impuestos -->
                        <section id="precios" class="bg-white p-6 rounded-lg shadow-sm space-y-6">
                            <h3 class="text-lg font-semibold text-gray-900">4. Precios e Impuestos (USD)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="pricingModel" class="block text-xs text-gray-600">Modelo de precio</label>
                                    <select id="pricingModel" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-white">
                                        <option value="fixed" selected>Fijo</option>
                                        <option value="hourly">Por hora</option>
                                    </select>
                                </div>
                                <div id="hourlySection" class="hidden">
                                    <label for="hourlyRate" class="block text-xs text-gray-600">Tarifa por hora (USD)</label>
                                    <input type="number" id="hourlyRate" class="form-input mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="Ej: 40.00" title="Tarifa base por hora para servicios">
                                    <p class="text-[11px] text-gray-500 mt-1">Para servicios con modelo por hora, indique la tarifa en USD.</p>
                                </div>
                            </div>
                            <fieldset class="p-0 border-0">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                                    <div>
                                        <label for="costo" class="block text-xs text-gray-600">Costo (USD) <span class="text-red-500">*</span></label>
                                        <input type="number" id="costo" data-validation="obligatorio" class="form-input mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="Ej: 100.00" title="Costo de adquisición sin impuestos">
                                        <p class="text-[11px] text-gray-500 mt-1">Costo de adquisición sin impuestos ni ofertas.</p>
                                    </div>
                                    <div>
                                        <label for="utilidad" class="block text-xs text-gray-600">Utilidad (%)</label>
                                        <input type="number" id="utilidad" class="form-input mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="Ej: 25" title="Margen deseado como % del precio de venta">
                                        <p class="text-[11px] text-gray-500 mt-1">Margen deseado como porcentaje del precio de venta.</p>
                                    </div>
                                    <div>
                                        <div class="flex items-center justify-between">
                                            <label for="precioVenta" class="block text-xs text-gray-600">Precio Venta (USD)</label>
                                            <label class="text-[11px] text-gray-600 inline-flex items-center gap-1 select-none"><input id="fixPrecioManual" type="checkbox" class="align-middle"> Fijar precio manual</label>
                                        </div>
                                        <input type="number" id="precioVenta" class="form-input mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="Ej: 133.33" title="Se calcula con costo+utilidad si no fijas manualmente">
                                        <p class="text-[11px] text-gray-500 mt-1">Se calcula automáticamente con costo y utilidad si no fijas manualmente.</p>
                                    </div>
                                </div>
                            </fieldset>
                            <fieldset class="p-0 border-0">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                                    <div>
                                        <label for="precioBase" class="block text-xs text-gray-600">Precio Base (USD)</label>
                                        <input type="number" id="precioBase" class="form-input mt-1 w-full p-2 border border-gray-200 rounded-md bg-gray-100" readonly title="Copia del precio de venta para cálculo final">
                                        <p class="text-[11px] text-gray-500 mt-1">Copia del precio de venta a partir del cual se calcula el final.</p>
                                    </div>
                                    <div>
                                        <label for="diferencial" class="block text-xs text-gray-600">Diferencial (%)</label>
                                        <input type="number" id="diferencial" class="form-input mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="Ej: 5" title="Porcentaje extra (logística, comisiones, etc.)">
                                        <p class="text-[11px] text-gray-500 mt-1">Porcentaje extra (transporte, comisiones, etc.) aplicado sobre el precio base.</p>
                                    </div>
                                    <div>
                                        <label for="precioFinal" class="block text-xs text-gray-600">Precio Venta Final (USD-BCV)</label>
                                        <input type="number" id="precioFinal" class="form-input mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="Ej: 140.35" title="Si lo editas, recalcularemos el diferencial">
                                        <p class="text-[11px] text-gray-500 mt-1">Si editas este valor, recalcularemos el diferencial automáticamente.</p>
                                    </div>
                                </div>
                            </fieldset>
                            <fieldset class="border rounded-md p-4">
                                <legend class="text-md font-medium text-gray-700 px-2">Impuestos</legend>
                                <label class="flex items-center space-x-3 mt-2">
                                    <input type="checkbox" id="chkEsExento" class="dynamic-toggle h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" data-target="#impuestosContent" data-invert="true">
                                    <span class="text-sm font-medium text-gray-700">Es Exento de Impuesto <span class="text-red-500">*</span></span>
                                </label>
                                <p class="text-[11px] text-gray-500 mt-1 ml-8">Si el ítem es exento, no se aplicará ningún impuesto.</p>
                                <div id="impuestosContent" class="conditional-content mt-4 ml-8 space-y-4 visible">
                                    <div class="flex items-end space-x-2">
                                        <div class="flex-grow">
                                            <label for="tipoImpuesto" class="block text-xs text-gray-600">Tipo de Impuesto <span class="text-red-500">*</span></label>
                                            <select id="tipoImpuesto" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-white" title="Selecciona el impuesto a aplicar">
                                                <option value="">Seleccione…</option>
                                                <option value="__manage__">-- Agregar/Gestionar Impuestos --</option>
                                            </select>
                                            <p class="text-[11px] text-gray-500 mt-1">El porcentaje del impuesto seleccionado se copiará abajo.</p>
                                        </div>
                                        <button id="btnManageTaxes" class="p-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" type="button" title="Configurar impuestos"><i class="fas fa-cog"></i></button>
                                    </div>
                                    <div>
                                        <label for="impuestoAsignado" class="block text-xs text-gray-600">Impuesto Asignado (%)</label>
                                        <input type="number" id="impuestoAsignado" value="16" class="form-input mt-1 w-full p-2 border border-gray-200 rounded-md bg-gray-100" readonly title="Solo lectura; viene del tipo seleccionado">
                                        <p class="text-[11px] text-gray-500 mt-1">Solo lectura: proviene del impuesto seleccionado.</p>
                                    </div>
                                </div>
                            </fieldset>
                        </section>

                        <!-- 5. Gestor de Ofertas -->
                        <section id="ofertas" class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">5. Gestor de Ofertas y Descuentos</h3>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="chkEstaEnOferta" class="dynamic-toggle h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" data-target="#ofertaContent">
                                <span class="text-sm font-medium text-gray-700">¿Está en Oferta? <span class="text-red-500">*</span></span>
                            </label>
                            <div id="ofertaContent" class="conditional-content ml-8 mt-4 space-y-4 border rounded-md p-4 bg-gray-50">
                                <h4 class="font-medium text-gray-800">Registrar Nueva Oferta</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="ofertaTipo" class="block text-xs text-gray-600">Tipo de Descuento <span class="text-red-500">*</span></label>
                                        <select id="ofertaTipo" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-white" title="Porcentaje o monto fijo en USD">
                                            <option value="Porcentaje (%)">Porcentaje (%)</option>
                                            <option value="Monto Fijo (USD)">Monto Fijo (USD)</option>
                                        </select>
                                        <p class="text-[11px] text-gray-500 mt-1">Use porcentaje para descuentos relativos o monto fijo en USD.</p>
                                    </div>
                                    <div>
                                        <label for="ofertaValor" class="block text-xs text-gray-600">Valor del Descuento <span class="text-red-500">*</span></label>
                                        <input type="number" id="ofertaValor" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ej: 10" title="Para % ingrese 10 para 10%; para monto fijo, 10 = 10 USD">
                                        <p class="text-[11px] text-gray-500 mt-1">Para % ingrese 10 para 10%; para monto fijo, 10 equivale a 10 USD.</p>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="ofertaMotivo" class="block text-xs text-gray-600">Motivo <span class="text-orange-500">*</span></label>
                                        <input type="text" id="ofertaMotivo" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ej: Oferta de Verano" title="Texto visible en listados o comprobantes">
                                        <p class="text-[11px] text-gray-500 mt-1">Texto visible en listados o comprobantes.</p>
                                    </div>
                                    <div>
                                        <label for="ofertaInicio" class="block text-xs text-gray-600">Fecha de Inicio <span class="text-red-500">*</span></label>
                                        <input type="datetime-local" id="ofertaInicio" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" title="Inicio de vigencia en hora local">
                                        <p class="text-[11px] text-gray-500 mt-1">Inicio de vigencia (hora local).</p>
                                    </div>
                                    <div>
                                        <label for="ofertaFin" class="block text-xs text-gray-600">Fecha de Finalización <span class="text-red-500">*</span></label>
                                        <input type="datetime-local" id="ofertaFin" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" title="Fin de vigencia en hora local">
                                        <p class="text-[11px] text-gray-500 mt-1">Fin de vigencia (hora local).</p>
                                    </div>
                                </div>
                                <button id="btnRegisterOffer" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700">
                                    <i class="fas fa-plus-circle mr-2"></i>Registrar Oferta
                                </button>
                                <div class="mt-6">
                                    <h5 class="font-medium text-gray-800 mb-2">Ofertas Registradas</h5>
                                    <div id="offerListContainer" class="space-y-2">
                                        <p class="text-sm text-gray-500 italic" id="noOffersText">Aún no hay ofertas registradas.</p>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- 6. Multimedia -->
                        <section id="multimedia" class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">6. Multimedia (Imágenes)</h3>
                            <label for="imageUploadInput" id="imageUploadZone" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="text-center">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
                                    <p class="mt-2 text-sm text-gray-600">Arrastra y suelta las imágenes aquí, o haz clic para seleccionar</p>
                                    <p class="text-xs text-gray-500">PNG, JPG, WEBP</p>
                                </div>
                                <input type="file" id="imageUploadInput" multiple accept="image/*" class="hidden">
                            </label>
                            <div class="mt-6">
                                <h4 class="font-medium text-gray-800 mb-2">Previsualización (Arrastra para reordenar)</h4>
                                <div id="imagePreviewContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                            </div>
                        </section>

                        <!-- 7. Componentes del Combo -->
                        <section id="sectionCombo" class="bg-white p-6 rounded-lg shadow-sm hidden">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">7. Componentes del Combo</h3>
                            <!-- UI de combo removida intencionalmente. Sección limpia para futura configuración. -->
                        </section>
                    </div>
                    <div id="itemComboView" class="hidden">
                        <!-- Contenido del formulario de combos -->
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button id="btnRegistrarItem" class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <i class="fas fa-save mr-2"></i>Registrar Item
                        </button>
                    </div>
                </div>
                <!-- Modal para Metadatos de Imagen -->
                <div id="imageMetaModal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Editar Metadatos de Imagen</h3>
                        <input type="hidden" id="currentImageId">
                        <div class="space-y-4">
                            <div>
                                <label for="imageTitle" class="block text-sm font-medium text-gray-700">Título</label>
                                <input list="imageTitlePresets" type="text" id="imageTitle" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ej: Vista Frontal">
                                <datalist id="imageTitlePresets"></datalist>
                                <button id="manageTitlePresets" type="button" class="mt-2 px-3 py-1.5 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"><i class="fa fa-sliders"></i> Administrar plantillas</button>
                            </div>
                            <div>
                                <label for="imageDescription" class="block text-sm font-medium text-gray-700">Descripción</label>
                                <textarea id="imageDescription" rows="3" class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ej: Imagen con fondo blanco para catálogo"></textarea>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button id="cancelMeta" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                            <button id="saveMeta" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700">Guardar Metadatos</button>
                        </div>
                    </div>
                </div>
                <!-- Notificación Toast -->
                <div id="toast-notification" class="toast-notification hidden"></div>
            `;
            // Inyectar modales globales: gestor de impuestos y plantillas de título
            const modalsHost = document.getElementById('modals-container');
            if (modalsHost && !document.getElementById('taxesModal')){
                modalsHost.insertAdjacentHTML('beforeend', `
                <div id="taxesModal" class="modal-overlay hidden">
                    <div class="modal-content w-full max-w-3xl">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Gestor de Impuestos (VE)</h3>
                        <div class="space-y-3">
                            <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
                                <div class="md:col-span-2">
                                    <label class="block text-sm">Nombre</label>
                                    <input type="text" id="taxName" class="w-full border rounded px-2 py-2" placeholder="Ej: IVA General">
                                </div>
                                <div>
                                    <label class="block text-sm">Clave</label>
                                    <input type="text" id="taxKey" class="w-full border rounded px-2 py-2" placeholder="Ej: IVA_GENERAL">
                                </div>
                                <div>
                                    <label class="block text-sm">%</label>
                                    <input type="number" id="taxPercent" class="w-full border rounded px-2 py-2" placeholder="16" step="0.01" min="0" max="99">
                                </div>
                                <div class="flex items-center gap-2 md:col-span-2">
                                    <label class="inline-flex items-center mt-6"><input id="taxVisible" type="checkbox" class="mr-2" checked>Visible</label>
                                    <div class="mt-6 ml-auto">
                                        <button id="btnAddTax" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 whitespace-nowrap"><i class="fa fa-plus mr-1"></i>Agregar</button>
                                    </div>
                                </div>
                            </div>
                            <div class="border rounded">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 text-gray-600">
                                        <tr><th class="text-left p-2">Nombre</th><th class="text-left p-2">Clave</th><th class="text-left p-2">%</n+                                        </th><th class="p-2">Visible</th><th class="p-2">Acciones</th></tr>
                                    </thead>
                                    <tbody id="taxesTableBody"></tbody>
                                </table>
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" class="px-3 py-2 bg-gray-200 rounded" onclick="toggleModal('taxesModal', false)">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="titlePresetsModal" class="modal-overlay hidden">
                    <div class="modal-content w-full max-w-lg">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Plantillas de título de imagen</h3>
                        <div class="space-y-3">
                            <div class="flex gap-2">
                                <input id="presetInput" type="text" class="flex-grow border rounded px-2 py-2" placeholder="Nuevo título (Ej: Frontal)">
                                <button id="btnAddPreset" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"><i class="fa fa-plus"></i> Agregar</button>
                            </div>
                            <ul id="presetsList" class="space-y-2 max-h-64 overflow-auto"></ul>
                            <div class="flex justify-end">
                                <button type="button" class="px-3 py-2 bg-gray-200 rounded" onclick="toggleModal('titlePresetsModal', false)">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>`);
            }

            // Modales de gestión de SLAs y Checklists
            view.insertAdjacentHTML('beforeend', `
                <div id="slaTemplatesModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
                    <div class="bg-white rounded-lg w-full max-w-2xl p-4">
                        <h3 class="text-lg font-semibold">Plantillas de SLA</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 mt-3">
                            <input id="slaName" type="text" class="border rounded px-2 py-1 sm:col-span-2" placeholder="Nombre (Ej: Express 8h)">
                            <input id="slaCode" type="text" class="border rounded px-2 py-1" placeholder="Código (ej: express)">
                            <input id="slaHours" type="number" class="border rounded px-2 py-1" placeholder="Horas">
                        </div>
                        <div class="mt-2 flex justify-between">
                            <button id="btnAddSla" class="px-3 py-1.5 bg-blue-600 text-white rounded"><i class="fa fa-plus"></i> Agregar</button>
                            <button type="button" class="px-3 py-1.5 bg-gray-200 rounded" onclick="toggleModal('slaTemplatesModal', false)">Cerrar</button>
                        </div>
                        <div class="mt-3 overflow-auto max-h-64">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 text-gray-600"><tr><th class="p-2 text-left">Nombre</th><th class="p-2 text-left">Código</th><th class="p-2 text-center">Horas</th><th class="p-2 text-center">Visible</th><th class="p-2 text-center">Acciones</th></tr></thead>
                                <tbody id="slaList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="checklistTemplatesModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
                    <div class="bg-white rounded-lg w-full max-w-2xl p-4">
                        <h3 class="text-lg font-semibold">Plantillas de Checklists</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mt-3">
                            <input id="chkTitle" type="text" class="border rounded px-2 py-1 sm:col-span-2" placeholder="Título (Ej: Diagnóstico básico)">
                            <input id="chkKey" type="text" class="border rounded px-2 py-1" placeholder="Clave (ej: diag_basico)">
                        </div>
                        <div class="mt-2 flex justify-between">
                            <button id="btnAddChecklist" class="px-3 py-1.5 bg-blue-600 text-white rounded"><i class="fa fa-plus"></i> Agregar</button>
                            <button type="button" class="px-3 py-1.5 bg-gray-200 rounded" onclick="toggleModal('checklistTemplatesModal', false)">Cerrar</button>
                        </div>
                        <div class="mt-3 overflow-auto max-h-64">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 text-gray-600"><tr><th class="p-2 text-left">Título</th><th class="p-2 text-left">Clave</th><th class="p-2 text-center">Visible</th><th class="p-2 text-center">Acciones</th></tr></thead>
                                <tbody id="chkList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `);

            // Modal: opciones ante duplicados en Descripción
            view.insertAdjacentHTML('beforeend', `
                <div id="duplicateOptionsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Se encontraron ítems similares</h3>
                                <p class="text-sm text-gray-600">¿Qué deseas hacer con el ítem que estás escribiendo?</p>
                            </div>
                            <button id="dupCloseBtn" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300"><i class="fa fa-times"></i></button>
                        </div>
                        <div class="mb-3">
                            <label class="block text-xs text-gray-500 mb-1">Coincidencias</label>
                            <div id="dupMatches" class="max-h-40 overflow-auto border rounded">
                                <!-- filas dinámicas con radios -->
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <button id="dupOptEdit" class="p-4 border-2 rounded-xl hover:border-cyan-600 hover:bg-cyan-50 text-left flex items-start gap-3">
                                <i class="fa fa-pen-to-square text-xl text-cyan-700 mt-0.5"></i>
                                <div>
                                    <div class="font-semibold">Modificar/actualizar</div>
                                    <div class="text-xs text-gray-600">Abrir el ítem seleccionado para editarlo.</div>
                                </div>
                            </button>
                            <button id="dupOptSimilar" class="p-4 border-2 rounded-xl hover:border-amber-600 hover:bg-amber-50 text-left flex items-start gap-3">
                                <i class="fa fa-copy text-xl text-amber-700 mt-0.5"></i>
                                <div>
                                    <div class="font-semibold">Crear ítem similar</div>
                                    <div class="text-xs text-gray-600">Cargar datos como plantilla. Cambia la descripción antes de guardar.</div>
                                </div>
                            </button>
                            <button id="dupOptSeries" class="p-4 border-2 rounded-xl hover:border-emerald-600 hover:bg-emerald-50 text-left flex items-start gap-3">
                                <i class="fa fa-layer-group text-xl text-emerald-700 mt-0.5"></i>
                                <div>
                                    <div class="font-semibold">Crear varios similares</div>
                                    <div class="text-xs text-gray-600">Activa modo serie: tras guardar, se mantiene la plantilla para crear otro.</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `);

            // Ahora, inicializa toda la lógica de JavaScript para el formulario de items.
            // Esta es una adaptación del script de item_version_1.1.html
            
            // --- CONSTANTES DEL FORMULARIO DE ITEMS ---
            const itemTypeSwitcher = view.querySelector('#itemTypeSwitcher');
            const itemSimpleView = view.querySelector('#itemSimpleView');
            const itemComboView = view.querySelector('#itemComboView');
            const sectionLogistica = view.querySelector('#sectionLogistica');
            const sectionTrazabilidad = view.querySelector('#sectionTrazabilidad');
            const sectionCombo = view.querySelector('#sectionCombo');
            const categoriaItemSel = view.querySelector('#categoriaItem');
            const taxonomyContainer = view.querySelector('#taxonomyAttributesContainer');
            const serviceExtras = view.querySelector('#serviceExtras');
            const pricingModelSel = view.querySelector('#pricingModel');
            const hourlySection = view.querySelector('#hourlySection');
            const hourlyRateInput = view.querySelector('#hourlyRate');
            // Service components UI refs
            const svcMatSearch = view.querySelector('#svcMatSearch');
            const svcMatSuggestions = view.querySelector('#svcMatSuggestions');
            const svcMatTableBody = view.querySelector('#svcMatTableBody');
            let serviceComponents = [];
            // Combo components UI refs
            const comboSearch = view.querySelector('#comboSearch');
            const comboSuggestions = view.querySelector('#comboSuggestions');
            const comboTableBody = view.querySelector('#comboTableBody');
            let comboComponents = [];
            // Configuración dinámica para búsquedas (usada por consultas; sin UI extra)
            let svcSearchBy = ['descripcion', 'sku'];
            let comboSearchBy = ['descripcion', 'sku'];
            // Flags que habilitan/deshabilitan la búsqueda tipo combobox en listas nativas
            let svcSearchFeatureEnabled = false;
            let comboSearchFeatureEnabled = false;
            function updateSearchModeHints(){ /* no-op: se mantiene UI limpia sin franjas ni ARIA especiales */ }
            
            // (El acordeón fue reemplazado por secciones en tarjetas; mantenemos un stub para compatibilidad)
            function items_recalculateAccordionHeight() { /* no-op */ }

            // --- LÓGICA DE TOGGLE DINÁMICO ---
            view.querySelectorAll('.dynamic-toggle').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const targetElement = view.querySelector(checkbox.dataset.target);
                    if (targetElement) {
                        const shouldBeVisible = checkbox.dataset.invert ? !checkbox.checked : checkbox.checked;
                        targetElement.classList.toggle('visible', shouldBeVisible);
                        items_recalculateAccordionHeight(checkbox);
                    }
                });
                if (checkbox.dataset.invert) checkbox.dispatchEvent(new Event('change'));
            });

            // --- CONFIG: Reglas por tipo (secciones y campos) ---
            const FIELD_MAP = {
                descripcion:'#descripcion', sku:'#sku', marca:'#marca', modelo:'#modelo', proposito:'#proposito',
                usaCodigoBarra:'#chkUsaCodigoBarra', codigoBarra:'#codigoBarra', categoria:'#categoriaItem',
                stockMinimo:'#stockMinimo', stockMaximo:'#stockMaximo', tiempoReposicion:'#tiempoReposicion', altoCm:'#altoCm', anchoCm:'#anchoCm', profundoCm:'#profundoCm', pesoKg:'#pesoKg',
                llevaNumeroSerie:'#llevaNumeroSerie', manejaLote:'#manejaLote', manejaVencimiento:'#manejaVencimiento',
                pricingModel:'#pricingModel', hourlyRate:'#hourlyRate', costo:'#costo', utilidad:'#utilidad', precioVenta:'#precioVenta', precioBase:'#precioBase', diferencial:'#diferencial', precioFinal:'#precioFinal',
                esExento:'#chkEsExento', tipoImpuesto:'#tipoImpuesto', impuestoAsignado:'#impuestoAsignado',
                estaEnOferta:'#chkEstaEnOferta', ofertaTipo:'#ofertaTipo', ofertaValor:'#ofertaValor', ofertaMotivo:'#ofertaMotivo', ofertaInicio:'#ofertaInicio', ofertaFin:'#ofertaFin',
                serviceSLA:'#serviceSLA', serviceChecklists:'#serviceChecklists',
                // Nuevos campos de búsqueda (listas)
                serviceMaterialSearch:'#svcMatSearch',
                comboComponentSearch:'#comboSearch'
            };
            let perTypeSectionsCache = {};
            let fieldDefsCache = null;
            let fieldFunctionsCache = null;
            let sectionDefsCache = null;
            let specialSearchBindings = [];

            function normalizeTypeSections(rawList){
                if (!Array.isArray(rawList)) return [];
                const filtered = rawList.filter(entry=> entry && entry.id);
                if (!filtered.length) return [];
                const sorted = filtered.slice().sort((a,b)=>{
                    const ao = (typeof a.order=== 'number' && Number.isFinite(a.order)) ? a.order : 9999;
                    const bo = (typeof b.order=== 'number' && Number.isFinite(b.order)) ? b.order : 9999;
                    if (ao!==bo) return ao - bo;
                    const aid = (a.id||'').toString();
                    const bid = (b.id||'').toString();
                    return aid.localeCompare(bid);
                });
                const map = new Map();
                sorted.forEach(entry=>{
                    const id = entry.id;
                    const existing = map.get(id);
                    const ord = (typeof entry.order=== 'number' && Number.isFinite(entry.order)) ? entry.order : 9999;
                    if (!existing){
                        map.set(id, {
                            id,
                            order: ord,
                            visible: entry.visible!==false,
                            locked: !!entry.locked,
                            name: entry.name || null
                        });
                    } else {
                        if (ord < existing.order) existing.order = ord;
                        if (typeof entry.visible === 'boolean') existing.visible = entry.visible;
                        if (typeof entry.locked === 'boolean') existing.locked = entry.locked;
                        if (entry.name && !existing.name) existing.name = entry.name;
                    }
                });
                return Array.from(map.values())
                    .sort((a,b)=> (a.order??9999)-(b.order??9999) || (a.id||'').localeCompare(b.id||''))
                    .map((entry, idx)=> ({ ...entry, order: idx+1 }));
            }

            async function loadPerTypeSections(type){
                if (perTypeSectionsCache[type]) return perTypeSectionsCache[type];
                try{
                    await ensureFirebaseAuth();
                    const q = await itemTypeFieldConfigCol.where('type','==',type).limit(1).get();
                    const rawCfg = q.empty ? { type, sections: [] } : { id:q.docs[0].id, ...q.docs[0].data() };
                    const normalizedSections = normalizeTypeSections(rawCfg.sections||[]);
                    const cfg = { ...rawCfg, sections: normalizedSections };
                    perTypeSectionsCache[type] = cfg; return cfg;
                }catch(e){ console.warn('loadPerTypeSections', e); return { type, sections: [] }; }
            }

            async function loadFieldDefs(){
                if (fieldDefsCache) return fieldDefsCache;
                try{
                    await ensureFirebaseAuth();
                    const snap = await itemFieldDefinitionsCol.get();
                    fieldDefsCache = snap.docs.map(d=>({ id:d.id, ...d.data() })).filter(r=> r.archived!==true);
                    return fieldDefsCache;
                }catch(e){ console.warn('loadFieldDefs', e); return []; }
            }
            async function loadFieldFunctions(){
                if (fieldFunctionsCache) return fieldFunctionsCache;
                try{
                    await ensureFirebaseAuth();
                    const snap = await db.collection('item_field_functions').get();
                    fieldFunctionsCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
                    return fieldFunctionsCache;
                }catch(e){ console.warn('loadFieldFunctions', e); return []; }
            }
            async function loadSectionDefs(){
                if (sectionDefsCache) return sectionDefsCache;
                try{
                    await ensureFirebaseAuth();
                    const snap = await itemSectionDefinitionsCol.get();
                    sectionDefsCache = snap.docs.map(d=>({ id:d.id, ...d.data() })).filter(r=> r.archived!==true);
                    return sectionDefsCache;
                }catch(e){ console.warn('loadSectionDefs', e); return []; }
            }
            // Adjuntar función especial: Buscar en Items a campos configurados
            function attachSearchExistingToField(fieldKey, selector, searchBy){
                try{
                    const input = view.querySelector(selector);
                    if (!input) return;
                    const allowedFields = ['descripcion','sku','codigoBarra','marca','modelo'];
                    const requested = Array.isArray(searchBy) ? searchBy.slice() : [searchBy];
                    const fields = requested.filter(f=> allowedFields.includes(f));
                    const effectiveFields = fields.length ? Array.from(new Set(fields)) : ['descripcion'];
                    // Crear contenedor de sugerencias
                    // Limpia contenedores previos si existen para evitar duplicados
                    const existing = input.parentElement?.querySelectorAll?.('.search-existing-suggestions');
                    existing && existing.forEach && existing.forEach(el=> el.remove());
                    let sug = document.createElement('div');
                    sug.className = 'search-existing-suggestions absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-64 overflow-auto hidden z-20';
                    // Asegurar wrapper relative
                    let wrap = input.closest('.relative');
                    if (!wrap){
                        wrap = document.createElement('div');
                        wrap.className = 'relative';
                        input.parentNode.insertBefore(wrap, input);
                        wrap.appendChild(input);
                    }
                    wrap.appendChild(sug);
                    let debounceTimer=null; let results=[]; let idx=-1;
                    const hide=()=>{ sug.classList.add('hidden'); idx=-1; };
                    const render=()=>{
                        if (!results.length){ hide(); return; }
                        sug.innerHTML = results.map((r,i)=>`<div class="px-3 py-2 cursor-pointer hover:bg-cyan-50 ${i===idx?'bg-cyan-50':''}" data-idx="${i}"><div class="text-sm text-gray-800">${r.data.descripcion||'(Sin descripción)'} ${(r.data.sku? `<span class='ml-1 text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-600'>${r.data.sku}</span>`:'')}</div></div>`).join('');
                        sug.classList.remove('hidden');
                    };
                    const search = async (q)=>{
                        const t = (q||'').trim(); if (t.length<1){ hide(); return; }
                        try{
                            await ensureFirebaseAuth();
                            const perFieldLimit = Math.max(3, Math.floor(8 / effectiveFields.length));
                            const reqs = effectiveFields.map(f=>{
                                const fieldName = f==='codigoBarra' ? 'codigoBarra' : f;
                                return itemsCol.orderBy(fieldName).startAt(t).endAt(t+'\uf8ff').limit(perFieldLimit).get();
                            });
                            const settled = await Promise.allSettled(reqs);
                            let rows = [];
                            for (const s of settled){ if (s.status==='fulfilled'){ rows = rows.concat(s.value.docs.map(d=>({ id:d.id, data:d.data() }))); } }
                            // De-dup y recortar a 8
                            const seen = new Set();
                            results = rows.filter(r=>{ if (seen.has(r.id)) return false; seen.add(r.id); return true; }).slice(0,8);
                            // Si no hay resultados, hacer una sonda para diagnosticar: traer top 5 por descripcion
                            if (!results.length){
                                try{
                                    const probeSnap = await itemsCol.orderBy('descripcion').limit(5).get();
                                    let probeRows = probeSnap.docs.map(d=>({ id:d.id, data:d.data() }));
                                    const beforeFilter = probeRows.length;
                                    // aplicar filtro de productos si aplica
                                    if (fieldKey === 'serviceMaterialsList'){
                                        probeRows = probeRows.filter(r=>{
                                            try{ const raw=(r?.data?.type??'').toString().toLowerCase(); return raw==='producto'||raw==='product'; }catch(_){ return false; }
                                        });
                                    }
                                    const sample = (probeRows[0]?.data?.descripcion)|| (probeRows[0]?.data?.sku)|| '';
                                    const statusEl = document.getElementById((input.id||'') + '_status');
                                    if (statusEl){
                                        const msg = beforeFilter
                                          ? `Sin resultados · sonda: ${probeRows.length}/${beforeFilter} tras filtro (ej: ${sample||'—'})`
                                          : 'Sin resultados · sonda: 0';
                                        statusEl.textContent = msg; statusEl.classList.remove('hidden');
                                    }
                                }catch(_){ /* sonda opcional */ }
                            }
                            render();
                        }catch(err){ console.warn('searchExisting', fieldKey, err); hide(); }
                    };
                    const onInput = (e)=>{ clearTimeout(debounceTimer); debounceTimer=setTimeout(()=> search(e.target.value), 200); };
                    input.addEventListener('input', onInput);
                    sug.addEventListener('mousedown', (e)=>{ const el=e.target.closest('[data-idx]'); if(!el) return; const i=parseInt(el.dataset.idx,10); if(isNaN(i)) return; window.items_loadItemForEdit && window.items_loadItemForEdit(results[i].id, 'special'); hide(); });
                    input.addEventListener('keydown', (e)=>{
                        if (sug.classList.contains('hidden')) return;
                        if (e.key==='ArrowDown'){ e.preventDefault(); idx=(idx+1)%results.length; render(); }
                        else if(e.key==='ArrowUp'){ e.preventDefault(); idx=(idx-1+results.length)%results.length; render(); }
                        else if(e.key==='Enter'){
                            e.preventDefault();
                            let pick = null;
                            if (idx>=0 && results[idx]){ pick = results[idx]; }
                            else {
                                const val = (input.value||'').trim().toLowerCase();
                                const exact = results.find(r=>{
                                    const checks = [];
                                    if (effectiveFields.includes('descripcion')) checks.push((r.data.descripcion||'').toLowerCase());
                                    if (effectiveFields.includes('sku')) checks.push((r.data.sku||'').toLowerCase());
                                    if (effectiveFields.includes('codigoBarra')) checks.push((r.data.codigoBarra||'').toLowerCase());
                                    if (effectiveFields.includes('marca')) checks.push((r.data.marca||'').toLowerCase());
                                    if (effectiveFields.includes('modelo')) checks.push((r.data.modelo||'').toLowerCase());
                                    return checks.some(c=> c===val);
                                });
                                pick = exact || results[0];
                            }
                            if (pick){ window.items_loadItemForEdit && window.items_loadItemForEdit(pick.id, 'special'); hide(); }
                        }
                        else if(e.key==='Escape'){ hide(); }
                    });
                    input.addEventListener('blur', ()=> setTimeout(hide, 120));
                    specialSearchBindings.push({ fieldKey, selector, searchBy: effectiveFields });
                }catch(err){ console.warn('attachSearchExistingToField', fieldKey, err); }
            }

            // Buscador para campos listWithSearch: agrega a una lista local en vez de abrir el ítem
            function attachSearchForListField(fieldKey, selector, searchBy, canAdd){
                try{
                    const input = view.querySelector(selector);
                    if (!input) return;
                    const allowedFields = ['descripcion','sku','codigoBarra','marca','modelo'];
                    const requested = Array.isArray(searchBy) ? searchBy.slice() : [searchBy];
                    const fields = requested.filter(f=> allowedFields.includes(f));
                    const effectiveFields = fields.length ? Array.from(new Set(fields)) : ['descripcion'];
                    try { console.debug('[listWithSearch] bind', { fieldKey, selector, effectiveFields, canAdd }); } catch(_){ }
                    // limpiar overlays previos
                    const existing = input.parentElement?.querySelectorAll?.('.search-existing-suggestions');
                    existing && existing.forEach && existing.forEach(el=> el.remove());
                    let sug = document.createElement('div');
                    sug.className = 'search-existing-suggestions absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-64 overflow-auto hidden z-20';
                    let wrap = input.closest('.relative');
                    if (!wrap){ wrap = document.createElement('div'); wrap.className = 'relative'; input.parentNode.insertBefore(wrap, input); wrap.appendChild(input); }
                    wrap.appendChild(sug);
                    let debounceTimer=null; let results=[]; let idx=-1;
                    const hide=()=>{ sug.classList.add('hidden'); idx=-1; };
                    const render=()=>{ if (!results.length){ hide(); return; } sug.innerHTML = results.map((r,i)=>`<div class="px-3 py-2 cursor-pointer hover:bg-cyan-50 ${i===idx?'bg-cyan-50':''}" data-idx="${i}"><div class="text-sm text-gray-800">${r.data.descripcion||'(Sin descripción)'} ${(r.data.sku? `<span class='ml-1 text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-600'>${r.data.sku}</span>`:'')}</div></div>`).join(''); sug.classList.remove('hidden'); };
                    const search = async (q)=>{
                        const t = (q||'').trim(); if (t.length<1){ hide(); return; }
                        try{
                            await ensureFirebaseAuth();
                            const perFieldLimit = Math.max(3, Math.floor(8 / effectiveFields.length));
                            const reqs = effectiveFields.map(f=>{
                                const fieldName = f==='codigoBarra' ? 'codigoBarra' : f;
                                return itemsCol.orderBy(fieldName).startAt(t).endAt(t+'\uf8ff').limit(perFieldLimit).get();
                            });
                            const settled = await Promise.allSettled(reqs);
                            let rows = [];
                            const counts = {};
                            settled.forEach((s, idx)=>{
                                const fname = effectiveFields[idx] || ('f'+idx);
                                if (s.status==='fulfilled'){
                                    const docs = s.value.docs || [];
                                    counts[fname] = docs.length;
                                    rows = rows.concat(docs.map(d=>({ id:d.id, data:d.data() })));
                                } else {
                                    counts[fname] = 'ERR';
                                }
                            });
                            // Filtro especial: para listas de Servicio, solo productos
                            if (fieldKey === 'serviceMaterialsList'){
                                rows = rows.filter(r=>{
                                    try{
                                        const raw = (r?.data?.type ?? '').toString().toLowerCase();
                                        return raw === 'producto' || raw === 'product';
                                    }catch(_){ return false; }
                                });
                            }
                            const seen = new Set();
                            results = rows.filter(r=>{ if (seen.has(r.id)) return false; seen.add(r.id); return true; }).slice(0,8);
                            try{
                                const statusEl = document.getElementById((input.id||'') + '_status');
                                if (statusEl){
                                    const parts = Object.entries(counts).map(([k,v])=> `${k}:${v}`).join(' ');
                                    if (results.length){ statusEl.textContent = results.length + ' resultado(s) · ' + parts; statusEl.classList.remove('hidden'); }
                                    else { statusEl.textContent = 'Sin resultados · ' + parts; statusEl.classList.remove('hidden'); }
                                }
                            }catch(_){ }
                            render();
                        }catch(err){
                            console.warn('searchForListField', fieldKey, err);
                            try{
                                const statusEl = document.getElementById((input.id||'') + '_status');
                                if (statusEl){ statusEl.textContent = 'Error: ' + (err && (err.message||err.code||err.toString())); statusEl.classList.remove('hidden'); }
                            }catch(_){ }
                            hide();
                        }
                    };
                    const addToList = (pick)=>{
                        if (!canAdd){ hide(); return; }
                        try{
                            if (!view._dynamicLists) view._dynamicLists = {};
                            if (!Array.isArray(view._dynamicLists[fieldKey])) view._dynamicLists[fieldKey] = [];
                            const list = view._dynamicLists[fieldKey];
                            if (list.some(it=> it.id===pick.id)) { hide(); input.value=''; return; }
                            list.push({ id: pick.id, descripcion: pick.data.descripcion||'', sku: pick.data.sku||'', qty: 1, allowSubstitution: true });
                            renderDynamicList(fieldKey);
                            input.value=''; hide();
                        }catch(e){ console.warn('addToList failed', e); }
                    };
                    const onInput = (e)=>{ clearTimeout(debounceTimer); debounceTimer=setTimeout(()=> search(e.target.value), 200); };
                    input.addEventListener('input', onInput);
                    sug.addEventListener('mousedown', (e)=>{ const el=e.target.closest('[data-idx]'); if(!el) return; const i=parseInt(el.dataset.idx,10); if(isNaN(i)) return; const pick = results[i]; if (pick) addToList(pick); });
                    input.addEventListener('keydown', (e)=>{
                        if (sug.classList.contains('hidden')) return;
                        if (e.key==='ArrowDown'){ e.preventDefault(); idx=(idx+1)%results.length; render(); }
                        else if(e.key==='ArrowUp'){ e.preventDefault(); idx=(idx-1+results.length)%results.length; render(); }
                        else if(e.key==='Enter'){
                            e.preventDefault();
                            let pick = null;
                            if (idx>=0 && results[idx]){ pick = results[idx]; }
                            else { pick = results[0]; }
                            if (pick){ addToList(pick); }
                        }
                        else if(e.key==='Escape'){ hide(); }
                    });
                    input.addEventListener('blur', ()=> setTimeout(hide, 120));
                    specialSearchBindings.push({ fieldKey, selector, searchBy: effectiveFields, kind:'listWithSearch' });
                }catch(err){ console.warn('attachSearchForListField', fieldKey, err); }
            }

            function renderDynamicList(fieldKey){
                try{
                    const list = (view._dynamicLists && Array.isArray(view._dynamicLists[fieldKey])) ? view._dynamicLists[fieldKey] : [];
                    const body = view.querySelector(`#dyn_${fieldKey}_list`);
                    if (!body) return;
                    const isServiceList = !!body.closest('#serviceExtras');
                    const isComboList = !!body.closest('#sectionCombo');
                    body.innerHTML = list.map(it=> {
                        const qty = (it.qty ?? 1);
                        const qtyCell = (isServiceList || isComboList)
                            ? `<td class=\"p-2 text-center\"><input type=\"number\" min=\"1\" step=\"1\" value=\"${Math.max(1, parseInt(qty)||1)}\" class=\"w-20 border rounded px-1 py-0.5 text-right dyn-qty-int\" /><\/td>`
                            : `<td class=\"p-2 text-center\"><input type=\"number\" min=\"0.01\" step=\"0.01\" value=\"${Number(qty)||1}\" class=\"w-20 border rounded px-1 py-0.5 text-right dyn-qty\" /><\/td>`;
                        const subCell = isServiceList
                            ? `<td class=\"p-2 text-center\"><input type=\"checkbox\" class=\"dyn-sub\" ${it.allowSubstitution!==false ? 'checked' : ''}><\/td>`
                            : '';
                        return `<tr data-id=\"${it.id}\">`
                          + `<td class=\"p-2\">${it.descripcion||'(Sin descripción)'}<\/td>`
                          + `<td class=\"p-2 text-center\">${it.sku||''}<\/td>`
                          + qtyCell
                          + subCell
                          + `<td class=\"p-2 text-center\"><button class=\"px-2 py-1 bg-red-500 text-white rounded rm\">Quitar<\/button><\/td>`
                          + `</tr>`;
                    }).join('');
                    // Eliminar elemento
                    body.querySelectorAll('button.rm').forEach(btn=>{
                        btn.addEventListener('click', ()=>{
                            const tr = btn.closest('tr[data-id]'); if (!tr) return; const id = tr.getAttribute('data-id');
                            const arr = view._dynamicLists[fieldKey]||[]; const idx = arr.findIndex(x=> x.id===id); if (idx>=0){ arr.splice(idx,1); renderDynamicList(fieldKey); }
                        });
                    });
                    // Actualizar cantidad (decimal o entero según sección)
                    const updateQty = (inp, isInt)=>{
                        const tr = inp.closest('tr[data-id]'); if (!tr) return; const id = tr.getAttribute('data-id');
                        const arr = view._dynamicLists[fieldKey]||[]; const idx = arr.findIndex(x=> x.id===id);
                        if (idx>=0){
                            const v = isInt ? parseInt(inp.value||'') : parseFloat(inp.value||'');
                            arr[idx].qty = isNaN(v) ? 1 : Math.max(1, v);
                        }
                    };
                    body.querySelectorAll('input.dyn-qty').forEach(inp=>{ inp.addEventListener('input', ()=> updateQty(inp, false)); });
                    body.querySelectorAll('input.dyn-qty-int').forEach(inp=>{ inp.addEventListener('input', ()=> updateQty(inp, true)); });
                    // Actualizar sustitución
                    body.querySelectorAll('input.dyn-sub').forEach(chk=>{
                        chk.addEventListener('change', ()=>{
                            const tr = chk.closest('tr[data-id]'); if (!tr) return; const id = tr.getAttribute('data-id');
                            const arr = view._dynamicLists[fieldKey]||[]; const idx = arr.findIndex(x=> x.id===id);
                            if (idx>=0){ arr[idx].allowSubstitution = !!chk.checked; }
                        });
                    });
                }catch(e){ console.warn('renderDynamicList', fieldKey, e); }
            }

            // Sugerencias de valores distintos para campos simples (ej. marca/modelo)
            function attachSuggestDistinctToField(fieldKey, selector, distinctField){
                try{
                    const input = view.querySelector(selector);
                    if (!input) return;
                    const allowed = ['marca','modelo'];
                    const field = allowed.includes(distinctField) ? distinctField : null;
                    if (!field) return;
                    // Eliminar overlays anteriores si existen
                    const prev = input.parentElement?.querySelectorAll?.('.distinct-suggestions');
                    prev && prev.forEach && prev.forEach(el=> el.remove());
                    // Crear contenedor
                    let wrap = input.closest('.relative');
                    if (!wrap){
                        wrap = document.createElement('div');
                        wrap.className = 'relative';
                        input.parentNode.insertBefore(wrap, input);
                        wrap.appendChild(input);
                    }
                    let box = document.createElement('div');
                    box.className = 'distinct-suggestions absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-64 overflow-auto hidden z-20';
                    wrap.appendChild(box);
                    let timer=null; let results=[]; let hi=-1;
                    const hide=()=>{ box.classList.add('hidden'); hi=-1; };
                    const render=()=>{
                        if (!results.length){ hide(); return; }
                        box.innerHTML = results.map((v,i)=>`<div class="px-3 py-2 cursor-pointer hover:bg-cyan-50 ${i===hi?'bg-cyan-50':''}" data-idx="${i}"><div class="text-sm text-gray-800">${v}</div></div>`).join('');
                        box.classList.remove('hidden');
                    };
                    const search = async (q)=>{
                        const t = (q||'').trim(); if (t.length<1){ hide(); return; }
                        try{
                            await ensureFirebaseAuth();
                            const snap = await itemsCol.orderBy(field).startAt(t).endAt(t+'\uf8ff').limit(25).get();
                            const vals = snap.docs.map(d=> d.data()?.[field]).filter(v=> typeof v==='string' && v.trim().length>0);
                            const seen = new Set();
                            const uniq = [];
                            vals.forEach(v=>{ const key=(v||'').trim(); const kLower=key.toLowerCase(); if (!seen.has(kLower)){ seen.add(kLower); uniq.push(key); } });
                            results = uniq.slice(0,12);
                            render();
                        }catch(e){ console.warn('distinctSuggest error', fieldKey, field, e); hide(); }
                    };
                    const onInput = (e)=>{ clearTimeout(timer); timer=setTimeout(()=> search(e.target.value), 200); };
                    input.addEventListener('input', onInput);
                    box.addEventListener('mousedown', (e)=>{ const el=e.target.closest('[data-idx]'); if(!el) return; const i=parseInt(el.dataset.idx,10); if(isNaN(i)) return; input.value = results[i]||''; hide(); });
                    input.addEventListener('keydown', (e)=>{
                        if (box.classList.contains('hidden')) return;
                        if (e.key==='ArrowDown'){ e.preventDefault(); if(results.length){ hi=(hi+1)%results.length; render(); } }
                        else if (e.key==='ArrowUp'){ e.preventDefault(); if(results.length){ hi=(hi-1+results.length)%results.length; render(); } }
                        else if (e.key==='Enter'){
                            e.preventDefault();
                            const pick = (hi>=0 && results[hi]) ? results[hi] : (results[0]||'');
                            if (pick){ input.value = pick; hide(); }
                        } else if (e.key==='Escape'){ hide(); }
                    });
                    input.addEventListener('blur', ()=> setTimeout(hide, 120));
                }catch(err){ console.warn('attachSuggestDistinctToField', fieldKey, err); }
            }

            async function attachSpecialFunctions(){
                try{
                    const [defs, fns] = await Promise.all([loadFieldDefs(), loadFieldFunctions()]);
                    // limpiar bindings previos (no removemos listeners por simplicidad)
                    specialSearchBindings = [];
                    // reset de feature flags
                    descSearchFeatureEnabled = false;
                    svcSearchFeatureEnabled = false;
                    comboSearchFeatureEnabled = false;
                    // flags para acción onSelect (mantener true para backward compat)
                    let svcOnSelectAddEnabled = true;
                    let comboOnSelectAddEnabled = true;
                    // Mapa de overrides explícitos por definición (true/false)
                    const sfxEnabledByKey = {};
                    defs.forEach(d=>{
                        const sx = d.specialFunctions && d.specialFunctions.searchExisting;
                        if (sx && typeof sx.enabled === 'boolean'){ sfxEnabledByKey[d.key] = !!sx.enabled; }
                    });
                    // Helper: mapear contenedores a su buscador real
                    const resolveTargetKey = (k)=>{
                        if (k==='serviceComponents') return 'serviceMaterialSearch';
                        if (k==='comboItems') return 'comboComponentSearch';
                        return k;
                    };
                          const attached = new Set();
                          const debug = { defsEnabled: [], fnApplied: [], mappedTargets: [] };
                          // Preparar set de targets para onSelectAddToList antes de adjuntar buscadores a listWithSearch
                          const addToListTargets = new Set();
                          fns.filter(fn=> fn.type==='onSelectAddToList' && Array.isArray(fn.targets) && fn.targets.length)
                              .forEach(fn=>{ fn.targets.forEach(tkey=>{ addToListTargets.add(tkey); }); });
                    defs.forEach(d=>{
                        const sfx = d.specialFunctions && d.specialFunctions.searchExisting;
                        if (sfx && sfx.enabled){
                            const sel = FIELD_MAP[d.key];
                            if (!sel) return;
                            // No adjuntar buscador legacy a campos de tipo listWithSearch
                            // Evita que Enter/click navegue al formulario en listas dinámicas
                            if (d.fieldType === 'listWithSearch') {
                                return;
                            }
                            debug.defsEnabled.push({ key:d.key, searchBy:sfx.searchBy });
                            if (d.key==='descripcion'){
                                // Apagar completamente el legacy en descripción: no habilitar por specialFunctions
                                // La habilitación de búsqueda en descripción será gobernada SOLO por funciones (searchItems)
                                return;
                            }
                            // Para buscadores nativos de componentes, no adjuntamos sugerencias duplicadas; ajustamos su config
                            if (d.key==='serviceMaterialSearch'){
                                const by = (Array.isArray(sfx.searchBy)? sfx.searchBy : [sfx.searchBy]).filter(x=> ['descripcion','sku','codigoBarra','marca','modelo'].includes(x));
                                svcSearchBy = by.length? by : ['descripcion','sku'];
                                svcSearchFeatureEnabled = true;
                                return;
                            }
                            if (d.key==='comboComponentSearch'){
                                const by = (Array.isArray(sfx.searchBy)? sfx.searchBy : [sfx.searchBy]).filter(x=> ['descripcion','sku','codigoBarra','marca','modelo'].includes(x));
                                comboSearchBy = by.length? by : ['descripcion','sku'];
                                comboSearchFeatureEnabled = true;
                                return;
                            }
                            const by = (Array.isArray(sfx.searchBy)? sfx.searchBy : [sfx.searchBy]).filter(x=> ['descripcion','sku','codigoBarra','marca','modelo'].includes(x));
                            if (!attached.has(sel)){
                                attachSearchExistingToField(d.key, sel, by.length? by : ['descripcion']);
                                attached.add(sel);
                            }
                        }
                    });
                          // Aplicar funciones por targets (gestor de funciones)
                          const isSearchItemsType = (fn)=> (fn.type==='searchItems');
                          fns.filter(fn=> isSearchItemsType(fn) && Array.isArray(fn.targets) && fn.targets.length)
                       .forEach(fn=>{
                           const by = Array.isArray(fn.config?.searchBy)? fn.config.searchBy : (fn.config?.searchBy? [fn.config.searchBy] : ['descripcion']);
                           const defsByKey = new Map(defs.map(d=> [d.key, d]));
                           fn.targets.forEach(tkey=>{
                                const mappedKey = resolveTargetKey(tkey);
                                const sel = FIELD_MAP[mappedKey];
                                if (!sel) return;
                                // Solo respetamos OFF explícito para 'descripcion' (el usuario pidió poder desactivar ese buscador)
                                if (mappedKey==='descripcion' && sfxEnabledByKey['descripcion'] === false) return;
                                debug.mappedTargets.push(mappedKey);
                                if (mappedKey==='descripcion'){ descSearchFeatureEnabled = true; return; }
                                // Ajustar config para buscadores nativos
                                if (mappedKey==='serviceMaterialSearch'){
                                    const filtered = by.filter(x=> ['descripcion','sku','codigoBarra','marca','modelo'].includes(x));
                                    svcSearchBy = filtered.length? filtered : ['descripcion','sku'];
                                    svcSearchFeatureEnabled = true;
                                    debug.fnApplied.push({ key:mappedKey, by:svcSearchBy });
                                     return;
                                }
                                if (mappedKey==='comboComponentSearch'){
                                    const filtered = by.filter(x=> ['descripcion','sku','codigoBarra','marca','modelo'].includes(x));
                                    comboSearchBy = filtered.length? filtered : ['descripcion','sku'];
                                    comboSearchFeatureEnabled = true;
                                    debug.fnApplied.push({ key:mappedKey, by:comboSearchBy });
                                    return;
                                }
                                // Campos de tipo listWithSearch: usar handler especial y permitir agregar sólo si existe función onSelectAddToList targeteada
                                const def = defsByKey.get(mappedKey);
                                const isListWithSearch = def && def.fieldType==='listWithSearch';
                                const filteredBy = by.filter(x=> ['descripcion','sku','codigoBarra','marca','modelo'].includes(x));
                                if (!attached.has(sel)){
                                    if (isListWithSearch){
                                        const canAdd = (typeof addToListTargets!=='undefined') ? addToListTargets.has(mappedKey) : false;
                                        attachSearchForListField(mappedKey, sel, filteredBy, !!canAdd);
                                    } else {
                                        attachSearchExistingToField(mappedKey, sel, filteredBy);
                                    }
                                    attached.add(sel);
                                    debug.fnApplied.push({ key:mappedKey, by:filteredBy });
                                }
                           });
                       });

                    // Fallback: si existe un campo listWithSearch renderizado pero no se adjuntó función de búsqueda,
                    // adjuntar una búsqueda por defecto (descripcion, sku, codigoBarra, marca, modelo) para no bloquear la UX.
                    try{
                        const defsByKey2 = new Map(defs.map(d=> [d.key, d]));
                        Object.keys(FIELD_MAP||{}).forEach(k=>{
                            const def = defsByKey2.get(k);
                            if (!def || def.fieldType !== 'listWithSearch') return;
                            const sel = FIELD_MAP[k]; if (!sel) return;
                            if (attached.has(sel)) return; // ya hay binding
                            const canAdd = (typeof addToListTargets!=='undefined') ? addToListTargets.has(k) : false;
                            const by = ['descripcion','sku','codigoBarra','marca','modelo'];
                            attachSearchForListField(k, sel, by, !!canAdd);
                            attached.add(sel);
                            debug.fnApplied = debug.fnApplied || []; debug.fnApplied.push({ key:k, by });
                        });
                    }catch(_){ }
                    
                    // Mapear acciones onSelect por target (para descripción y otros campos)
                    
                    // Habilitación por defecto del buscador de Servicio (sin depender de funciones)
                    try{
                        const svcInput = view.querySelector('#svcMatSearch');
                        if (svcInput && svcSearchFeatureEnabled === false){
                            svcSearchBy = ['descripcion','sku'];
                            svcSearchFeatureEnabled = true;
                        }
                    }catch(_){ }
                    const onSelectActionsByTarget = new Map();
                    fns.filter(fn=> (fn.type || '').startsWith('onSelect') && Array.isArray(fn.targets) && fn.targets.length)
                       .forEach(fn=>{
                           fn.targets.forEach(tkey=>{
                               const arr = onSelectActionsByTarget.get(tkey) || [];
                               arr.push({ type: fn.type, config: fn.config || {} });
                               onSelectActionsByTarget.set(tkey, arr);
                           });
                       });
                    // Sugerencias de valores distintos (marca/modelo)
                    fns.filter(fn=> fn.type==='suggestDistinct' && Array.isArray(fn.targets) && fn.targets.length)
                       .forEach(fn=>{
                           const field = fn.config?.field;
                           fn.targets.forEach(tkey=>{
                               const sel = FIELD_MAP[tkey]; if (!sel) return;
                               if (field==='marca' || field==='modelo'){
                                   attachSuggestDistinctToField(tkey, sel, field);
                               }
                           });
                       });
                    // Mantener flags legacy
                    if (addToListTargets.has('serviceMaterialSearch')) svcOnSelectAddEnabled = true;
                    if (addToListTargets.has('comboComponentSearch')) comboOnSelectAddEnabled = true;
                    // Activar/desactivar buscador propio de descripción
                    // Ya no se deshabilita automáticamente en 'combo'; queda gobernado por funciones asignadas
                    // En tipo 'combo' desactivar completamente cualquier feature de búsqueda de combo y limpiar config (solo UI de lista de componentes)
                    try{ if ((itemTypeSwitcher?.value||'')==='combo'){ comboSearchFeatureEnabled = false; comboSearchBy = []; } }catch(_){ }
                    wireDescripcionSearch();
                    // UI sin banners ni ARIA especiales
                    updateSearchModeHints();
                    // Exponer flags onSelect para handlers de listas
                    view._svcOnSelectAddEnabled = svcOnSelectAddEnabled;
                    view._comboOnSelectAddEnabled = comboOnSelectAddEnabled;
                    // Exponer acciones onSelect (por target) para consumo de selectores como descripción
                    view._onSelectActions = Object.fromEntries(onSelectActionsByTarget.entries());
                    // Log de configuración sin confundir con combo cuando el tipo es 'combo'
                    (function(){
                        try{
                            const isComboType = (itemTypeSwitcher?.value||'')==='combo';
                            const log = { svcSearchBy, flags:{ descSearchFeatureEnabled, svcSearchFeatureEnabled, svcOnSelectAddEnabled }, debug };
                            if (!isComboType){
                                log.comboSearchBy = comboSearchBy;
                                log.flags.comboSearchFeatureEnabled = comboSearchFeatureEnabled;
                                log.flags.comboOnSelectAddEnabled = comboOnSelectAddEnabled;
                            }
                            console.debug('[Funciones] Config:', log);
                        }catch(_){
                            // Fallback de log en caso de error: evitar confundir con combo; no incluir comboSearchBy ni flags de combo
                            try {
                                console.debug('[Funciones] Config:', { svcSearchBy, flags:{ descSearchFeatureEnabled, svcSearchFeatureEnabled, svcOnSelectAddEnabled }, debug });
                            } catch(__){ console.debug('[Funciones] Config: (fallback simple)'); }
                        }
                    })();
                }catch(err){ console.warn('attachSpecialFunctions', err); }
            }

            function getFieldRuleForType(key, type, defs){
                const r = defs.find(d=>d.key===key);
                if (!r) return { visible:true, required:false };
                const vis = (r.visibleByType && typeof r.visibleByType[type]!== 'undefined') ? !!r.visibleByType[type] : (r.visible!==false);
                const req = (r.requiredByType && typeof r.requiredByType[type]!== 'undefined') ? !!r.requiredByType[type] : !!r.required;
                return { visible: vis, required: req };
            }

            async function applyPerTypeRules(type){
                try{
                    const [cfg, defs, sectionDefs] = await Promise.all([loadPerTypeSections(type), loadFieldDefs(), loadSectionDefs()]);
                    // Secciones: visibilidad + orden (solo secciones top-level)
                    const sectionElemsMap = {
                        basicos: view.querySelector('#basicos'),
                        logistica: view.querySelector('#sectionLogistica'),
                        trazabilidad: view.querySelector('#sectionTrazabilidad'),
                        precios: view.querySelector('#precios'),
                        ofertas: view.querySelector('#ofertas'),
                        multimedia: view.querySelector('#multimedia'),
                        categoria: view.querySelector('#sectionCategoria'),
                        servicio: view.querySelector('#sectionServicio'),
                        combo: view.querySelector('#sectionCombo')
                    };
                    const fallbackOrder = ['basicos','categoria','logistica','trazabilidad','precios','ofertas','multimedia','combo'];
                    const normalizedSectionsList = (Array.isArray(cfg.sections) && cfg.sections.length)
                        ? cfg.sections
                        : fallbackOrder.map((id, idx)=> ({ id, order: idx+1, enabled: id==='basicos', visible: id==='basicos' }));
                    const sectionsById = new Map(normalizedSectionsList.map(s=> [s.id, s]));
                    const sectionNamesMap = new Map((sectionDefs||[]).map(s=> [s.id, (s.name||'').trim()]));
                    const defaultSectionLabels = {
                        basicos: 'Datos Básicos',
                        categoria: 'Categoría',
                        logistica: 'Logística y Stock',
                        trazabilidad: 'Trazabilidad',
                        precios: 'Precios',
                        impuestos: 'Impuestos',
                        ofertas: 'Gestor de Ofertas y Descuentos',
                        multimedia: 'Multimedia (Imágenes)',
                        combo: 'Componentes del Combo',
                        servicio: 'Extras de Servicio'
                    };
                    const toSectionDomId = (id)=> `section-${String(id||'').replace(/[^a-zA-Z0-9_-]/g,'-')}`;
                    const resolveSectionName = (id)=>{
                        const cfgName = sectionsById.get(id)?.name;
                        if (cfgName && cfgName.trim()) return cfgName.trim();
                        const defName = sectionNamesMap.get(id);
                        if (defName && defName.trim()) return defName.trim();
                        return defaultSectionLabels[id] || id;
                    };
                    const parent = view.querySelector('#itemSimpleView');
                    // Crear secciones dinámicas SOLO para ids habilitados+visibles sin contenedor predefinido
                    if (parent){
                        normalizedSectionsList.filter(sec=> sec && sec.id && sec.enabled!==false && sec.visible!==false).forEach(sec=>{
                            const id = sec.id;
                            if (!id || sectionElemsMap[id]) return;
                            let dyn = parent.querySelector(`[data-dynamic-section="${id}"]`);
                            if (!dyn){
                                dyn = document.createElement('section');
                                dyn.className = 'bg-white p-6 rounded-lg shadow-sm';
                                dyn.dataset.dynamicSection = id;
                                dyn.id = toSectionDomId(id);
                                const heading = document.createElement('h3');
                                heading.className = 'text-lg font-semibold text-gray-900 mb-4';
                                heading.textContent = resolveSectionName(id);
                                dyn.appendChild(heading);
                                const grid = document.createElement('div');
                                grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-6 dynamic-section-grid';
                                grid.dataset.sectionTarget = id;
                                dyn.appendChild(grid);
                                parent.appendChild(dyn);
                            } else {
                                const heading = dyn.querySelector('h3');
                                if (heading) heading.textContent = resolveSectionName(id);
                            }
                            sectionElemsMap[id] = dyn;
                        });
                    }
                    for (const [k, el] of Object.entries(sectionElemsMap)){
                        if (!el) continue;
                        const conf = sectionsById.get(k);
                        // Por defecto, solo 'basicos' habilitada+visible si no hay entrada explícita en la config.
                        const defaultEnabled = (k==='basicos');
                        const defaultVisible = (k==='basicos');
                        const enabled = conf ? (conf.enabled!==false) : defaultEnabled;
                        const visible = conf ? (conf.visible!==false) : defaultVisible;
                        const should = enabled && visible;
                        if (k==='servicio'){
                            const visible = (type==='servicio' && should);
                            el.classList.toggle('hidden', !visible);
                            el.style.display = visible ? '' : 'none';
                        } else if (k==='combo'){
                            const visible = (type==='combo' && should);
                            el.classList.toggle('hidden', !visible);
                            el.style.display = visible ? '' : 'none';
                        } else {
                            el.classList.toggle('hidden', !should);
                            el.style.display = should ? '' : 'none';
                        }
                    }
                    try{ console.debug('[Secciones] Aplicadas:', { type, sectionsCfg: normalizedSectionsList, decided: Object.keys(sectionElemsMap).map(id=> ({ id, visible: !(sectionElemsMap[id]?.classList.contains('hidden') || sectionElemsMap[id]?.style.display==='none') })) }); }catch(_){ }
                    // Reordenar top-level (todas las secciones con contenedor propio, incluidas dinámicas)
                    if (parent){
                        const orderIds = normalizedSectionsList
                            .map(s=> s.id)
                            .filter(id=>{
                                const el = sectionElemsMap[id];
                                return el && el.parentElement === parent; // solo top-level visibles en el formulario
                            });
                        const appended = new Set();
                        for (const id of orderIds){
                            if (appended.has(id)) continue;
                            appended.add(id);
                            const el = sectionElemsMap[id];
                            if (el && el.parentElement===parent){ parent.appendChild(el); }
                        }
                    }

                    // Ajustar título base de Categoría antes de numerar
                    try{
                        const catSec = view.querySelector('#sectionCategoria');
                        if (catSec){
                            const h = catSec.querySelector('h3');
                            if (h) h.textContent = resolveSectionName('categoria');
                            // Mover contenedor de atributos de taxonomía a la sección Categoría
                            const grid = catSec.querySelector('#categoriaSectionGrid') || catSec.querySelector('[data-section-target="categoria"]');
                            const tax = view.querySelector('#taxonomyAttributesContainer');
                            if (grid && tax && tax.parentElement!==grid){
                                try{ grid.appendChild(tax); }catch(_){ }
                            }
                        }
                    }catch(_){ }

                    // Si existe sección dinámica 'impuestos', mover el fieldset de impuestos dentro de ella
                    try{
                        const impCfg = sectionsById.get('impuestos');
                        const impSection = view.querySelector('[data-dynamic-section="impuestos"]');
                        const impuestosContent = view.querySelector('#impuestosContent');
                        if (impCfg && impSection && impuestosContent){
                            // Subimos al fieldset que contiene #impuestosContent
                            let fieldset = impuestosContent.closest('fieldset');
                            if (fieldset && fieldset.parentElement){
                                // Insertar el fieldset dentro de la sección dinámica (antes de la grid)
                                const dynGrid = impSection.querySelector('.dynamic-section-grid');
                                if (dynGrid){ impSection.insertBefore(fieldset, dynGrid); }
                                else { impSection.appendChild(fieldset); }
                            }
                        }
                    }catch(e){ console.warn('No se pudo mover Impuestos a su sección:', e); }

                    // Reconstruir stepper y numeración de encabezados
                    try{
                        const stepperOl = view.querySelector('nav ol');
                        const candidateIds = normalizedSectionsList
                            .map(s=> s.id)
                            .filter(id=>{
                                const el = sectionElemsMap[id];
                                if (!el) return false;
                                if (!parent) return true;
                                return el.parentElement === parent;
                            });
                        const visibleIds = [];
                        candidateIds.forEach(id=>{
                            if (visibleIds.includes(id)) return;
                            const el = sectionElemsMap[id];
                            if (!el) return;
                            const hiddenByClass = el.classList.contains('hidden');
                            const hiddenByStyle = el.style.display === 'none';
                            if (!hiddenByClass && !hiddenByStyle){ visibleIds.push(id); }
                        });
                        const anchorFor = (id)=>{
                            if (id==='basicos') return '#basicos';
                            if (id==='categoria') return '#sectionCategoria';
                            if (id==='logistica') return '#sectionLogistica';
                            if (id==='trazabilidad') return '#sectionTrazabilidad';
                            if (id==='precios') return '#precios';
                            if (id==='ofertas') return '#ofertas';
                            if (id==='multimedia') return '#multimedia';
                            if (id==='combo') return '#sectionCombo';
                            if (id==='servicio') return '#sectionServicio';
                            return `#${toSectionDomId(id)}`;
                        };
                        if (stepperOl){
                            if (visibleIds.length){
                                stepperOl.innerHTML = visibleIds.map((id, idx)=>{
                                    const num = idx+1;
                                    const label = resolveSectionName(id);
                                    const href = anchorFor(id);
                                    return `<li><a href="${href}" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm"><span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-gray-700 text-white text-xs">${num}</span><span class="hidden sm:inline">${label}</span></a></li>`;
                                }).join('');
                            } else {
                                stepperOl.innerHTML = '';
                            }
                        }
                        const headingEls = {
                            basicos: view.querySelector('#basicos h3'),
                            categoria: view.querySelector('#sectionCategoria h3'),
                            logistica: view.querySelector('#sectionLogistica h3'),
                            trazabilidad: view.querySelector('#sectionTrazabilidad h3'),
                            precios: view.querySelector('#precios h3'),
                            ofertas: view.querySelector('#ofertas h3'),
                            multimedia: view.querySelector('#multimedia h3'),
                            combo: view.querySelector('#sectionCombo h3')
                        };
                        Object.entries(headingEls).forEach(([id, el])=>{
                            if (el) el.textContent = resolveSectionName(id);
                        });
                        visibleIds.forEach((id, idx)=>{
                            const el = headingEls[id];
                            if (el){
                                el.textContent = `${idx+1}. ${resolveSectionName(id)}`;
                            } else {
                                const dyn = sectionElemsMap[id];
                                const dynHeading = dyn ? dyn.querySelector('h3') : null;
                                if (dynHeading) dynHeading.textContent = `${idx+1}. ${resolveSectionName(id)}`;
                            }
                        });
                        // Secciones dinámicas restantes (no visibles en stepper) mantienen su rótulo base
                        if (parent){
                            normalizedSectionsList.forEach(sec=>{
                                const id = sec.id;
                                if (visibleIds.includes(id)) return;
                                if (headingEls[id]) return;
                                const dyn = sectionElemsMap[id];
                                const dynHeading = dyn ? dyn.querySelector('h3') : null;
                                if (dynHeading) dynHeading.textContent = resolveSectionName(id);
                            });
                        }
                    }catch(e){ console.warn('No se pudo reconstruir stepper/encabezados:', e); }

                    // Campos: visibilidad + requerido
                    for (const [key, selector] of Object.entries(FIELD_MAP)){
                        const input = view.querySelector(selector);
                        if (!input) continue;
                        const rule = getFieldRuleForType(key, type, defs);
                        let wrap = input.closest('div');
                        if (key==='codigoBarra'){ wrap = input.closest('#codigoBarraContent') || wrap; }
                        if (wrap){
                            if (rule.visible){ wrap.style.display = ''; wrap.classList.remove('hidden'); }
                            else { wrap.style.display = 'none'; }
                        }
                        // Requerido: usamos data-validation="obligatorio" si aplica
                        const isCheckbox = (input.type==='checkbox');
                        const isSelect = (input.tagName==='SELECT');
                        // Caso especial: hourlyRate solo si pricingModel === 'hourly'
                        if (key==='hourlyRate' && ((pricingModelSel?.value)||'fixed')!=='hourly'){
                            input.removeAttribute('data-validation');
                        } else if (rule.required){
                            input.setAttribute('data-validation','obligatorio');
                            const label = input.closest('div')?.querySelector('label');
                            if (label && !label.innerHTML.includes('text-red-500')){
                                label.innerHTML = label.innerHTML + ' <span class="text-red-500">*</span>';
                            }
                        } else {
                            if (input.getAttribute('data-validation')==='obligatorio') input.removeAttribute('data-validation');
                        }
                        // Para checkboxes, no cambiamos valor; solo reglas visuales
                        if (isCheckbox && !rule.visible){
                            // Si ocultamos el checkbox, también intentamos ocultar su contenedor de etiqueta si existe
                            const labWrap = input.closest('label')?.closest('div');
                            if (labWrap) labWrap.style.display = 'none';
                        }
                    }
                    // Reordenar campos dentro de Básicos según 'order' de definiciones
                    try{
                        const basicosSec = view.querySelector('#basicos');
                        const basicosGrid = basicosSec ? basicosSec.querySelector('.grid') : null;
                        if (basicosGrid){
                            const basicDefs = defs.filter(d=> d.group==='basicos' && d.archived!==true)
                                                  .sort((a,b)=> (a.order??9999)-(b.order??9999));
                            for (const d of basicDefs){
                                const sel = FIELD_MAP[d.key];
                                if (!sel) continue;
                                const el = view.querySelector(sel);
                                if (!el) continue;
                                // encontrar el contenedor inmediato que es hijo directo de la grid de básicos
                                let wrap = el;
                                if (d.key==='codigoBarra'){
                                    const cbWrap = el.closest('#codigoBarraContent');
                                    if (cbWrap) wrap = cbWrap;
                                }
                                while (wrap && wrap.parentElement && wrap.parentElement !== basicosGrid){
                                    wrap = wrap.parentElement;
                                }
                                if (wrap && wrap.parentElement === basicosGrid){
                                    basicosGrid.appendChild(wrap);
                                }
                            }
                        }
                    }catch(e){ console.warn('No se pudo reordenar Básicos:', e); }

                    // Reordenar campos en Logística
                    try{
                        const logSec = view.querySelector('#sectionLogistica');
                        const logGrid = logSec ? logSec.querySelector('.grid') : null;
                        if (logGrid){
                            const logDefs = defs.filter(d=> d.group==='logistica' && d.archived!==true)
                                                .sort((a,b)=> (a.order??9999)-(b.order??9999));
                            for (const d of logDefs){
                                const sel = FIELD_MAP[d.key]; if (!sel) continue;
                                const el = view.querySelector(sel); if (!el) continue;
                                let wrap = el;
                                while (wrap && wrap.parentElement && wrap.parentElement !== logGrid){ wrap = wrap.parentElement; }
                                if (wrap && wrap.parentElement === logGrid){ logGrid.appendChild(wrap); }
                            }
                        }
                    }catch(e){ console.warn('No se pudo reordenar Logística:', e); }

                    // Reordenar campos en Trazabilidad
                    try{
                        const trazSec = view.querySelector('#sectionTrazabilidad');
                        const trazGrid = trazSec ? trazSec.querySelector('.grid') : null;
                        if (trazGrid){
                            const trazDefs = defs.filter(d=> d.group==='trazabilidad' && d.archived!==true)
                                                 .sort((a,b)=> (a.order??9999)-(b.order??9999));
                            for (const d of trazDefs){
                                const sel = FIELD_MAP[d.key]; if (!sel) continue;
                                const el = view.querySelector(sel); if (!el) continue;
                                let wrap = el;
                                while (wrap && wrap.parentElement && wrap.parentElement !== trazGrid){ wrap = wrap.parentElement; }
                                if (wrap && wrap.parentElement === trazGrid){ trazGrid.appendChild(wrap); }
                            }
                        }
                    }catch(e){ console.warn('No se pudo reordenar Trazabilidad:', e); }

                    // Reordenar campo(s) en Categoría (si el editor los movió a la sección 'categoria')
                    try{
                        const catSec = view.querySelector('#sectionCategoria');
                        const catGrid = catSec ? catSec.querySelector('#categoriaSectionGrid') : null;
                        if (catGrid){
                            const catDefs = defs.filter(d=> d.group==='categoria' && d.archived!==true)
                                                .sort((a,b)=> (a.order??9999)-(b.order??9999));
                            for (const d of catDefs){
                                const sel = FIELD_MAP[d.key]; if (!sel) continue;
                                const el = view.querySelector(sel); if (!el) continue;
                                let wrap = el;
                                while (wrap && wrap.parentElement && wrap.parentElement !== catGrid){ wrap = wrap.parentElement; }
                                if (wrap && wrap.parentElement === catGrid){
                                    // Evitar mover si wrap contiene al grid destino (causa HierarchyRequestError)
                                    if (!(wrap.contains(catGrid))) catGrid.appendChild(wrap);
                                }
                                // Si aún está en otra sección (p.ej., Básicos), moverlo aquí
                                else if (wrap){ if (!(wrap.contains(catGrid))) catGrid.appendChild(wrap); }
                            }
                            // Fallback: si el campo 'categoria' sigue en Básicos, muévelo aquí aunque su group no se haya cambiado
                            const catField = view.querySelector('#categoriaItem');
                            if (catField){
                                // localizar su wrapper inmediato dentro del grid de básicos
                                const basicosGrid = view.querySelector('#basicos .grid');
                                let wrap = catField;
                                while (wrap && wrap.parentElement && wrap.parentElement !== basicosGrid && wrap.parentElement !== catGrid){ wrap = wrap.parentElement; }
                                if (wrap && wrap.parentElement === basicosGrid){ if (!(wrap.contains(catGrid))) catGrid.appendChild(wrap); }
                            }
                        }
                    }catch(e){ console.warn('No se pudo reordenar Categoría:', e); }

                    // Reordenar campos principales de Precios (top grid y fieldsets)
                    try{
                        const preciosSec = view.querySelector('#precios');
                        if (preciosSec){
                            const hasDynamicPriceContainers = (defs||[]).some(d=> d && d.fieldType==='container' && d.group==='precios' && d.archived!==true && (d.visible!==false));
                            if (!hasDynamicPriceContainers){
                                const preciosTopGrid = preciosSec.querySelector(':scope > .grid');
                                const fs1Grid = preciosSec.querySelector('fieldset:nth-of-type(1) .grid');
                                const fs2Grid = preciosSec.querySelector('fieldset:nth-of-type(2) .grid');
                                // Orden global dentro del grupo 'precios'
                                const precioDefs = defs.filter(d=> d.group==='precios' && d.archived!==true)
                                                    .sort((a,b)=> (a.order??9999)-(b.order??9999));
                                const topKeys = new Set(['pricingModel','hourlyRate']);
                                const fs1Keys = new Set(['costo','utilidad','precioVenta']);
                                const fs2Keys = new Set(['precioBase','diferencial','precioFinal']);
                                for (const d of precioDefs){
                                    const sel = FIELD_MAP[d.key]; if (!sel) continue;
                                    const el = view.querySelector(sel); if (!el) continue;
                                    let targetGrid = null;
                                    if (preciosTopGrid && topKeys.has(d.key)) targetGrid = preciosTopGrid;
                                    else if (fs1Grid && fs1Keys.has(d.key)) targetGrid = fs1Grid;
                                    else if (fs2Grid && fs2Keys.has(d.key)) targetGrid = fs2Grid;
                                    if (!targetGrid) continue; // otros campos (impuestos/ofertas) se mantienen
                                    let wrap = el;
                                    while (wrap && wrap.parentElement && wrap.parentElement !== targetGrid){ wrap = wrap.parentElement; }
                                    if (wrap && wrap.parentElement === targetGrid){ targetGrid.appendChild(wrap); }
                                }
                            } else {
                                // Si hay contenedores dinámicos, ocultar fieldsets para evitar duplicados
                                preciosSec?.querySelectorAll(':scope > fieldset')?.forEach(fs=> fs.style.display='none');
                            }
                        }
                    }catch(e){ console.warn('No se pudo reordenar Precios:', e); }
                    // Reordenar campos en secciones dinámicas creadas por el editor
                    try{
                        const dynamicIds = normalizedSectionsList
                            .map(s=> s.id)
                            .filter(id=> !['basicos','logistica','trazabilidad','precios','ofertas','multimedia','categoria','servicio','combo'].includes(id));
                        dynamicIds.forEach(secId=>{
                            const secEl = sectionElemsMap[secId] || view.querySelector(`[data-dynamic-section="${secId}"]`);
                            if (!secEl) return;
                            const grid = secEl.querySelector('.dynamic-section-grid') || secEl.querySelector('.grid');
                            if (!grid) return;
                            const defsForGroup = defs.filter(d=> d.group===secId && d.archived!==true)
                                .sort((a,b)=> (a.order??9999)-(b.order??9999));
                            defsForGroup.forEach(d=>{
                                const sel = FIELD_MAP[d.key]; if (!sel) return;
                                const el = view.querySelector(sel); if (!el) return;
                                let wrap = el;
                                while (wrap && wrap.parentElement && wrap.parentElement !== grid){ wrap = wrap.parentElement; }
                                if (wrap){ if (!(wrap.contains(grid))) grid.appendChild(wrap); }
                            });
                        });
                    }catch(e){ console.warn('No se pudo reordenar secciones dinámicas:', e); }
                    // Asegurar visibilidad de precios según modelo
                    updatePricingVisibility();
                    // Crear inputs para campos no mapeados (p.ej., color, codigoInterno) antes de mover/ordenar
                    try{
                        runtimeRenderUnmappedFields(defs, type);
                    }catch(e){ console.warn('runtimeRenderUnmappedFields', e); }
                    // Reubicar campos a su sección/grupo según definiciones (p.ej., Categoría → sección Categoría)
                    try{
                        runtimePlaceByGroup(defs);
                    }catch(e){ console.warn('runtimePlaceByGroup', e); }
                    // Ordenar campos dentro de cada sección según el orden definido en el editor
                    try{
                        runtimeSortFieldsWithinGroups(defs);
                    }catch(e){ console.warn('runtimeSortFieldsWithinGroups', e); }
                    // Orden específico dentro de Impuestos (solo hijos de #impuestosContent)
                    try{
                        runtimeSortImpuestos(defs);
                    }catch(e){ console.warn('runtimeSortImpuestos', e); }
                    // Limpiar por completo UI de Combo: ocultar buscador/tabla legados (mantener listas dinámicas nuevas)
                    try{
                        const comboSec = view.querySelector('#sectionCombo');
                        if (comboSec){
                            // Ocultar buscador/tabla/hints legados (siempre)
                            const legacySearchWrap = comboSec.querySelector('.relative');
                            const legacyTable = comboSec.querySelector('.border.rounded-md');
                            const legacyHints = comboSec.querySelectorAll('p.text-[11px], #comboSearchModeHint, #comboIndexHint');
                            if (legacySearchWrap) legacySearchWrap.style.display='none';
                            if (legacyTable) legacyTable.style.display='none';
                            legacyHints.forEach(h=> h.style.display='none');
                        }
                    }catch(_){ }
                    
                    // Si existe un listWithSearch en la sección de servicio, ocultar UI legada de materiales
                    try{
                        const hasSvcList = Array.isArray(defs) && defs.some(d=> d.fieldType==='listWithSearch' && d.group==='servicio' && d.archived!==true);
                        if (hasSvcList){
                            const svcSec = view.querySelector('#serviceExtras');
                            if (svcSec){
                                // Ocultar buscador legado
                                const svcSearchInput = svcSec.querySelector('#svcMatSearch');
                                const legacySearchWrap = svcSearchInput ? svcSearchInput.closest('.relative') : null;
                                if (legacySearchWrap) legacySearchWrap.style.display='none';
                                // Ocultar tabla legada
                                const tableBody = svcSec.querySelector('#svcMatTableBody');
                                const tableWrap = tableBody ? tableBody.closest('.border') : null;
                                if (tableWrap) tableWrap.style.display='none';
                                // Ocultar hints legados si los hubiera
                                const hintMode = svcSec.querySelector('#svcMatSearchModeHint');
                                const hintIdx = svcSec.querySelector('#svcMatIndexHint');
                                if (hintMode) hintMode.style.display='none';
                                if (hintIdx) hintIdx.style.display='none';
                                // Ocultar encabezado legado de materiales
                                const legacyHeading = svcSec.querySelector('#svcLegacyHeading');
                                if (legacyHeading) legacyHeading.style.display='none';
                            }
                        }
                        // Si NO hay lista dinámica y el buscador legacy de servicio no está habilitado por funciones, ocultar UI legada
                        if (!hasSvcList && (typeof svcSearchFeatureEnabled!=='undefined') && svcSearchFeatureEnabled===false){
                            const svcSec = view.querySelector('#serviceExtras');
                            if (svcSec){
                                const svcSearchInput = svcSec.querySelector('#svcMatSearch');
                                const legacySearchWrap = svcSearchInput ? svcSearchInput.closest('.relative') : null;
                                if (legacySearchWrap) legacySearchWrap.style.display='none';
                                const tableBody = svcSec.querySelector('#svcMatTableBody');
                                const tableWrap = tableBody ? tableBody.closest('.border') : null;
                                if (tableWrap) tableWrap.style.display='none';
                                const hintMode = svcSec.querySelector('#svcMatSearchModeHint');
                                const hintIdx = svcSec.querySelector('#svcMatIndexHint');
                                if (hintMode) hintMode.style.display='none';
                                if (hintIdx) hintIdx.style.display='none';
                                // Ocultar encabezado legado de materiales
                                const legacyHeading = svcSec.querySelector('#svcLegacyHeading');
                                if (legacyHeading) legacyHeading.style.display='none';
                            }
                        }
                    }catch(_){ }
                    // Ya no se ocultan listas dinámicas en modo combo; solo UI legada.
                    // Reforzar anclados (p.ej., codigoBarra después de usaCodigoBarra)
                    try{
                        runtimeEnforceAnchors(defs);
                    }catch(e){ console.warn('runtimeEnforceAnchors', e); }
                    // Aplicar condiciones de dependencia campo→campo (visible/obligatorio)
                    applyConditionalFieldLogic(defs, type);
                }catch(e){ console.warn('applyPerTypeRules', e); }
            }

            // Reubicar campos anclados respecto a su padre dentro del contenedor de su sección
            function runtimePlaceByGroup(defs){
                if (!Array.isArray(defs) || !defs.length) return;
                const getContainerForGroup = (g)=>{
                    if (g==='basicos') return views['items'].querySelector('#basicos .grid');
                    if (g==='logistica') return views['items'].querySelector('#sectionLogistica .grid');
                    if (g==='trazabilidad') return views['items'].querySelector('#sectionTrazabilidad .grid');
                    if (g==='precios') return views['items'].querySelector('#precios .grid') || views['items'].querySelector('#precios');
                    if (g==='impuestos') return views['items'].querySelector('[data-section-target="impuestos"]') || views['items'].querySelector('#impuestosContent');
                    if (g==='categoria') return views['items'].querySelector('#sectionCategoria #categoriaSectionGrid') || views['items'].querySelector('[data-section-target="categoria"]');
                    if (g==='servicio') return views['items'].querySelector('#serviceExtras .grid') || views['items'].querySelector('#serviceExtras');
                    if (g==='combo') return views['items'].querySelector('#sectionCombo');
                    // Dinámicas: grid creado con data-section-target
                    return views['items'].querySelector(`[data-section-target="${g}"]`);
                };
                const FIELD_MAP_LOCAL = FIELD_MAP;
                const impuestosSectionExists = !!views['items'].querySelector('[data-dynamic-section="impuestos"]');
                const impuestosKeys = new Set(['esExento','tipoImpuesto','impuestoAsignado']);
                defs.forEach(d=>{
                    const key = d.key; const targetGroup = d.group||''; if (!key || !targetGroup) return;
                    // Si tenemos sección dinámica de impuestos, no mover sus hijos individuales; ya movimos el fieldset completo
                    if (targetGroup==='impuestos' && impuestosSectionExists && impuestosKeys.has(key)) return;
                    const selector = FIELD_MAP_LOCAL[key]; if (!selector) return;
                    const input = views['items'].querySelector(selector); if (!input) return;
                    const targetCont = getContainerForGroup(targetGroup); if (!targetCont) return;
                    // Encontrar wrapper actual (el bloque hijo directo del contenedor actual)
                    let wrap = input;
                    // Caso especial: codigoBarra está envuelto en un bloque propio
                    if (key==='codigoBarra'){
                        const cb = input.closest('#codigoBarraContent'); if (cb) wrap = cb;
                    }
                    // Subir hasta llegar a un hijo directo del contenedor actual o a un section
                    // Identificar contenedores válidos: grids dinámicas o #impuestosContent
                    const isContainer = (el)=> !!el && (el.id==='impuestosContent' || el.classList.contains('grid') || el.hasAttribute('data-section-target'));
                    let parent = wrap.parentElement;
                    while (parent && !isContainer(parent)){
                        wrap = parent; parent = wrap.parentElement;
                    }
                    if (!parent) return;
                    // Si ya está en el contenedor objetivo, no mover
                    if (wrap.parentElement === targetCont) return;
                    try{
                        targetCont.appendChild(wrap);
                    }catch(_){ /* no-op si DOM no permite mover */ }
                });
            }

            // Crear controles DOM para campos que existen en definiciones pero no tienen selector en FIELD_MAP
            function runtimeRenderUnmappedFields(defs, type){
                if (!Array.isArray(defs) || !defs.length) return;
                const getContainerForGroup = (g)=>{
                    if (g==='basicos') return views['items'].querySelector('#basicos .grid');
                    if (g==='logistica') return views['items'].querySelector('#sectionLogistica .grid');
                    if (g==='trazabilidad') return views['items'].querySelector('#sectionTrazabilidad .grid');
                    if (g==='precios') return views['items'].querySelector('#precios .grid') || views['items'].querySelector('#precios');
                    if (g==='impuestos') return views['items'].querySelector('#impuestosContent') || views['items'].querySelector('[data-section-target="impuestos"]');
                    if (g==='categoria') return views['items'].querySelector('#sectionCategoria #categoriaSectionGrid') || views['items'].querySelector('[data-section-target="categoria"]');
                    if (g==='servicio') return views['items'].querySelector('#serviceExtras .grid') || views['items'].querySelector('#serviceExtras');
                    if (g==='combo') return views['items'].querySelector('#sectionCombo');
                    return views['items'].querySelector(`[data-section-target="${g}"]`);
                };
                // 1) Crear contenedores dinámicos (definidos en el editor) antes de renderizar campos sueltos
                try{
                    const containerDefs = defs.filter(d=> d && d.fieldType==='container' && d.group && d.archived!==true && (d.visible!==false));
                    if (containerDefs.length){
                        if (!view._containersByKey) view._containersByKey = {};
                        if (!view._containerChildMap) view._containerChildMap = {};
                        containerDefs
                          .sort((a,b)=> ((a.order??9999)-(b.order??9999)) || String(a.key||'').localeCompare(String(b.key||'')))
                          .forEach(cd=>{
                              const parent = (cd.group==='precios') ? (views['items'].querySelector('#precios')||getContainerForGroup(cd.group)) : (getContainerForGroup(cd.group));
                              if (!parent) return;
                              const cont = document.createElement('div');
                              cont.className = 'border rounded-md p-4 dynamic-container';
                              cont.setAttribute('data-container-key', cd.key);
                              const title = document.createElement('h4');
                              title.className = 'text-md font-medium text-gray-700 px-2';
                              title.textContent = cd.label || cd.key;
                              const inner = document.createElement('div');
                              inner.className = 'grid grid-cols-1 md:grid-cols-3 gap-4 mt-2';
                              cont.appendChild(title); cont.appendChild(inner);
                              parent.appendChild(cont);
                              view._containersByKey[cd.key] = inner;
                              const children = Array.isArray(cd.children) ? cd.children : [];
                              children.forEach(k=>{ view._containerChildMap[k] = cd.key; });
                          });
                        // Si hay contenedor(es) en 'precios', ocultar fieldsets legados para evitar duplicados
                        const hasPriceContainers = containerDefs.some(cd=> cd.group==='precios');
                        if (hasPriceContainers){
                            const preciosSec = views['items'].querySelector('#precios');
                            preciosSec?.querySelectorAll(':scope > fieldset')?.forEach(fs=> fs.style.display='none');
                        }
                        // Mover campos existentes (ya mapeados) dentro de sus contenedores definidos
                        Object.entries(view._containerChildMap||{}).forEach(([childKey, parentKey])=>{
                            const sel = FIELD_MAP[childKey]; if (!sel) return;
                            const el = views['items'].querySelector(sel); if (!el) return;
                            const inner = view._containersByKey[parentKey]; if (!inner) return;
                            // Subir hasta un hijo directo del inner grid (o mover bloque inmediato)
                            let wrap = el; let p = wrap.parentElement;
                            while (p && p !== inner){ wrap = p; p = wrap.parentElement; }
                            try{ inner.appendChild(wrap); }catch(_){ }
                        });
                    }
                }catch(e){ console.warn('dynamic containers render/move failed', e); }
                defs.forEach(d=>{
                    const key = d.key; if (!key) return;
                    if ((d.archived===true)) return;
                    // chequear visibilidad por tipo base
                    const visibleByType = d.visibleByType && (typeof d.visibleByType[type] !== 'undefined') ? !!d.visibleByType[type] : (d.visible!==false);
                    if (!visibleByType) return; // no crear controles invisibles por tipo
                    if (FIELD_MAP[key]) return; // ya mapeado
                    const group = d.group || 'basicos';
                    // Si el campo está asignado como hijo de un contenedor dinámico, usar su grid interna
                    let container = null;
                    try{
                        const parentKey = (view._containerChildMap||{})[key];
                        if (parentKey && view._containersByKey && view._containersByKey[parentKey]){
                            container = view._containersByKey[parentKey];
                        }
                    }catch(_){ }
                    if (!container) container = getContainerForGroup(group);
                    if (!container) return;
                    // listWithSearch: renderiza buscador + lista anclada
                    if (d.fieldType==='listWithSearch'){
                        const searchId = `dyn_${key}_search`;
                        const listId = `dyn_${key}_list`;
                        if (views['items'].querySelector('#'+searchId)){
                            FIELD_MAP[key] = '#'+searchId; return;
                        }
                        const wrap = document.createElement('div');
                        wrap.className = 'dynamic-field-wrap';
                        const label = document.createElement('label');
                        label.className = 'block text-sm font-medium text-gray-700';
                        label.htmlFor = searchId; label.textContent = d.label || key;
                        const input = document.createElement('input');
                        input.type='text'; input.id=searchId;
                        input.className = 'form-input mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white';
                        // Envolver input para estirarlo hasta el borde visual
                        const inputEdge = document.createElement('div');
                        inputEdge.className = 'relative -mx-4 px-4';
                        inputEdge.appendChild(input);
                        const help = document.createElement('div');
                        help.className = 'text-[11px] text-gray-500 mt-1 flex items-center justify-between gap-2';
                        help.textContent = 'Escriba para buscar; Enter agrega a la lista.';
                        const listWrap = document.createElement('div');
                        listWrap.className = 'mt-2 -mx-4';
                        // Cabecera: en Servicio mostramos también Sustitución
                        const headCols = (group==='servicio')
                            ? `<th class=\"p-2 text-left\">Ítem<\/th><th class=\"p-2 text-center\">SKU<\/th><th class=\"p-2 text-center\">Cantidad<\/th><th class=\"p-2 text-center\">Sustitución<\/th><th class=\"p-2 text-center\">Acciones<\/th>`
                            : `<th class=\"p-2 text-left\">Ítem<\/th><th class=\"p-2 text-center\">SKU<\/th><th class=\"p-2 text-center\">Cantidad<\/th><th class=\"p-2 text-center\">Acciones<\/th>`;
                        listWrap.innerHTML = `<div class=\"px-4\"><table class=\"w-full text-sm\"><thead class=\"bg-gray-50\"><tr>${headCols}<\/tr><\/thead><tbody id=\"${listId}\"><\/tbody><\/table><\/div>`;
                        wrap.appendChild(label); wrap.appendChild(inputEdge); wrap.appendChild(help); wrap.appendChild(listWrap);
                        // Eliminar creación de status para una UI limpia (no crear dyn_*_status)
                        container.appendChild(wrap);
                        FIELD_MAP[key] = '#'+searchId;
                        // preparar almacenamiento
                        try{ if (!view._dynamicLists) view._dynamicLists = {}; if (!view._dynamicLists[key]) view._dynamicLists[key] = []; }catch(_){ }
                        // Forzar binding inmediato (opción A): adjuntar buscador por defecto al render
                        try{
                            const selector = '#'+searchId;
                            const already = Array.isArray(specialSearchBindings) && specialSearchBindings.some(b=> b && b.selector===selector);
                            if (!already){
                                const by = ['descripcion','sku','codigoBarra','marca','modelo'];
                                attachSearchForListField(key, selector, by, true);
                            }
                            // Sin botón de prueba ni leyendas de estado
                        }catch(_){ }
                        return;
                    }
                    // default: render básico según tipo
                    const dynId = `dyn_${key}`;
                    if (views['items'].querySelector('#'+dynId)){
                        FIELD_MAP[key] = '#'+dynId; return;
                    }
                    const wrap = document.createElement('div');
                    wrap.className = 'dynamic-field-wrap';
                    const label = document.createElement('label');
                    label.className = 'block text-sm font-medium text-gray-700';
                    label.htmlFor = dynId; label.textContent = d.label || key;
                    const input = document.createElement(d.fieldType==='select'? 'select' : (d.fieldType==='checkbox'? 'input' : 'input'));
                    input.id = dynId;
                    if (d.fieldType==='checkbox') input.type='checkbox';
                    else if (d.fieldType==='number') input.type='number';
                    else input.type='text';
                    input.className = 'form-input mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white';
                    wrap.appendChild(label); wrap.appendChild(input);
                    container.appendChild(wrap);
                    FIELD_MAP[key] = '#'+dynId;
                });
            }

            // Reordenar campos dentro de los contenedores de secciones según el 'order' de las definiciones
            function runtimeSortFieldsWithinGroups(defs){
                if (!Array.isArray(defs) || !defs.length) return;
                const containers = {
                    basicos: views['items'].querySelector('#basicos .grid'),
                    logistica: views['items'].querySelector('#sectionLogistica .grid'),
                    trazabilidad: views['items'].querySelector('#sectionTrazabilidad .grid'),
                    precios: views['items'].querySelector('#precios .grid') || views['items'].querySelector('#precios'),
                    categoria: views['items'].querySelector('#sectionCategoria #categoriaSectionGrid') || views['items'].querySelector('[data-section-target="categoria"]'),
                    servicio: views['items'].querySelector('#serviceExtras .grid') || views['items'].querySelector('#serviceExtras'),
                    combo: views['items'].querySelector('#sectionCombo')
                    // impuestos intencionalmente omitido para no romper la estructura del fieldset
                };
                const FIELD_MAP_LOCAL = FIELD_MAP;
                const byGroup = new Map();
                defs.forEach(d=>{
                    if (!d || !d.group) return;
                    if (!byGroup.has(d.group)) byGroup.set(d.group, []);
                    byGroup.get(d.group).push(d);
                });
                Object.entries(containers).forEach(([groupId, container])=>{
                    if (!container) return;
                    const list = (byGroup.get(groupId)||[])
                        .slice()
                        .sort((a,b)=> ((a.order??9999)-(b.order??9999)) || String(a.key||'').localeCompare(String(b.key||'')));
                    list.forEach(def=>{
                        const sel = FIELD_MAP_LOCAL[def.key]; if (!sel) return;
                        let el = views['items'].querySelector(sel); if (!el) return;
                        // Normalizar wrapper: para codigoBarra hay contenedor propio
                        if (def.key==='codigoBarra'){
                            const cb = el.closest('#codigoBarraContent'); if (cb) el = cb;
                        }
                        // Subir wrapper hasta ser hijo directo del container si aplica
                        let wrap = el;
                        let p = wrap.parentElement;
                        const isContainer = (node)=> !!node && (node===container);
                        while (p && !isContainer(p)){
                            wrap = p; p = wrap.parentElement;
                        }
                        if (!wrap || wrap.parentElement!==container) return;
                        try{ container.appendChild(wrap); }catch(_){ }
                    });
                });
            }

            // Reordenar exclusivamente los hijos del bloque de Impuestos según el order del editor
            function runtimeSortImpuestos(defs){
                if (!Array.isArray(defs) || !defs.length) return;
                const container = views['items'].querySelector('#impuestosContent');
                if (!container) return;
                const FIELD_MAP_LOCAL = FIELD_MAP;
                const ordered = defs
                    .filter(d=> d && d.group==='impuestos')
                    .slice()
                    .sort((a,b)=> ((a.order??9999)-(b.order??9999)) || String(a.key||'').localeCompare(String(b.key||'')));
                const seen = new Set();
                ordered.forEach(d=>{
                    const key = d.key;
                    if (!key || key==='esExento') return; // el toggle está fuera de #impuestosContent
                    const sel = FIELD_MAP_LOCAL[key]; if (!sel) return;
                    const el = views['items'].querySelector(sel); if (!el) return;
                    // Subir hasta dejar el wrapper como hijo directo de #impuestosContent
                    let wrap = el;
                    let p = wrap.parentElement;
                    while (p && p !== container){ wrap = p; p = wrap.parentElement; }
                    if (!p || p!==container) return;
                    if (seen.has(wrap)) return; seen.add(wrap);
                    try{ container.appendChild(wrap); }catch(_){ }
                });
            }

            // Reubicar campos anclados respecto a su padre dentro del contenedor de su sección
            function runtimeEnforceAnchors(defs){
                if (!Array.isArray(defs) || !defs.length) return;
                const byKey = new Map(defs.map(d=>[d.key, d]));
                const getGridForGroup = (g)=>{
                    if (g==='basicos') return views['items'].querySelector('#basicos .grid');
                    if (g==='logistica') return views['items'].querySelector('#sectionLogistica .grid');
                    if (g==='trazabilidad') return views['items'].querySelector('#sectionTrazabilidad .grid');
                    if (g==='precios') return views['items'].querySelector('#precios .grid');
                    if (g==='impuestos') return views['items'].querySelector('#impuestosContent') || views['items'].querySelector('[data-section-target="impuestos"]');
                    if (g==='categoria') return views['items'].querySelector('#sectionCategoria #categoriaSectionGrid');
                    return null;
                };
                const FIELD_MAP_LOCAL = FIELD_MAP; // acceso al mapa
                defs.forEach(d=>{
                    const anc = d.anchored; if (!anc || !anc.enabled || !anc.parentKey) return;
                    const parentDef = byKey.get(anc.parentKey); if (!parentDef) return;
                    // Deben pertenecer al mismo grupo/sección para reubicar
                    if ((parentDef.group||'') !== (d.group||'')) return;
                    const grid = getGridForGroup(d.group||''); if (!grid) return;
                    const childSel = FIELD_MAP_LOCAL[d.key]; const parentSel = FIELD_MAP_LOCAL[parentDef.key];
                    const childEl = views['items'].querySelector(childSel||'');
                    const parentEl = views['items'].querySelector(parentSel||'');
                    if (!childEl || !parentEl) return;
                    // Envoltorio del hijo y del padre dentro de la grid
                    let childWrap = childEl;
                    if (d.key==='codigoBarra'){ const cb = childEl.closest('#codigoBarraContent'); if (cb) childWrap = cb; }
                    while (childWrap && childWrap.parentElement && childWrap.parentElement !== grid){ childWrap = childWrap.parentElement; }
                    let parentWrap = parentEl;
                    while (parentWrap && parentWrap.parentElement && parentWrap.parentElement !== grid){ parentWrap = parentWrap.parentElement; }
                    if (!childWrap || !parentWrap || parentWrap.parentElement!==grid || childWrap.parentElement!==grid) return;
                    // Calcular posición deseada; simplificación: right/after => insertAfter; left/above => insertBefore
                    const pos = anc.position || 'after';
                    if (pos==='left' || pos==='above'){
                        if (childWrap.nextSibling !== parentWrap){ grid.insertBefore(childWrap, parentWrap); }
                    } else {
                        // after/right/below
                        if (parentWrap.nextSibling !== childWrap){
                            if (parentWrap.nextSibling){ grid.insertBefore(childWrap, parentWrap.nextSibling); }
                            else { grid.appendChild(childWrap); }
                        }
                    }
                });
            }

            // Motor simple de dependencias entre campos
            let depListenersBound = false;
            function applyConditionalFieldLogic(defs, type){
                try{
                    if (!Array.isArray(defs) || !defs.length) return;
                    // Construir índice de dependencias: controlador -> lista de dependientes
                    const depsByCtrl = new Map();
                    const byKey = new Map(defs.map(d=>[d.key, d]));
                    const addCtrlRef = (k, dep)=>{ if (!k) return; if (!depsByCtrl.has(k)) depsByCtrl.set(k, []); depsByCtrl.get(k).push(dep); };
                    defs.forEach(d=>{
                        // Legacy simple
                        if (d.visibleWhen && d.visibleWhen.fieldKey){ addCtrlRef(d.visibleWhen.fieldKey, { kind:'visible', dep:d }); }
                        if (d.requiredWhen && d.requiredWhen.fieldKey){ addCtrlRef(d.requiredWhen.fieldKey, { kind:'required', dep:d }); }
                        // Nuevas reglas múltiples
                        (Array.isArray(d.visibleWhenRules)? d.visibleWhenRules: []).forEach(r=> addCtrlRef(r.fieldKey, { kind:'visible', dep:d }));
                        (Array.isArray(d.requiredWhenRules)? d.requiredWhenRules: []).forEach(r=> addCtrlRef(r.fieldKey, { kind:'required', dep:d }));
                    });
                    // Funciones helpers
                    const parseBool = (v)=>{
                        if (typeof v==='boolean') return v; const s = String(v).trim().toLowerCase(); return (s==='true'||s==='1'||s==='si'||s==='sí');
                    };
                    const getRawVal = (el)=>{
                        if (!el) return '';
                        if (el.type==='checkbox') return el.checked ? 'true' : 'false';
                        return (el.value||'').trim();
                    };
                    const cmpNumericIfPossible = (a,b)=>{
                        const na = Number(a); const nb = Number(b);
                        if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
                        return String(a).localeCompare(String(b));
                    };
                    const evalRule = (ctrlEl, op, expected)=>{
                        if (!ctrlEl) return false;
                        const curr = getRawVal(ctrlEl);
                        switch(op){
                            case 'is_true': return parseBool(curr) === true;
                            case 'is_false': return parseBool(curr) === false;
                            case 'equals': return cmpNumericIfPossible(curr, expected) === 0;
                            case 'not_equals': return cmpNumericIfPossible(curr, expected) !== 0;
                            case 'contains': return String(curr).toLowerCase().includes(String(expected).toLowerCase());
                            case 'not_contains': return !String(curr).toLowerCase().includes(String(expected).toLowerCase());
                            case 'starts_with': return String(curr).toLowerCase().startsWith(String(expected).toLowerCase());
                            case 'ends_with': return String(curr).toLowerCase().endsWith(String(expected).toLowerCase());
                            case 'gt': return cmpNumericIfPossible(curr, expected) > 0;
                            case 'gte': return cmpNumericIfPossible(curr, expected) >= 0;
                            case 'lt': return cmpNumericIfPossible(curr, expected) < 0;
                            case 'lte': return cmpNumericIfPossible(curr, expected) <= 0;
                            case 'in_list': {
                                const parts = String(expected).split(',').map(s=> s.trim()).filter(Boolean);
                                if (!parts.length) return false;
                                // Si ambos son numéricos, comparar numéricamente; si no, por texto case-insensitive
                                const numCurr = Number(curr);
                                const currIsNum = !Number.isNaN(numCurr);
                                return parts.some(p=>{
                                    const np = Number(p);
                                    const pIsNum = !Number.isNaN(np);
                                    if (currIsNum && pIsNum) return numCurr === np;
                                    return String(curr).toLowerCase() === p.toLowerCase();
                                });
                            }
                            default: return false;
                        }
                    };
                    const evalRuleList = (rules, logic)=>{
                        if (!Array.isArray(rules) || rules.length===0) return null; // sin reglas
                        const isAnd = (logic||'AND')==='AND';
                        let acc = isAnd; // AND: empieza true; OR: empieza false
                        for (const r of rules){
                            const sel = FIELD_MAP[r.fieldKey]; const el = sel? view.querySelector(sel) : null;
                            const ok = evalRule(el, r.op||'equals', r.value||'');
                            if (isAnd){ acc = acc && ok; if (!acc) break; } else { acc = acc || ok; if (acc) break; }
                        }
                        return acc;
                    };
                    const applyForDependent = (depDef)=>{
                        const key = depDef.key;
                        const sel = FIELD_MAP[key]; if (!sel) return;
                        const input = view.querySelector(sel); if (!input) return;
                        let wrap = input.closest('div');
                        if (key==='codigoBarra'){ wrap = input.closest('#codigoBarraContent') || wrap; }
                        // Visibilidad base y requerido base según reglas por tipo
                        const baseRule = getFieldRuleForType(key, type, defs);
                        let finalVisible = baseRule.visible;
                        let finalRequired = baseRule.required;
                        // Legacy simple
                        if (depDef.visibleWhen && depDef.visibleWhen.fieldKey){
                            const ctrlSel = FIELD_MAP[depDef.visibleWhen.fieldKey];
                            const ctrlEl = ctrlSel ? view.querySelector(ctrlSel) : null;
                            const ok = evalRule(ctrlEl, 'equals', (typeof depDef.visibleWhen.equals==='undefined'?'true':depDef.visibleWhen.equals));
                            finalVisible = baseRule.visible && !!ok;
                        }
                        if (depDef.requiredWhen && depDef.requiredWhen.fieldKey){
                            const ctrlSel = FIELD_MAP[depDef.requiredWhen.fieldKey];
                            const ctrlEl = ctrlSel ? view.querySelector(ctrlSel) : null;
                            const ok = evalRule(ctrlEl, 'equals', (typeof depDef.requiredWhen.equals==='undefined'?'true':depDef.requiredWhen.equals));
                            finalRequired = !!ok;
                        }
                        // Nuevas reglas múltiples
                        const vRules = Array.isArray(depDef.visibleWhenRules)? depDef.visibleWhenRules : [];
                        if (vRules.length){
                            const ok = evalRuleList(vRules, depDef.visibleWhenLogic||'AND');
                            if (ok!==null){ finalVisible = baseRule.visible && !!ok; }
                        }
                        const rRules = Array.isArray(depDef.requiredWhenRules)? depDef.requiredWhenRules : [];
                        if (rRules.length){
                            const ok = evalRuleList(rRules, depDef.requiredWhenLogic||'AND');
                            if (ok!==null){ finalRequired = !!ok; }
                        }
                        if (wrap){ wrap.style.display = finalVisible ? '' : 'none'; if(finalVisible) wrap.classList.remove('hidden'); }
                        if (finalRequired){
                            input.setAttribute('data-validation','obligatorio');
                            const label = input.closest('div')?.querySelector('label');
                            if (label && !label.innerHTML.includes('text-red-500')){ label.innerHTML = label.innerHTML + ' <span class="text-red-500">*</span>'; }
                        } else {
                            if (input.getAttribute('data-validation')==='obligatorio') input.removeAttribute('data-validation');
                        }
                    };
                    const reevalForCtrl = (ctrlKey)=>{
                        const list = depsByCtrl.get(ctrlKey)||[]; list.forEach(({dep})=> applyForDependent(dep));
                    };
                    // Ligar listeners una sola vez por controlador
                    depsByCtrl.forEach((list, ctrlKey)=>{
                        const sel = FIELD_MAP[ctrlKey]; if (!sel) return;
                        const el = view.querySelector(sel); if (!el) return;
                        const handler = ()=> reevalForCtrl(ctrlKey);
                        el.addEventListener('change', handler);
                        el.addEventListener('input', handler);
                    });
                    // Primera evaluación
                    defs.forEach(d=>{
                        if (d.visibleWhen || d.requiredWhen){ applyForDependent(d); }
                        if ((Array.isArray(d.visibleWhenRules)&&d.visibleWhenRules.length) || (Array.isArray(d.requiredWhenRules)&&d.requiredWhenRules.length)){
                            applyForDependent(d);
                        }
                    });
                }catch(err){ console.warn('applyConditionalFieldLogic', err); }
            }

            // Exponer helpers al host para refrescar reglas desde el editor visual
            window.items_clearTypeConfigCache = ()=>{ try{ perTypeSectionsCache = {}; fieldDefsCache = null; fieldFunctionsCache = null; sectionDefsCache = null; }catch(_){ } };
            window.items_refreshPerTypeRules = ()=>{ try{ window.items_clearTypeConfigCache(); applyPerTypeRules(itemTypeSwitcher.value); attachSpecialFunctions(); }catch(_){ } };
            // Escucha a cambios desde el editor de secciones/campos para refrescar reglas en caliente
            window.addEventListener('message', (ev)=>{
                try{
                    if (ev && ev.data && ev.data.type === 'typeFieldConfigChanged'){
                        window.items_refreshPerTypeRules();
                    }
                }catch(_){ }
            });
            // También escuchar por BroadcastChannel para cambios desde el editor visual
            try{
                const cfgBroadcast = new BroadcastChannel('item_type_field_config');
                cfgBroadcast.onmessage = (ev)=>{
                    try{
                        if (ev && ev.data && ev.data.type === 'typeFieldConfigChanged'){
                            window.items_refreshPerTypeRules();
                        }
                    }catch(_){ }
                };
            }catch(_){ }

            // --- LÓGICA DE CAMBIO DE VISTA ---
            function updatePricingVisibility(){
                const type = itemTypeSwitcher.value;
                const pm = pricingModelSel?.value || 'fixed';
                const priceCalcFs = view.querySelector('#precios fieldset:nth-of-type(1)');
                const finalCalcFs = view.querySelector('#precios fieldset:nth-of-type(2)');
                if (type === 'servicio' && pm === 'hourly'){
                    if (priceCalcFs) priceCalcFs.style.display = 'none';
                    if (finalCalcFs) finalCalcFs.style.display = 'none';
                    if (hourlySection) hourlySection.classList.remove('hidden');
                } else {
                    if (priceCalcFs) priceCalcFs.style.display = '';
                    if (finalCalcFs) finalCalcFs.style.display = '';
                    if (hourlySection) hourlySection.classList.add('hidden');
                }
                if (type === 'producto'){
                    if (pricingModelSel){ pricingModelSel.value = 'fixed'; pricingModelSel.disabled = true; }
                } else {
                    if (pricingModelSel){ pricingModelSel.disabled = false; }
                }
            }

            itemTypeSwitcher.addEventListener('change', (e) => {
                const type = e.target.value;
                itemSimpleView.classList.add('hidden');
                itemComboView.classList.add('hidden');

                if (type === 'producto' || type === 'servicio' || type === 'combo') {
                    itemSimpleView.classList.remove('hidden');
                    // La visibilidad de secciones se gobierna por applyPerTypeRules() en base a Firestore
                    if (sectionCombo) sectionCombo.classList.toggle('hidden', type !== 'combo');
                    // Mostrar/ocultar campos básicos según tipo
                    const marcaWrap = view.querySelector('#marca')?.closest('div');
                    const modeloWrap = view.querySelector('#modelo')?.closest('div');
                    const skuWrap = view.querySelector('#sku')?.closest('div');
                    const cbContainer = view.querySelector('#chkUsaCodigoBarra')?.closest('div');
                    const cbContent = view.querySelector('#codigoBarraContent');
                    if (type === 'servicio'){
                        if (marcaWrap) marcaWrap.style.display = 'none';
                        if (modeloWrap) modeloWrap.style.display = 'none';
                        if (skuWrap) skuWrap.style.display = 'none';
                        if (cbContainer) cbContainer.style.display = 'none';
                        if (cbContent) cbContent.style.display = 'none';
                    } else if (type === 'producto') {
                        if (marcaWrap) marcaWrap.style.display = 'block';
                        if (modeloWrap) modeloWrap.style.display = 'block';
                        if (skuWrap) skuWrap.style.display = 'block';
                        if (cbContainer) cbContainer.style.display = 'block';
                        if (cbContent) cbContent.style.display = 'block';
                        // Limpiar componentes de servicio al volver a producto
                        serviceComponents = [];
                        if (svcMatTableBody) svcMatTableBody.innerHTML = '';
                    } else {
                        // combo: ocultar extras de servicio
                        // visibilidad gobernada por applyPerTypeRules
                    }
                }
                
                // En el nuevo diseño no hay acordeón; no se requiere abrir secciones.
                updatePricingVisibility();
                // Limpiar caches para evitar usar configuración antigua
                try { window.items_clearTypeConfigCache && window.items_clearTypeConfigCache(); } catch(_){ }
                // Aplicar reglas por tipo (secciones/campos)
                applyPerTypeRules(type);
                attachSpecialFunctions();
            });
            pricingModelSel?.addEventListener('change', updatePricingVisibility);
            // Aplicar reglas por tipo al iniciar
            applyPerTypeRules(itemTypeSwitcher.value);
            attachSpecialFunctions();

            // Refrescar reglas cuando la pestaña recupera el foco (por si se cambió la config en otra vista)
            document.addEventListener('visibilitychange', ()=>{
                try{
                    if (document.visibilityState === 'visible'){
                        window.items_clearTypeConfigCache && window.items_clearTypeConfigCache();
                        applyPerTypeRules(itemTypeSwitcher.value);
                        attachSpecialFunctions();
                    }
                }catch(_){ }
            });

            // Botón manual para refrescar secciones/reglas
            document.getElementById('btnRefreshSections')?.addEventListener('click', ()=>{
                try{
                    window.items_clearTypeConfigCache && window.items_clearTypeConfigCache();
                    applyPerTypeRules(itemTypeSwitcher.value);
                    attachSpecialFunctions();
                }catch(_){ }
            });

            // --- BÚSQUEDA Y GESTIÓN DE COMPONENTES DE SERVICIO ---
            // Plantillas de SLAs y Checklists (Firestore)
            const serviceSlaSel = view.querySelector('#serviceSLA');
            const serviceChkSel = view.querySelector('#serviceChecklists');
            const btnManageSLA = view.querySelector('#btnManageSLA');
            const btnManageChecklists = view.querySelector('#btnManageChecklists');
            async function ensureDefaultServiceTemplates(){
                try{
                    const slaSnap = await serviceSlaTemplatesCol.limit(1).get();
                    if (slaSnap.empty){
                        const baseSLAs = [
                            { code:'basico', name:'Básico (72h)', hours:72, visible:true, order:1 },
                            { code:'urgente', name:'Urgente (24h)', hours:24, visible:true, order:2 },
                            { code:'express', name:'Express (8h)', hours:8, visible:true, order:3 },
                            { code:'emergencia', name:'Emergencia (4h)', hours:4, visible:true, order:4 }
                        ];
                        for (const s of baseSLAs){ await serviceSlaTemplatesCol.add({ ...s, created_at: firebase.firestore.FieldValue.serverTimestamp() }); }
                    }
                }catch(e){ console.warn('ensureDefaultServiceTemplates SLAs', e); }
                try{
                    const chkSnap = await serviceChecklistTemplatesCol.limit(1).get();
                    if (chkSnap.empty){
                        const baseChk = [
                            { key:'diag_basico', title:'Diagnóstico básico', visible:true, order:1 },
                            { key:'instalacion_std', title:'Instalación estándar', visible:true, order:2 },
                            { key:'mantenimiento_prev', title:'Mantenimiento preventivo', visible:true, order:3 },
                            { key:'calibracion', title:'Calibración', visible:true, order:4 }
                        ];
                        for (const c of baseChk){ await serviceChecklistTemplatesCol.add({ ...c, created_at: firebase.firestore.FieldValue.serverTimestamp() }); }
                    }
                }catch(e){ console.warn('ensureDefaultServiceTemplates CHK', e); }
            }
            async function loadServiceSLAs(){
                try{
                    const curr = serviceSlaSel?.value || '';
                    const snap = await serviceSlaTemplatesCol.orderBy('order').get();
                    const rows = snap.docs.map(d=>({ id:d.id, ...d.data() })).filter(r=>r.visible!==false);
                    if (serviceSlaSel){
                        serviceSlaSel.innerHTML = '<option value="">Sin SLA</option>' + rows.map(r=>`<option value="${r.code}">${r.name}</option>`).join('');
                        if (curr) serviceSlaSel.value = curr;
                    }
                }catch(e){ console.warn('loadServiceSLAs', e); }
            }
            async function loadServiceChecklists(){
                try{
                    const selected = serviceChkSel ? Array.from(serviceChkSel.selectedOptions).map(o=>o.value) : [];
                    const snap = await serviceChecklistTemplatesCol.orderBy('order').get();
                    const rows = snap.docs.map(d=>({ id:d.id, ...d.data() })).filter(r=>r.visible!==false);
                    if (serviceChkSel){
                        serviceChkSel.innerHTML = rows.map(r=>`<option value="${r.key}">${r.title}</option>`).join('');
                        // Restaurar selección previa si existía
                        const vals = new Set(selected);
                        Array.from(serviceChkSel.options).forEach(o=> o.selected = vals.has(o.value));
                    }
                }catch(e){ console.warn('loadServiceChecklists', e); }
            }
            // Modal gestión SLAs
            btnManageSLA?.addEventListener('click', async ()=>{ await ensureDefaultServiceTemplates(); await loadSlaTable(); toggleModal('slaTemplatesModal', true); });
            btnManageChecklists?.addEventListener('click', async ()=>{ await ensureDefaultServiceTemplates(); await loadChecklistTable(); toggleModal('checklistTemplatesModal', true); });

            async function loadSlaTable(){
                try{
                    const snap = await serviceSlaTemplatesCol.orderBy('order').get();
                    const list = document.getElementById('slaList'); if (!list) return;
                    list.innerHTML = snap.docs.map(doc=>{
                        const r = { id:doc.id, ...doc.data() };
                        const eye = (r.visible===false)?'fa-eye-slash':'fa-eye';
                        return `<tr data-id="${r.id}"><td class="p-2">${r.name}</td><td class="p-2">${r.code||''}</td><td class="p-2 text-center">${r.hours||''}</td><td class="p-2 text-center"><button class="px-2 py-1 bg-gray-200 rounded toggle-vis"><i class="fa ${eye}"></i></button></td><td class="p-2 text-center"><button class="px-2 py-1 bg-red-500 text-white rounded del"><i class="fa fa-trash"></i></button></td></tr>`;
                    }).join('');
                }catch(e){ console.warn('loadSlaTable', e); }
            }
            async function loadChecklistTable(){
                try{
                    const snap = await serviceChecklistTemplatesCol.orderBy('order').get();
                    const list = document.getElementById('chkList'); if (!list) return;
                    list.innerHTML = snap.docs.map(doc=>{
                        const r = { id:doc.id, ...doc.data() };
                        const eye = (r.visible===false)?'fa-eye-slash':'fa-eye';
                        return `<tr data-id="${r.id}"><td class="p-2">${r.title}</td><td class="p-2">${r.key||''}</td><td class="p-2 text-center"><button class="px-2 py-1 bg-gray-200 rounded toggle-vis"><i class="fa ${eye}"></i></button></td><td class="p-2 text-center"><button class="px-2 py-1 bg-red-500 text-white rounded del"><i class="fa fa-trash"></i></button></td></tr>`;
                    }).join('');
                }catch(e){ console.warn('loadChecklistTable', e); }
            }
            document.getElementById('btnAddSla')?.addEventListener('click', async ()=>{
                const name = (document.getElementById('slaName')?.value||'').trim();
                const code = (document.getElementById('slaCode')?.value||'').trim();
                const hours = parseFloat(document.getElementById('slaHours')?.value||'');
                if (!name || !code || isNaN(hours)){ alert('Nombre, código y horas requeridos'); return; }
                await serviceSlaTemplatesCol.add({ name, code, hours, visible:true, order: Date.now(), created_at: firebase.firestore.FieldValue.serverTimestamp() });
                document.getElementById('slaName').value=''; document.getElementById('slaCode').value=''; document.getElementById('slaHours').value='';
                await Promise.all([loadSlaTable(), loadServiceSLAs()]);
            });
            document.getElementById('slaList')?.addEventListener('click', async (e)=>{
                const row = e.target.closest('tr[data-id]'); if (!row) return; const id = row.dataset.id;
                if (e.target.closest('.del')){ await serviceSlaTemplatesCol.doc(id).delete(); await Promise.all([loadSlaTable(), loadServiceSLAs()]); return; }
                if (e.target.closest('.toggle-vis')){ const d = await serviceSlaTemplatesCol.doc(id).get(); const vis = !(d.data()?.visible===false); await serviceSlaTemplatesCol.doc(id).update({ visible: !vis }); await Promise.all([loadSlaTable(), loadServiceSLAs()]); return; }
            });
            document.getElementById('btnAddChecklist')?.addEventListener('click', async ()=>{
                const title = (document.getElementById('chkTitle')?.value||'').trim();
                const key = (document.getElementById('chkKey')?.value||'').trim();
                if (!title || !key){ alert('Título y clave requeridos'); return; }
                await serviceChecklistTemplatesCol.add({ title, key, visible:true, order: Date.now(), created_at: firebase.firestore.FieldValue.serverTimestamp() });
                document.getElementById('chkTitle').value=''; document.getElementById('chkKey').value='';
                await Promise.all([loadChecklistTable(), loadServiceChecklists()]);
            });
            document.getElementById('chkList')?.addEventListener('click', async (e)=>{
                const row = e.target.closest('tr[data-id]'); if (!row) return; const id = row.dataset.id;
                if (e.target.closest('.del')){ await serviceChecklistTemplatesCol.doc(id).delete(); await Promise.all([loadChecklistTable(), loadServiceChecklists()]); return; }
                if (e.target.closest('.toggle-vis')){ const d = await serviceChecklistTemplatesCol.doc(id).get(); const vis = !(d.data()?.visible===false); await serviceChecklistTemplatesCol.doc(id).update({ visible: !vis }); await Promise.all([loadChecklistTable(), loadServiceChecklists()]); return; }
            });

            // Inicializar plantillas de servicio y cargar selects
            ensureDefaultServiceTemplates().then(()=> Promise.all([loadServiceSLAs(), loadServiceChecklists()]));

            function renderServiceComponents(){
                if (!svcMatTableBody) return;
                svcMatTableBody.innerHTML = serviceComponents.map((c,idx)=>`
                    <tr data-idx="${idx}" class="border-t">
                        <td class="p-2">${c.descripcion||''}</td>
                        <td class="p-2">${c.sku||''}</td>
                        <td class="p-2 text-center"><input type="number" min="1" step="1" value="${Math.max(1, parseInt(c.qty)||1)}" class="w-24 border rounded px-1 py-0.5 text-right qty-input"></td>
                        <td class="p-2 text-center"><input type="checkbox" class="sub-chk" ${c.allowSubstitution!==false? 'checked':''}></td>
                        <td class="p-2 text-center"><button class="px-2 py-1 bg-red-500 text-white rounded del-comp"><i class="fa fa-trash"></i></button></td>
                    </tr>
                `).join('');
            }

            let svcSearchTimer = null; let svcResults = []; let svcHi = -1;
            function svcHideSuggestions(){ if (svcMatSuggestions) svcMatSuggestions.classList.add('hidden'); }
            function svcRenderSuggestions(items){
                if (!svcMatSuggestions) return;
                if (!items || !items.length){ svcHideSuggestions(); return; }
                svcMatSuggestions.innerHTML = items.map((it, i)=>`<div class="px-3 py-2 cursor-pointer hover:bg-cyan-50 ${i===svcHi? 'bg-cyan-50':''}" data-idx="${i}">
                    <div class="text-sm text-gray-800">${it.data.descripcion||''}</div>
                    <div class="text-xs text-gray-500">SKU: ${it.data.sku||''}</div>
                </div>`).join('');
                svcMatSuggestions.classList.remove('hidden');
            }
            function svcDebounce(fn, ms){ return (...a)=>{ clearTimeout(svcSearchTimer); svcSearchTimer=setTimeout(()=>fn(...a), ms); }; }
            async function svcSearch(term){
                const q = (term||'').trim(); if (q.length<1){ svcHideSuggestions(); return; }
                try{
                    await ensureFirebaseAuth();
                    const reqs = [];
                    const fields = Array.isArray(svcSearchBy)? svcSearchBy : ['descripcion','sku'];
                    fields.forEach(f=>{
                        if (f==='descripcion' || f==='sku' || f==='marca' || f==='modelo'){
                            reqs.push(itemsCol.where('tipo','==','producto').orderBy(f).startAt(q).endAt(q+'\uf8ff').limit(5).get());
                        } else if (f==='codigoBarra'){
                            reqs.push(itemsCol.where('tipo','==','producto').orderBy('codigoBarra').startAt(q).endAt(q+'\uf8ff').limit(5).get());
                        }
                    });
                    const settled = await Promise.allSettled(reqs);
                    let rows=[]; settled.forEach(s=>{ if (s.status==='fulfilled'){ rows = rows.concat(s.value.docs.map(d=>({id:d.id,data:d.data()}))); }});
                    const seen=new Set(); svcResults=rows.filter(r=>{ if(seen.has(r.id)) return false; seen.add(r.id); return true; }).slice(0,8);
                    svcHi = -1; svcRenderSuggestions(svcResults);
                }catch(e){
                    console.warn('svcSearch error', e);
                    svcHideSuggestions();
            const hint = view.querySelector('#svcMatIndexHint');
            if (hint && (''+(e.code||e.message||'')).includes('FAILED_PRECONDITION')){ hint.classList.remove('hidden'); }
                }
            }
            svcMatSearch?.addEventListener('input', svcDebounce((e)=>{ if (!svcSearchFeatureEnabled){ /* bloqueado por config */ console.debug('[svcSearch] bloqueado (feature OFF)'); svcHideSuggestions(); return; } svcSearch(e.target.value); }, 200));
            svcMatSuggestions?.addEventListener('mousedown', (e)=>{
                if (!svcSearchFeatureEnabled) return;
                if (view._svcOnSelectAddEnabled===false) return;
                const el = e.target.closest('[data-idx]'); if (!el) return; const idx = parseInt(el.dataset.idx,10); if (isNaN(idx)) return;
                const it = svcResults[idx]; if (!it) return;
                if (!serviceComponents.some(c=>c.itemId===it.id)){
                    serviceComponents.push({ itemId: it.id, descripcion: it.data.descripcion||'', sku: it.data.sku||'', qty: 1, allowSubstitution: true });
                }
                renderServiceComponents(); svcMatSearch.value=''; svcHideSuggestions();
            });
            svcMatSearch?.addEventListener('keydown', (e)=>{
                if (!svcSearchFeatureEnabled) return;
                if (svcMatSuggestions && !svcMatSuggestions.classList.contains('hidden')){
                    if (e.key==='ArrowDown'){ e.preventDefault(); if (svcResults.length){ svcHi = (svcHi+1)%svcResults.length; svcRenderSuggestions(svcResults); } return; }
                    if (e.key==='ArrowUp'){ e.preventDefault(); if (svcResults.length){ svcHi = (svcHi-1+svcResults.length)%svcResults.length; svcRenderSuggestions(svcResults); } return; }
                }
                if (e.key==='Enter'){
                    e.preventDefault();
                    if (view._svcOnSelectAddEnabled===false) { svcHideSuggestions(); return; }
                    let pick = null;
                    if (svcHi>=0 && svcResults[svcHi]) pick = svcResults[svcHi];
                    else {
                        const val = (svcMatSearch.value||'').trim().toLowerCase();
                        const exact = svcResults.find(r=> {
                            const checks = [];
                            if (svcSearchBy.includes('descripcion')) checks.push((r.data.descripcion||'').toLowerCase());
                            if (svcSearchBy.includes('sku')) checks.push((r.data.sku||'').toLowerCase());
                            if (svcSearchBy.includes('codigoBarra')) checks.push((r.data.codigoBarra||'').toLowerCase());
                            if (svcSearchBy.includes('marca')) checks.push((r.data.marca||'').toLowerCase());
                            if (svcSearchBy.includes('modelo')) checks.push((r.data.modelo||'').toLowerCase());
                            return checks.some(c=> c===val);
                        });
                        pick = exact || svcResults[0];
                    }
                    if (pick){
                        if (!serviceComponents.some(c=>c.itemId===pick.id)){
                            serviceComponents.push({ itemId: pick.id, descripcion: pick.data.descripcion||'', sku: pick.data.sku||'', qty: 1, allowSubstitution: true });
                            renderServiceComponents();
                        }
                        svcMatSearch.value=''; svcHideSuggestions(); svcHi=-1;
                    }
                }
            });
            svcMatSearch?.addEventListener('blur', ()=> setTimeout(svcHideSuggestions, 120));
            svcMatTableBody?.addEventListener('input', (e)=>{
                const row = e.target.closest('tr[data-idx]'); if (!row) return; const idx = parseInt(row.dataset.idx,10);
                if (e.target.classList.contains('qty-input')){
                    const v = parseInt(e.target.value||''); serviceComponents[idx].qty = isNaN(v)? 1 : Math.max(1, v);
                }
            });
            svcMatTableBody?.addEventListener('change', (e)=>{
                const row = e.target.closest('tr[data-idx]'); if (!row) return; const idx = parseInt(row.dataset.idx,10);
                if (e.target.classList.contains('sub-chk')){ serviceComponents[idx].allowSubstitution = !!e.target.checked; }
            });
            svcMatTableBody?.addEventListener('click', (e)=>{
                const row = e.target.closest('tr[data-idx]'); if (!row) return; const idx = parseInt(row.dataset.idx,10);
                if (e.target.closest('.del-comp')){ serviceComponents.splice(idx,1); renderServiceComponents(); }
            });

            // --- BÚSQUEDA Y GESTIÓN DE COMPONENTES DE COMBOS ---
            function renderComboComponents(){
                if (!comboTableBody) return;
                comboTableBody.innerHTML = comboComponents.map((c,idx)=>`
                    <tr data-idx="${idx}" class="border-t">
                        <td class="p-2">${c.descripcion||''}</td>
                        <td class="p-2">${c.sku||''}</td>
                        <td class="p-2 text-center"><input type="number" min="1" step="1" value="${Math.max(1, parseInt(c.qty)||1)}" class="w-24 border rounded px-1 py-0.5 text-right qty-input"></td>
                        <td class="p-2 text-center"><button class="px-2 py-1 bg-red-500 text-white rounded del-comp"><i class="fa fa-trash"></i></button></td>
                    </tr>
                `).join('');
            }
            let comboSearchTimer = null; let comboResults = []; let comboHi = -1;
            function comboHideSuggestions(){ if (comboSuggestions) comboSuggestions.classList.add('hidden'); }
            function comboRenderSuggestions(items){
                if (!comboSuggestions) return;
                if (!items || !items.length){ comboHideSuggestions(); return; }
                comboSuggestions.innerHTML = items.map((it, i)=>`<div class="px-3 py-2 cursor-pointer hover:bg-cyan-50 ${i===comboHi? 'bg-cyan-50':''}" data-idx="${i}">
                    <div class="text-sm text-gray-800">${it.data.descripcion||''} ${(it.data.tipo? `<span class=\"ml-1 text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-600\">${it.data.tipo}</span>`:'')}</div>
                    <div class="text-xs text-gray-500">SKU: ${it.data.sku||''}</div>
                </div>`).join('');
                comboSuggestions.classList.remove('hidden');
            }
            function comboDebounce(fn, ms){ return (...a)=>{ clearTimeout(comboSearchTimer); comboSearchTimer=setTimeout(()=>fn(...a), ms); }; }
            async function comboSearchItems(term){
                const q = (term||'').trim(); if (q.length<1){ comboHideSuggestions(); return; }
                try{
                    await ensureFirebaseAuth();
                    const reqs = [];
                    const fields = Array.isArray(comboSearchBy)? comboSearchBy : ['descripcion','sku'];
                    fields.forEach(f=>{
                        if (f==='descripcion' || f==='sku' || f==='marca' || f==='modelo'){
                            reqs.push(itemsCol.where('tipo','==','producto').orderBy(f).startAt(q).endAt(q+'\uf8ff').limit(5).get());
                            // marca/modelo no aplican a servicios típicamente; sólo descripcion/sku para servicios
                            if (f==='descripcion' || f==='sku'){
                                reqs.push(itemsCol.where('tipo','==','servicio').orderBy(f).startAt(q).endAt(q+'\uf8ff').limit(5).get());
                            }
                        } else if (f==='codigoBarra'){
                            // Solo productos suelen tener código de barra
                            reqs.push(itemsCol.where('tipo','==','producto').orderBy('codigoBarra').startAt(q).endAt(q+'\uf8ff').limit(5).get());
                        }
                    });
                    const settled = await Promise.allSettled(reqs);
                    let rows = [];
                    for (const s of settled){ if (s.status==='fulfilled'){ rows = rows.concat(s.value.docs.map(d=>({id:d.id,data:d.data()}))); } }
                    const seen = new Set();
                    comboResults = rows.filter(r=>{
                        if (r.data.tipo==='combo') return false; // no combos dentro de combos
                        if (editingItemId && r.id===editingItemId) return false; // no agregarse a sí mismo
                        if (seen.has(r.id)) return false; seen.add(r.id); return true;
                    }).slice(0, 10);
                    comboHi = -1; comboRenderSuggestions(comboResults);
                }catch(e){
                    console.warn('comboSearchItems error', e);
                    comboHideSuggestions();
            const hint = view.querySelector('#comboIndexHint');
            if (hint && (''+(e.code||e.message||'')).includes('FAILED_PRECONDITION')){ hint.classList.remove('hidden'); }
                }
            }
            // Silenciar logs y no mostrar sugerencias cuando la feature está OFF
            comboSearch?.addEventListener('input', comboDebounce((e)=>{ if (!comboSearchFeatureEnabled){ comboHideSuggestions(); return; } comboSearchItems(e.target.value); }, 200));
            comboSuggestions?.addEventListener('mousedown', (e)=>{
                if (!comboSearchFeatureEnabled) return;
                if (view._comboOnSelectAddEnabled===false) return;
                const el = e.target.closest('[data-idx]'); if (!el) return; const idx = parseInt(el.dataset.idx,10); if (isNaN(idx)) return;
                const it = comboResults[idx]; if (!it) return;
                // evitar duplicados por itemId
                if (!comboComponents.some(c=>c.itemId===it.id)){
                    comboComponents.push({ itemId: it.id, descripcion: it.data.descripcion||'', sku: it.data.sku||'', qty: 1 });
                    renderComboComponents();
                }
                comboSearch.value=''; comboHideSuggestions();
            });
            comboSearch?.addEventListener('keydown', (e)=>{
                if (!comboSearchFeatureEnabled) return;
                if (comboSuggestions && !comboSuggestions.classList.contains('hidden')){
                    if (e.key==='ArrowDown'){ e.preventDefault(); if (comboResults.length){ comboHi = (comboHi+1)%comboResults.length; comboRenderSuggestions(comboResults); } return; }
                    if (e.key==='ArrowUp'){ e.preventDefault(); if (comboResults.length){ comboHi = (comboHi-1+comboResults.length)%comboResults.length; comboRenderSuggestions(comboResults); } return; }
                }
                if (e.key==='Enter'){
                    e.preventDefault();
                    if (view._comboOnSelectAddEnabled===false) { comboHideSuggestions(); return; }
                    let pick = null;
                    if (comboHi>=0 && comboResults[comboHi]) pick = comboResults[comboHi];
                    else {
                        const val = (comboSearch.value||'').trim().toLowerCase();
                        const exact = comboResults.find(r=> {
                            const checks = [];
                            if (comboSearchBy.includes('descripcion')) checks.push((r.data.descripcion||'').toLowerCase());
                            if (comboSearchBy.includes('sku')) checks.push((r.data.sku||'').toLowerCase());
                            if (comboSearchBy.includes('codigoBarra')) checks.push((r.data.codigoBarra||'').toLowerCase());
                            if (comboSearchBy.includes('marca')) checks.push((r.data.marca||'').toLowerCase());
                            if (comboSearchBy.includes('modelo')) checks.push((r.data.modelo||'').toLowerCase());
                            return checks.some(c=> c===val);
                        });
                        pick = exact || comboResults[0];
                    }
                    if (pick){
                        if (!comboComponents.some(c=>c.itemId===pick.id)){
                            comboComponents.push({ itemId: pick.id, descripcion: pick.data.descripcion||'', sku: pick.data.sku||'', qty: 1 });
                            renderComboComponents();
                        }
                        comboSearch.value=''; comboHideSuggestions(); comboHi=-1;
                    }
                }
            });
            comboSearch?.addEventListener('blur', ()=> setTimeout(comboHideSuggestions, 120));
            comboTableBody?.addEventListener('input', (e)=>{
                const row = e.target.closest('tr[data-idx]'); if (!row) return; const idx = parseInt(row.dataset.idx,10);
                if (e.target.classList.contains('qty-input')){
                    const v = parseInt(e.target.value||''); comboComponents[idx].qty = isNaN(v)? 1 : Math.max(1, v);
                }
            });
            comboTableBody?.addEventListener('click', (e)=>{
                const row = e.target.closest('tr[data-idx]'); if (!row) return; const idx = parseInt(row.dataset.idx,10);
                if (e.target.closest('.del-comp')){ comboComponents.splice(idx,1); renderComboComponents(); }
            });

            // === TAXONOMÍA DE INVENTARIO: CATEGORÍAS Y ATRIBUTOS ===
            // Cargar categorías
            async function loadCategoriesOptions(selectedId){
                try{
                    const snap = await invCatCol.orderBy('name').get();
                    const cats = snap.docs.map(d=>({ id:d.id, ...d.data() }));
                    categoriaItemSel.innerHTML = '<option value="">Sin categoría</option>' + cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                    if (selectedId){ categoriaItemSel.value = selectedId; }
                }catch(e){ console.warn('No se pudieron cargar categorías', e); }
            }

            // Renderizar campos según categoría
            async function renderTaxonomyFields(categoryId, existingValues){
                // Asegurar que el contenedor quede inmediatamente debajo del selector de categoría
                try{
                    if (categoriaItemSel && taxonomyContainer){
                        const p = categoriaItemSel.parentNode;
                        if (p && taxonomyContainer.previousElementSibling !== categoriaItemSel){
                            p.insertBefore(taxonomyContainer, categoriaItemSel.nextSibling);
                        }
                        taxonomyContainer.classList.remove('mt-4');
                        if (!taxonomyContainer.classList.contains('mt-2')) taxonomyContainer.classList.add('mt-2');
                        taxonomyContainer.style.marginTop = '0.5rem';
                    }
                }catch(_){ /* noop */ }
                taxonomyContainer.innerHTML = '';
                if (!categoryId) return;
                try{
                    const catDoc = await invCatCol.doc(categoryId).get();
                    if (!catDoc.exists) return;
                    const cat = catDoc.data();
                    const attrs = Array.isArray(cat.attributes) ? cat.attributes : [];
                    if (!attrs.length){
                        taxonomyContainer.innerHTML = '<div class="text-sm text-gray-500">Esta categoría no tiene atributos configurados.</div>';
                        return;
                    }
                    // Obtener definiciones de atributos
                    const ids = attrs.map(a=>a.attribute_id).filter(Boolean);
                    let defsMap = {};
                    if (ids.length){
                        const chunks = (arr, size)=> arr.length? [arr.slice(0,size), ...chunks(arr.slice(size), size)] : [];
                        const batches = chunks(ids, 10);
                        const docs = [];
                        for (const b of batches){
                            const snap = await invAttrCol.where(firebase.firestore.FieldPath.documentId(), 'in', b).get();
                            snap.docs.forEach(d=> docs.push({ id:d.id, ...d.data() }));
                        }
                        defsMap = docs.reduce((acc,a)=>{ acc[a.id]=a; return acc; },{});
                    }
                    // Ordenar por order definido en categoría
                    const ordered = attrs.slice().sort((a,b)=> (a.order||0)-(b.order||0));
                    taxonomyContainer.innerHTML = ordered.map((cfg, idx)=>{
                        const def = defsMap[cfg.attribute_id] || { name: cfg.label||('Atributo '+(idx+1)), type: cfg.type||'text' };
                        const fid = 'tax_'+cfg.attribute_id;
                        const label = def.name || cfg.label || ('Atributo '+(idx+1));
                        const required = (cfg.required===true) || (def.required===true);
                        // Render según tipo
                        if (def.type==='text'){
                            const v = existingValues?.[cfg.attribute_id]?.value || '';
                            return `<div><label class="block text-sm font-medium text-gray-700">${label}${required? ' <span class=\"text-red-500\">*</span>':''}</label><input type="text" id="${fid}" data-attr-id="${cfg.attribute_id}" data-type="text" data-label="${label.replace(/\"/g,'&quot;')}" data-required="${required? '1':'0'}" class="form-input mt-1 block w-full p-2 border rounded" value="${(v||'').toString().replace(/\"/g,'&quot;')}"></div>`;
                        }
                        if (def.type==='number'){
                            const v = existingValues?.[cfg.attribute_id]?.value;
                            return `<div><label class="block text-sm font-medium text-gray-700">${label}${required? ' <span class=\"text-red-500\">*</span>':''}</label><input type="number" id="${fid}" data-attr-id="${cfg.attribute_id}" data-type="number" data-label="${label.replace(/\"/g,'&quot;')}" data-required="${required? '1':'0'}" class="form-input mt-1 block w-full p-2 border rounded" value="${(typeof v==='number'? v : '')}"></div>`;
                        }
                        if (def.type==='select'){
                            const opts = Array.isArray(def.options)? def.options : [];
                            const multiple = !!def.multiple;
                            const v = existingValues?.[cfg.attribute_id]?.value;
                            const selected = multiple ? (Array.isArray(v)? v : []) : (v||'');
                            const selAttr = multiple ? ' multiple size="'+Math.min(6, opts.length)+'"' : '';
                            const optionsHtml = opts.map(o=>{
                                const isSel = multiple ? selected.includes(o.value) : (selected===o.value);
                                return `<option value="${o.value}" ${isSel? 'selected':''}>${o.label||o.value}</option>`;
                            }).join('');
                            return `<div><label class="block text-sm font-medium text-gray-700">${label}${required? ' <span class=\"text-red-500\">*</span>':''}</label><select id="${fid}" data-attr-id="${cfg.attribute_id}" data-type="select" data-multiple="${multiple? '1':'0'}" data-label="${label.replace(/\"/g,'&quot;')}" data-required="${required? '1':'0'}" class="form-input mt-1 block w-full p-2 border rounded bg-white"${selAttr}><option value="" ${multiple? 'disabled':''}>${multiple? '— Seleccione —':'Seleccione…'}</option>${optionsHtml}</select></div>`;
                        }
                        if (def.type==='boolean'){
                            const v = !!(existingValues?.[cfg.attribute_id]?.value);
                            return `<div class="flex items-center gap-2"><input type="checkbox" id="${fid}" data-attr-id="${cfg.attribute_id}" data-type="boolean" data-label="${label.replace(/\"/g,'&quot;')}" data-required="${required? '1':'0'}" class="h-5 w-5 text-cyan-600 border-gray-300 rounded" ${v? 'checked':''}><label for="${fid}" class="text-sm font-medium text-gray-700">${label}${required? ' <span class=\"text-red-500\">*</span>':''}</label></div>`;
                        }
                        if (def.type==='media'){
                            const items = Array.isArray(existingValues?.[cfg.attribute_id]?.value) ? existingValues[cfg.attribute_id].value : [];
                            const listId = fid+'-list';
                            return `<div><label class="block text-sm font-medium text-gray-700">${label}${required? ' <span class=\"text-red-500\">*</span>':''}</label>
                                <div class="flex gap-2 mt-1"><input type="file" accept="image/*" capture id="${fid}-img" class="hidden"><button type="button" class="px-2 py-1 bg-gray-200 rounded" data-addimg="${fid}"><i class="fa fa-camera"></i> Foto</button><button type="button" class="px-2 py-1 bg-gray-200 rounded" data-addvideo="${fid}"><i class="fa fa-video"></i> Video (URL)</button></div>
                                <div id="${listId}" data-attr-id="${cfg.attribute_id}" data-type="media" data-label="${label.replace(/\"/g,'&quot;')}" data-required="${required? '1':'0'}" class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-2">${items.map((it,i)=> it.kind==='image'? `<div class=\"border rounded p-1 text-xs\"><img src=\"${it.url}\" class=\"w-full h-24 object-cover rounded\"><div class=\"mt-1 truncate\">${it.title||''}</div><button type=\"button\" class=\"mt-1 px-1.5 py-0.5 bg-red-500 text-white rounded\" data-del=\"${i}\" data-field=\"${fid}\">Quitar</button></div>` : `<div class=\"border rounded p-1 text-xs\"><div class=\"w-full h-24 bg-black/5 flex items-center justify-center rounded\"><i class=\"fa fa-video\"></i></div><div class=\"mt-1 truncate\">${it.url}</div><button type=\"button\" class=\"mt-1 px-1.5 py-0.5 bg-red-500 text-white rounded\" data-del=\"${i}\" data-field=\"${fid}\">Quitar</button></div>`).join('')}</div></div>`;
                        }
                        if (def.type==='document'){
                            const items = Array.isArray(existingValues?.[cfg.attribute_id]?.value) ? existingValues[cfg.attribute_id].value : [];
                            const listId = fid+'-list';
                            return `<div><label class=\"block text-sm font-medium text-gray-700\">${label}${required? ' <span class=\"text-red-500\">*</span>':''}</label>
                                <div class=\"flex gap-2 mt-1\">
                                    <input type=\"file\" accept=\".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,image/*\" id=\"${fid}-doc\" class=\"hidden\">
                                    <button type=\"button\" class=\"px-2 py-1 bg-gray-200 rounded\" data-adddocfile=\"${fid}\"><i class=\"fa fa-file-arrow-up\"></i> Archivo</button>
                                    <button type=\"button\" class=\"px-2 py-1 bg-gray-200 rounded\" data-adddocurl=\"${fid}\"><i class=\"fa fa-link\"></i> Enlace</button>
                                </div>
                                <div id=\"${listId}\" data-attr-id=\"${cfg.attribute_id}\" data-type=\"document\" data-label=\"${label.replace(/\\\"/g,'&quot;')}\" data-required=\"${required? '1':'0'}\" class=\"mt-2 space-y-1\">${items.map((it,i)=> `<div class=\\\"flex items-center justify-between border rounded p-1 text-xs\\\"><a href=\\\"${it.url}\\\" target=\\\"_blank\\\" class=\\\"text-cyan-700 underline truncate\\\">${it.name||it.url}</a><button type=\\\"button\\\" class=\\\"px-1.5 py-0.5 bg-red-500 text-white rounded\\\" data-del=\\\"${i}\\\" data-field=\\\"${fid}\\\">Quitar</button></div>`).join('')}</div></div>`;
                        }
                        // Fallback
                        const v = existingValues?.[cfg.attribute_id]?.value || '';
                        return `<div><label class="block text-sm font-medium text-gray-700">${label}</label><input type="text" id="${fid}" data-attr-id="${cfg.attribute_id}" data-type="text" data-label="${label.replace(/\"/g,'&quot;')}" data-required="${required? '1':'0'}" class="form-input mt-1 block w-full p-2 border rounded" value="${(v||'').toString().replace(/\"/g,'&quot;')}"></div>`;
                    }).join('');

                    // Event wiring for media/doc controls
                    taxonomyContainer.addEventListener('click', (e)=>{
                        const btnImg = e.target.closest('[data-addimg]');
                        const btnVid = e.target.closest('[data-addvideo]');
                        const btnDocUrl = e.target.closest('[data-adddocurl]');
                        const btnDocFile = e.target.closest('[data-adddocfile]');
                        const btnDel = e.target.closest('button[data-del]');
                        if (btnImg){ const id = btnImg.getAttribute('data-addimg'); const input = taxonomyContainer.querySelector('#'+id+'-img'); input?.click(); }
                        else if (btnVid){ const id = btnVid.getAttribute('data-addvideo'); const url = prompt('URL del video (YouTube/MP4)'); if (url){ const list = taxonomyContainer.querySelector('#'+id+'-list'); list?.insertAdjacentHTML('beforeend', `<div class=\"border rounded p-1 text-xs\"><div class=\"w-full h-24 bg-black/5 flex items-center justify-center rounded\"><i class=\"fa fa-video\"></i></div><div class=\"mt-1 truncate\">${url}</div><button type=\"button\" class=\"mt-1 px-1.5 py-0.5 bg-red-500 text-white rounded\" data-del=\"9999\" data-field=\"${id}\">Quitar</button></div>`); (list._vals = list._vals || []).push({kind:'video', url}); } }
                        else if (btnDocUrl){ const id = btnDocUrl.getAttribute('data-adddocurl'); const url = prompt('URL del documento (PDF/Doc)'); if (url){ const name = prompt('Nombre a mostrar', url) || url; const list = taxonomyContainer.querySelector('#'+id+'-list'); list?.insertAdjacentHTML('beforeend', `<div class=\"flex items-center justify-between border rounded p-1 text-xs\"><a href=\"${url}\" target=\"_blank\" class=\"text-cyan-700 underline truncate\">${name}</a><button type=\"button\" class=\"px-1.5 py-0.5 bg-red-500 text-white rounded\" data-del=\"9999\" data-field=\"${id}\">Quitar</button></div>`); (list._vals = list._vals || []).push({url, name}); } }
                        else if (btnDocFile){ const id = btnDocFile.getAttribute('data-adddocfile'); const input = taxonomyContainer.querySelector('#'+id+'-doc'); input?.click(); }
                        else if (btnDel){
                            const list = btnDel.closest('#'+btnDel.getAttribute('data-field')+'-list');
                            if (list){
                                const i = parseInt(btnDel.getAttribute('data-del'),10);
                                let removed = null;
                                if (!isNaN(i)){
                                    if (i === 9999){ removed = (list._vals = list._vals || []).pop(); }
                                    else { removed = (list._vals = list._vals || []).splice(i,1)[0]; }
                                }
                                // Intentar eliminar de Storage si corresponde (imágenes o documentos subidos)
                                if (removed && (removed.kind==='image' || removed.url)){
                                    (async ()=>{
                                        try{
                                            if (removed.path){ await storage.ref().child(removed.path).delete().catch(()=>{}); }
                                            else if (removed.url){ await storage.refFromURL(removed.url).delete().catch(()=>{}); }
                                        }catch(err){ console.warn('No se pudo borrar archivo de atributo en Storage:', err); }
                                    })();
                                }
                                btnDel.closest('div').remove();
                            }
                        }
                    });
                    taxonomyContainer.addEventListener('change', (e)=>{
                        if (e.target.type==='file' && e.target.id.endsWith('-img')){
                            const fid = e.target.id.replace(/-img$/,'');
                            const file = e.target.files && e.target.files[0]; if (!file) return;
                            const list = taxonomyContainer.querySelector('#'+fid+'-list');
                            const reader = new FileReader(); reader.onload = (ev)=>{
                                const dataUrl = ev.target.result;
                                list?.insertAdjacentHTML('beforeend', `<div class=\"border rounded p-1 text-xs\"><img src=\"${dataUrl}\" class=\"w-full h-24 object-cover rounded\"><div class=\"mt-1 text-[10px] text-gray-500\">Subiendo…</div><button type=\"button\" class=\"mt-1 px-1.5 py-0.5 bg-red-500 text-white rounded\" data-del=\"9999\" data-field=\"${fid}\">Quitar</button></div>`);
                            }; reader.readAsDataURL(file);
                            (async ()=>{
                                try{
                                    const up = await uploadFileToStorage(file, 'image');
                                    (list._vals = list._vals || []).push({ kind:'image', url: up.url, path: up.path });
                                }catch(err){ console.warn('Error subiendo imagen atributo:', err); }
                                e.target.value = '';
                            })();
                        } else if (e.target.type==='file' && e.target.id.endsWith('-doc')){
                            const fid = e.target.id.replace(/-doc$/,'');
                            const file = e.target.files && e.target.files[0]; if (!file) return;
                            const list = taxonomyContainer.querySelector('#'+fid+'-list');
                            list?.insertAdjacentHTML('beforeend', `<div class=\"flex items-center justify-between border rounded p-1 text-xs\"><span class=\"truncate max-w-[180px]\">${(file.name||'archivo')}</span><span class=\"text-[10px] text-gray-500\">Subiendo…</span></div>`);
                            (async ()=>{
                                try{
                                    const up = await uploadFileToStorage(file, 'doc');
                                    (list._vals = list._vals || []).push({ url: up.url, path: up.path, name: file.name||'documento' });
                                }catch(err){ console.warn('Error subiendo documento atributo:', err); }
                                e.target.value = '';
                            })();
                        }
                    });
                }catch(e){ console.warn('No se pudieron renderizar atributos:', e); }
            }

            categoriaItemSel.addEventListener('change', ()=> renderTaxonomyFields(categoriaItemSel.value));
            loadCategoriesOptions();

            async function collectTaxonomyValues(categoryId){
                const catDoc = await invCatCol.doc(categoryId).get();
                const cat = catDoc.exists ? catDoc.data() : { name:'', attributes:[] };
                const attrs = Array.isArray(cat.attributes) ? cat.attributes : [];
                const result = { category_id: categoryId, category_name: cat.name||'', attributes: {} };
                for (const cfg of attrs){
                    const attrId = cfg.attribute_id;
                    const input = taxonomyContainer.querySelector(`[data-attr-id="${attrId}"]`);
                    if (!input) continue;
                    const type = input.getAttribute('data-type') || 'text';
                    const label = input.getAttribute('data-label') || 'Atributo';
                    const required = input.getAttribute('data-required') === '1';
                    let value = null; let display = null;
                    if (type==='text') value = input.value || '';
                    else if (type==='number') value = input.value!=='' ? parseFloat(input.value) : null;
                    else if (type==='select'){
                        const multiple = input.getAttribute('data-multiple') === '1';
                        if (multiple){
                            const sel = Array.from(input.selectedOptions).map(o=>o.value).filter(v=>v!=='');
                            value = sel;
                            display = Array.from(input.selectedOptions).map(o=>o.textContent);
                        } else {
                            value = input.value || '';
                            const opt = input.selectedOptions[0];
                            display = opt ? opt.textContent : '';
                        }
                    }
                    else if (type==='boolean') value = !!input.checked, display = value ? 'Sí' : 'No';
                    else if (type==='media'){
                        const list = taxonomyContainer.querySelector(`#tax_${attrId}-list`);
                        const arr = (list && list._vals) ? list._vals : [];
                        value = arr.slice();
                    }
                    else if (type==='document'){
                        const list = taxonomyContainer.querySelector(`#tax_${attrId}-list`);
                        const arr = (list && list._vals) ? list._vals : [];
                        value = arr.slice();
                    }
                    result.attributes[attrId] = { label, type, value, display, required };
                }
                return result;
            }

            // --- LÓGICA DE PRECIOS ---
            const [costo, utilidad, precioVenta, precioBase, diferencial, precioFinal] = 
                ['costo', 'utilidad', 'precioVenta', 'precioBase', 'diferencial', 'precioFinal'].map(id => view.querySelector('#' + id));
            const fixPrecioManual = view.querySelector('#fixPrecioManual');

            function items_formatNumber(num) {
                return isNaN(num) || !isFinite(num) || num === 0 ? '' : parseFloat(num.toFixed(2));
            }

            function items_updateFinalPrice() {
                const pv = parseFloat(precioVenta.value) || 0;
                const d = parseFloat(diferencial.value) || 0;
                precioFinal.value = (pv > 0 && d > 0 && d < 100) ? items_formatNumber(pv / (1 - d / 100)) : items_formatNumber(pv);
            }

            costo.addEventListener('input', () => {
                const c = parseFloat(costo.value) || 0;
                const u = parseFloat(utilidad.value) || 0;
                if (!fixPrecioManual?.checked && c > 0 && u > 0 && u < 100) {
                    precioVenta.value = items_formatNumber(c / (1 - u / 100));
                    precioVenta.dispatchEvent(new Event('input'));
                }
            });

            utilidad.addEventListener('input', () => costo.dispatchEvent(new Event('input')));

            precioVenta.addEventListener('input', () => {
                const c = parseFloat(costo.value) || 0;
                const pv = parseFloat(precioVenta.value) || 0;
                if (c > 0 && pv > c) utilidad.value = items_formatNumber(((pv - c) / pv) * 100);
                precioBase.value = items_formatNumber(pv);
                items_updateFinalPrice();
            });

            diferencial.addEventListener('input', items_updateFinalPrice);

            precioFinal.addEventListener('input', () => {
                const pb = parseFloat(precioBase.value) || 0;
                const pf = parseFloat(precioFinal.value) || 0;
                if (pb > 0 && pf > pb) diferencial.value = items_formatNumber(((pf - pb) / pf) * 100);
            });

            // --- MULTIMEDIA ---
            const [imageUploadZone, imageUploadInput, imagePreviewContainer, imageMetaModal, saveMeta, cancelMeta, currentImageIdInput] =
                ['imageUploadZone', 'imageUploadInput', 'imagePreviewContainer', 'imageMetaModal', 'saveMeta', 'cancelMeta', 'currentImageId'].map(id => view.querySelector('#' + id));
            const imageTitleInput = view.querySelector('#imageTitle');
            const manageTitlePresetsBtn = view.querySelector('#manageTitlePresets');
            const imageTitlePresetsDL = view.querySelector('#imageTitlePresets');
            
            let imageMetadata = {};
            let imageState = {};

            new Sortable(imagePreviewContainer, { animation: 150, ghostClass: 'sortable-ghost' });
            
            imageUploadZone.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); imageUploadZone.classList.add('bg-gray-100'); });
            imageUploadZone.addEventListener('dragleave', e => { e.preventDefault(); e.stopPropagation(); imageUploadZone.classList.remove('bg-gray-100'); });
            imageUploadZone.addEventListener('drop', e => {
                e.preventDefault();
                e.stopPropagation();
                imageUploadZone.classList.remove('bg-gray-100');
                if (e.dataTransfer.files.length) {
                    imageUploadInput.files = e.dataTransfer.files;
                    items_handleFiles(e.dataTransfer.files);
                }
            });
            imageUploadInput.addEventListener('change', e => { if (e.target.files.length) items_handleFiles(e.target.files); });

            function items_handleFiles(files) {
                for (const file of files) {
                    if (!file.type.startsWith('image/')) continue;
                    const reader = new FileReader();
                    reader.onload = e => {
                        const dataUrl = e.target.result;
                        const imageId = 'img-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
                        imageMetadata[imageId] = { title: '', description: '', dataUrl: dataUrl };
                        imageState[imageId] = { archived: false };
                        imagePreviewContainer.insertAdjacentHTML('beforeend', `
                            <div class="image-preview-item group" data-id="${imageId}">
                                <div class="aspect-square w-full overflow-hidden rounded-lg border">
                                    <img src="${dataUrl}" alt="Previsualización" class="w-full h-full object-cover">
                                </div>
                                <div class="action-buttons">
                                    <button class="action-btn edit-btn" title="Editar Metadatos" data-id="${imageId}"><i class="fas fa-pen text-xs"></i></button>
                                    <button class="action-btn archive-btn" title="Archivar" data-id="${imageId}"><i class="fas fa-box-archive text-xs"></i></button>
                                    <button class="action-btn delete-btn" title="Eliminar" data-id="${imageId}"><i class="fas fa-trash text-xs"></i></button>
                                </div>
                                <div class="archive-overlay" data-id="${imageId}">
                                    <i class="fas fa-box-open text-2xl text-gray-700"></i>
                                    <p class="text-sm font-semibold text-gray-700 mt-1">Desarchivar</p>
                                </div>
                                <div class="mt-2 text-xs text-gray-700 leading-tight">
                                    <div class="font-medium title-line">${imageMetadata[imageId].title || ''}</div>
                                    <div class="text-gray-600 desc-line">${imageMetadata[imageId].description || ''}</div>
                                    <div class="text-[10px] text-gray-500 upload-status" data-id="${imageId}">Subiendo a la nube…</div>
                                </div>
                            </div>`);
                        // Subida en background a Firebase Storage
                        (async ()=>{
                            try{
                                const up = await uploadFileToStorage(file, 'image');
                                imageMetadata[imageId].url = up.url;
                                imageMetadata[imageId].path = up.path;
                                const st = imagePreviewContainer.querySelector(`.upload-status[data-id="${imageId}"]`);
                                if (st){ st.textContent = 'Subido'; st.classList.remove('text-gray-500'); st.classList.add('text-green-600'); setTimeout(()=> st.remove(), 1500); }
                            }catch(err){
                                const st = imagePreviewContainer.querySelector(`.upload-status[data-id="${imageId}"]`);
                                if (st){ st.textContent = 'Error al subir'; st.classList.remove('text-gray-500'); st.classList.add('text-red-600'); }
                                console.warn('Error subiendo imagen (multimedia):', err);
                            }
                        })();
                    };
                    reader.readAsDataURL(file);
                }
                setTimeout(() => items_recalculateAccordionHeight(imagePreviewContainer), 100);
            }

            imagePreviewContainer.addEventListener('click', e => {
                const target = e.target.closest('button, .archive-overlay');
                if (!target) return;
                const imageId = target.dataset.id;
                const imageElement = view.querySelector(`.image-preview-item[data-id="${imageId}"]`);
                if (!imageElement) return;

                if (target.classList.contains('edit-btn')) {
                    currentImageIdInput.value = imageId;
                    const meta = imageMetadata[imageId] || { title: '', description: '' };
                    view.querySelector('#imageTitle').value = meta.title;
                    view.querySelector('#imageDescription').value = meta.description;
                    imageMetaModal.classList.remove('hidden');
                } else if (target.classList.contains('archive-btn')) {
                    imageState[imageId].archived = true;
                    imageElement.classList.add('archived');
                } else if (target.classList.contains('archive-overlay')) {
                    imageState[imageId].archived = false;
                    imageElement.classList.remove('archived');
                } else if (target.classList.contains('delete-btn')) {
                    if (confirm('¿Seguro que quieres eliminar esta imagen?')) {
                        // Intentar eliminar del Storage si existe url o path
                        (async ()=>{
                            try{
                                const meta = imageMetadata[imageId] || {};
                                if (meta.path){ await storage.ref().child(meta.path).delete().catch(()=>{}); }
                                else if (meta.url){ await storage.refFromURL(meta.url).delete().catch(()=>{}); }
                            }catch(err){ console.warn('No se pudo borrar del Storage:', err); }
                        })();
                        delete imageMetadata[imageId];
                        delete imageState[imageId];
                        imageElement.remove();
                    }
                }
            });

            saveMeta.addEventListener('click', () => {
                const imageId = currentImageIdInput.value;
                if (imageId && imageMetadata[imageId]) {
                    imageMetadata[imageId].title = view.querySelector('#imageTitle').value;
                    imageMetadata[imageId].description = view.querySelector('#imageDescription').value;
                    const card = view.querySelector(`.image-preview-item[data-id="${imageId}"]`);
                    if (card){
                        const t = card.querySelector('.title-line');
                        const d = card.querySelector('.desc-line');
                        if (t) t.textContent = imageMetadata[imageId].title || '';
                        if (d) d.textContent = imageMetadata[imageId].description || '';
                    }
                    imageMetaModal.classList.add('hidden');
                }
            });
            cancelMeta.addEventListener('click', () => imageMetaModal.classList.add('hidden'));

            // --- BUSCADOR EN VIVO PARA DESCRIPCIÓN (combobox con Firestore) ---
            // Habilitado/Deshabilitado desde el editor (specialFunctions.searchExisting en 'descripcion')
            let descSearchFeatureEnabled = false;
            const descripcionInput = view.querySelector('#descripcion');
            const descripcionWrapper = descripcionInput.closest('.relative');
            const sugerenciasBox = view.querySelector('#descripcion-suggestions');
            const descripcionIndexHint = view.querySelector('#descripcion-index-hint');
            const descNewBtn = view.querySelector('#descripcion-new-btn');
            let descripcionDebounceTimer = null;
            let descripcionResults = [];
            let highlightedIndex = -1;
            let editingItemId = null; // Modo edición si se carga un ítem existente
            let cameFromSearch = false; // Para retornar foco al buscador tras guardar
            let currentActivityId = null; // Log de actividad de edición
            let itemFormStartMs = null; // Para duración de registro
            // Modo similar (crear similares a partir de un existente)
            let similarMode = { active:false, baseDescripcion:'', mustChange:true, series:false, templateData:null, sourceId:null };

            function setSimilarMode(on, opts){
                similarMode.active = !!on;
                if (!on){ similarMode.baseDescripcion=''; similarMode.mustChange=true; similarMode.series=false; similarMode.templateData=null; similarMode.sourceId=null; hideSimilarHint(); return; }
                similarMode.baseDescripcion = (opts?.baseDescripcion||'').toString();
                similarMode.mustChange = (typeof opts?.mustChange==='boolean') ? opts.mustChange : true;
                similarMode.series = !!opts?.series;
                similarMode.templateData = opts?.templateData || null;
                similarMode.sourceId = opts?.sourceId || null;
                showSimilarHint();
            }
            function showSimilarHint(){
                try{
                    let hint = document.getElementById('descripcion-similar-hint');
                    if (!hint){
                        hint = document.createElement('div');
                        hint.id = 'descripcion-similar-hint';
                        hint.className = 'mt-1 text-[11px] text-amber-800 bg-amber-50 border border-amber-200 rounded px-2 py-1 flex items-start justify-between gap-2';
                        const wrap = descripcionInput.closest('.relative');
                        if (wrap) wrap.insertAdjacentElement('afterend', hint); else descripcionInput.parentElement?.appendChild(hint);
                    }
                    const base = similarMode.baseDescripcion ? `«${similarMode.baseDescripcion}»` : 'el ítem base';
                    const seriesTxt = similarMode.series ? ' · Modo serie activo' : '';
                    hint.innerHTML = `<div><b>Creando ítem similar</b>${seriesTxt}. Cambia la descripción (ej.: color/tamaño) respecto a ${base} antes de guardar.</div><button id="btnExitSimilar" class="text-xs px-2 py-0.5 rounded bg-gray-200 hover:bg-gray-300">Salir</button>`;
                    hint.classList.remove('hidden');
                    hint.querySelector('#btnExitSimilar')?.addEventListener('click', ()=> setSimilarMode(false));
                }catch(_){ /* noop */ }
            }
            function hideSimilarHint(){
                const hint = document.getElementById('descripcion-similar-hint');
                if (hint) hint.classList.add('hidden');
            }

            function debounce(fn, delay) {
                return function(...args){
                    clearTimeout(descripcionDebounceTimer);
                    descripcionDebounceTimer = setTimeout(() => fn.apply(this, args), delay);
                };
            }

            function hideSugerencias(){
                sugerenciasBox.classList.add('hidden');
                highlightedIndex = -1;
            }

            function renderSugerencias(items){
                if (!items || items.length === 0){ hideSugerencias(); return; }
                sugerenciasBox.innerHTML = items.map((it, idx) => {
                    const active = idx === highlightedIndex ? 'bg-cyan-50' : '';
                    const sku = it.data.sku ? `<span class=\"text-xs text-gray-500\">SKU: ${it.data.sku}</span>` : '';
                    return `<div class=\"px-3 py-2 cursor-pointer hover:bg-cyan-50 ${active}\" data-idx=\"${idx}\">
                        <div class=\"text-sm text-gray-800\">${it.data.descripcion || '(Sin descripción)'}${(it.data.tipo ? `<span class=\"ml-1 text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-600\">${it.data.tipo}</span>` : '')}</div>
                        ${sku}
                    </div>`;
                }).join('');
                sugerenciasBox.classList.remove('hidden');
            }

            async function buscarDescripcion(term){
                const q = (term || '').trim();
                if (q.length < 2){ hideSugerencias(); return; }
                try {
                    await ensureFirebaseAuth();
                    const byDesc = itemsCol.orderBy('descripcion').startAt(q).endAt(q + '\uf8ff').limit(5).get();
                    const bySku = itemsCol.orderBy('sku').startAt(q).endAt(q + '\uf8ff').limit(5).get();
                    const [s1, s2] = await Promise.allSettled([byDesc, bySku]);
                    let rows = [];
                    if (s1.status === 'fulfilled') rows = rows.concat(s1.value.docs.map(d => ({ id: d.id, data: d.data() })));
                    if (s2.status === 'fulfilled') rows = rows.concat(s2.value.docs.map(d => ({ id: d.id, data: d.data() })));
                    // De-dup por id y recortar
                    const seen = new Set();
                    descripcionResults = rows.filter(r => { if (seen.has(r.id)) return false; seen.add(r.id); return true; }).slice(0, 8);
                    renderSugerencias(descripcionResults);
                    if (descripcionIndexHint) descripcionIndexHint.classList.add('hidden');
                } catch (err) {
                    console.warn('Búsqueda en Firestore falló (descripcion/sku):', err);
                    hideSugerencias();
                    if (descripcionIndexHint && err && ('' + (err.code || err.message)).includes('FAILED_PRECONDITION')) {
                        descripcionIndexHint.classList.remove('hidden');
                    }
                }
            }

            // Encapsular wiring para poder habilitar/deshabilitar dinámicamente
            let descHandlersWired = false;
            const onInputDescripcion = debounce((e) => buscarDescripcion(e.target.value), 180);
            const onMouseDownSugerencias = (e) => {
                const item = e.target.closest('[data-idx]');
                if (!item) return;
                const idx = parseInt(item.dataset.idx, 10);
                if (isNaN(idx)) return;
                // Si no estamos en edición, mostrar opciones de duplicado en vez de cargar directamente
                if (!editingItemId){
                    e.preventDefault();
                    const typed = (descripcionInput.value||'').trim();
                    openDuplicateOptionsModal(idx, typed);
                    return;
                }
                // En edición, mantener comportamiento directo
                selectSugerencia(idx);
            };
            const onKeydownDescripcion = (e) => {
                if (sugerenciasBox.classList.contains('hidden')) return;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIndex = (highlightedIndex + 1) % descripcionResults.length;
                    renderSugerencias(descripcionResults);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = (highlightedIndex - 1 + descripcionResults.length) % descripcionResults.length;
                    renderSugerencias(descripcionResults);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    // Si hay resultados y no estamos editando, ofrecer opciones de duplicado
                    if (!editingItemId && descripcionResults && descripcionResults.length){
                        const val = (descripcionInput.value || '').trim();
                        const low = val.toLowerCase();
                        const exactIdx = descripcionResults.findIndex(r => (r.data.descripcion || '').toLowerCase() === low || (r.data.sku || '').toLowerCase() === low || (r.data.codigoBarra || '').toLowerCase() === low);
                        const selIdx = (highlightedIndex>=0) ? highlightedIndex : (exactIdx>=0 ? exactIdx : 0);
                        openDuplicateOptionsModal(selIdx, val);
                        return;
                    }
                    if (highlightedIndex >= 0) {
                        selectSugerencia(highlightedIndex);
                    } else {
                        const val = (descripcionInput.value || '').trim().toLowerCase();
                        const exactIdx = descripcionResults.findIndex(r => (r.data.descripcion || '').toLowerCase() === val || (r.data.sku || '').toLowerCase() === val || (r.data.codigoBarra || '').toLowerCase() === val);
                        if (exactIdx >= 0) selectSugerencia(exactIdx); else hideSugerencias();
                    }
                } else if (e.key === 'Escape') {
                    hideSugerencias();
                }
            };
            const onBlurDescripcion = () => setTimeout(hideSugerencias, 120);
            function wireDescripcionSearch(){
                if (descSearchFeatureEnabled && !descHandlersWired){
                    descripcionInput.addEventListener('input', onInputDescripcion);
                    sugerenciasBox.addEventListener('mousedown', onMouseDownSugerencias);
                    descripcionInput.addEventListener('keydown', onKeydownDescripcion);
                    descripcionInput.addEventListener('blur', onBlurDescripcion);
                    descHandlersWired = true;
                } else if (!descSearchFeatureEnabled && descHandlersWired){
                    descripcionInput.removeEventListener('input', onInputDescripcion);
                    sugerenciasBox.removeEventListener('mousedown', onMouseDownSugerencias);
                    descripcionInput.removeEventListener('keydown', onKeydownDescripcion);
                    descripcionInput.removeEventListener('blur', onBlurDescripcion);
                    hideSugerencias();
                    descHandlersWired = false;
                }
            }

            function openDuplicateOptionsModal(defaultIdx=0, typedVal=''){
                try{
                    const modal = document.getElementById('duplicateOptionsModal'); if (!modal) return;
                    const list = modal.querySelector('#dupMatches');
                    const rows = (descripcionResults||[]).slice(0,6);
                    list.innerHTML = rows.map((r,i)=>{
                        const desc = r.data.descripcion || '(Sin descripción)';
                        const sku = r.data.sku ? `<span class='ml-1 text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-600'>${r.data.sku}</span>` : '';
                        const checked = (i===defaultIdx) ? 'checked' : '';
                        return `<label class="flex items-center gap-2 px-3 py-2 border-b last:border-0">
                            <input type="radio" name="dupSel" value="${i}" ${checked}>
                            <span class="text-sm text-gray-800">${desc} ${sku}</span>
                        </label>`;
                    }).join('');
                    const pickIndex = ()=>{
                        const sel = list.querySelector('input[name="dupSel"]:checked');
                        const idx = sel ? parseInt(sel.value,10) : 0;
                        return isNaN(idx) ? 0 : Math.max(0, Math.min(idx, rows.length-1));
                    };
                    const close = ()=> modal.classList.add('hidden');
                    modal.classList.remove('hidden');
                    const btnClose = modal.querySelector('#dupCloseBtn');
                    const btnEdit = modal.querySelector('#dupOptEdit');
                    const btnSimilar = modal.querySelector('#dupOptSimilar');
                    const btnSeries = modal.querySelector('#dupOptSeries');
                    if (btnClose) btnClose.onclick = close;
                    if (btnEdit) btnEdit.onclick = ()=>{
                        const idx = pickIndex(); const it = rows[idx]; if (!it) return; close();
                        window.items_loadItemForEdit && window.items_loadItemForEdit(it.id, 'duplicateModal');
                    };
                    if (btnSimilar) btnSimilar.onclick = async ()=>{
                        const idx = pickIndex(); const it = rows[idx]; if (!it) return; close();
                        try{ const snap = await itemsCol.doc(it.id).get(); if (!snap.exists) return; const data = snap.data();
                            editingItemId = null; // forzar modo creación
                            fillItemFormFromData(data);
                            const base = (data.descripcion||'').trim();
                            // Siempre precargar la descripción completa del ítem base para que el usuario agregue el diferenciador
                            descripcionInput.value = base;
                            setSimilarMode(true, { baseDescripcion: base, mustChange:true, series:false, templateData:data, sourceId: it.id });
                            // Posicionar el cursor al final para facilitar agregar color/tamaño, etc.
                            try{ const len = descripcionInput.value.length; descripcionInput.focus(); descripcionInput.setSelectionRange(len, len); }catch(_){ descripcionInput.focus(); }
                        }catch(e){ console.warn('dupOptSimilar error', e); }
                    };
                    if (btnSeries) btnSeries.onclick = async ()=>{
                        const idx = pickIndex(); const it = rows[idx]; if (!it) return; close();
                        try{ const snap = await itemsCol.doc(it.id).get(); if (!snap.exists) return; const data = snap.data();
                            editingItemId = null;
                            fillItemFormFromData(data);
                            const base = (data.descripcion||'').trim();
                            // En modo serie también precargar la descripción base
                            descripcionInput.value = base;
                            setSimilarMode(true, { baseDescripcion: base, mustChange:true, series:true, templateData:data, sourceId: it.id });
                            try{ const len = descripcionInput.value.length; descripcionInput.focus(); descripcionInput.setSelectionRange(len, len); }catch(_){ descripcionInput.focus(); }
                        }catch(e){ console.warn('dupOptSeries error', e); }
                    };
                    // Atajo de teclado: Enter confirma "Crear similar" por defecto; Esc cierra
                    modal.onkeydown = (kev)=>{
                        if (kev.key === 'Enter'){ kev.preventDefault(); if (btnSimilar) btnSimilar.onclick(); }
                        if (kev.key === 'Escape'){ kev.preventDefault(); close(); }
                    };
                }catch(e){ console.warn('openDuplicateOptionsModal', e); }
            }

            function fillItemFormFromData(data){
                if (!data) return;
                const setVal = (sel, val) => { const el = view.querySelector(sel); if (el) el.value = val ?? el.value; };
                setVal('#descripcion', data.descripcion || '');
                setVal('#sku', data.sku || '');
                setVal('#marca', data.marca || '');
                setVal('#modelo', data.modelo || '');
                setVal('#proposito', data.proposito || 'Para la Venta');
                // Aplicar tipo y extras de servicio
                if (data.tipo){ itemTypeSwitcher.value = data.tipo; itemTypeSwitcher.dispatchEvent(new Event('change')); }
                setVal('#serviceSLA', data.service?.defaultSLA || '');
                const svcSel = view.querySelector('#serviceChecklists');
                if (svcSel){ const arr = Array.isArray(data.service?.checklists) ? data.service.checklists : []; Array.from(svcSel.options).forEach(o=> o.selected = arr.includes(o.value)); }
                // Taxonomía
                const catId = data.taxonomy?.category_id || '';
                // Código de barra y toggle
                const chkCB = view.querySelector('#chkUsaCodigoBarra');
                const contCB = view.querySelector('#codigoBarraContent');
                if (typeof data.usaCodigoBarra !== 'undefined' && chkCB) {
                    chkCB.checked = !!data.usaCodigoBarra;
                    if (contCB) contCB.classList.toggle('visible', !!data.usaCodigoBarra);
                }
                setVal('#codigoBarra', data.codigoBarra || '');
                // Logística
                setVal('#stockMinimo', data.stockMinimo);
                setVal('#stockMaximo', data.stockMaximo);
                setVal('#tiempoReposicion', data.tiempoReposicion);
                setVal('#altoCm', data.altoCm);
                setVal('#anchoCm', data.anchoCm);
                setVal('#profundoCm', data.profundoCm);
                setVal('#pesoKg', data.pesoKg);
                // Trazabilidad
                setVal('#llevaNumeroSerie', data.llevaNumeroSerie ?? '');
                setVal('#manejaLote', data.manejaLote ?? '');
                setVal('#manejaVencimiento', data.manejaVencimiento ?? '');
                // Precios
                setVal('#costo', data.costo);
                setVal('#utilidad', data.utilidad);
                setVal('#precioVenta', data.precioVenta);
                setVal('#precioBase', data.precioBase);
                setVal('#diferencial', data.diferencial);
                setVal('#precioFinal', data.precioFinal);
                // Modelo de precio servicio
                const pm = data.pricingModel || 'fixed';
                if (view.querySelector('#pricingModel')) view.querySelector('#pricingModel').value = pm;
                if (view.querySelector('#hourlyRate')) view.querySelector('#hourlyRate').value = data.hourlyRate || '';
                if (typeof updatePricingVisibility === 'function') updatePricingVisibility();
                // Componentes de servicio
                if (Array.isArray(data.service?.components)){
                    serviceComponents = data.service.components.map(c=>({ itemId:c.itemId, descripcion:c.descripcion, sku:c.sku, qty:c.qty||1, allowSubstitution: c.allowSubstitution!==false }));
                } else { serviceComponents = []; }
                renderServiceComponents();
                // Componentes de combo
                if (Array.isArray(data.combo?.components)){
                    comboComponents = data.combo.components.map(c=>({ itemId:c.itemId, descripcion:c.descripcion, sku:c.sku, qty:c.qty||1 }));
                } else { comboComponents = []; }
                renderComboComponents();
                // Si existe un campo dinámico listWithSearch para combos, reflejar los componentes como lista dinámica
                try{
                    const dynKey = 'comboComponentsList';
                    const dynSel = FIELD_MAP[dynKey];
                    if (dynSel && view.querySelector(dynSel)){
                        if (!view._dynamicLists) view._dynamicLists = {};
                        view._dynamicLists[dynKey] = Array.isArray(data.combo?.components) ? data.combo.components.map(c=>({ id:c.itemId, descripcion:c.descripcion, sku:c.sku, qty: c.qty||1 })) : [];
                        renderDynamicList(dynKey);
                    }
                    // Soportar cualquier listWithSearch dentro de la sección Combo (genérico)
                    const comboSec = view.querySelector('#sectionCombo');
                    if (comboSec){
                        const comps = Array.isArray(data.combo?.components) ? data.combo.components : [];
                        const mapped = comps.map(c=>({ id:c.itemId, descripcion:c.descripcion, sku:c.sku, qty: c.qty||1 }));
                        Object.entries(FIELD_MAP).forEach(([k, sel])=>{
                            const el = sel ? view.querySelector(sel) : null; if (!el) return;
                            if (!comboSec.contains(el)) return;
                            const id = el.id || '';
                            if (/^dyn_.+_search$/.test(id)){
                                if (!view._dynamicLists) view._dynamicLists = {};
                                view._dynamicLists[k] = mapped.slice();
                                renderDynamicList(k);
                            }
                        });
                    }
                }catch(_){ /* noop */ }
                // Si existen campos dinámicos listWithSearch en la sección de servicio, reflejar materiales desde data.service.components
                try{
                    const svcSec = view.querySelector('#serviceExtras');
                    if (svcSec){
                        const comps = Array.isArray(data.service?.components) ? data.service.components : [];
                        const mapped = comps.map(c=>({ id:c.itemId, descripcion:c.descripcion, sku:c.sku, qty: c.qty||1, allowSubstitution: c.allowSubstitution!==false }));
                        // Detectar inputs de lista dinámica dentro de serviceExtras por convención de id dyn_<key>_search
                        Object.entries(FIELD_MAP).forEach(([k, sel])=>{
                            const el = sel ? view.querySelector(sel) : null;
                            if (!el) return;
                            if (!svcSec.contains(el)) return;
                            const id = el.id || '';
                            if (/^dyn_.+_search$/.test(id)){
                                if (!view._dynamicLists) view._dynamicLists = {};
                                view._dynamicLists[k] = mapped.slice();
                                renderDynamicList(k);
                            }
                        });
                    }
                }catch(_){ /* noop */ }
                // Impuestos
                const chkExento = view.querySelector('#chkEsExento');
                if (typeof data.esExento !== 'undefined' && chkExento) {
                    chkExento.checked = !!data.esExento;
                    chkExento.dispatchEvent(new Event('change'));
                }
                setVal('#tipoImpuesto', data.tipoImpuesto);
                setVal('#impuestoAsignado', data.impuestoAsignado);
                // Ofertas simples
                const chkOferta = view.querySelector('#chkEstaEnOferta');
                if (typeof data.estaEnOferta !== 'undefined' && chkOferta) {
                    chkOferta.checked = !!data.estaEnOferta;
                    chkOferta.dispatchEvent(new Event('change'));
                }
                setVal('#ofertaTipo', data.ofertaTipo);
                setVal('#ofertaValor', data.ofertaValor);
                setVal('#ofertaMotivo', data.ofertaMotivo);
                setVal('#ofertaInicio', data.ofertaInicio);
                setVal('#ofertaFin', data.ofertaFin);
                // Multimedia (si existe una lista con url o dataUrl)
                if (Array.isArray(data.multimedia)){
                    imagePreviewContainer.innerHTML = '';
                    imageMetadata = {}; imageState = {};
                    data.multimedia.forEach(m => {
                        const imgId = m.id || ('img-' + Date.now() + '-' + Math.random().toString(36).substring(2,9));
                        const src = m.dataUrl || m.url || '';
                        if (!src) return;
                        imageMetadata[imgId] = { title: m.title || '', description: m.description || '', dataUrl: src };
                        imageState[imgId] = { archived: !!m.archived };
                        imagePreviewContainer.insertAdjacentHTML('beforeend', `
                            <div class="image-preview-item ${m.archived ? 'archived' : ''} group aspect-square" data-id="${imgId}">
                                <img src="${src}" alt="Previsualización" class="w-full h-full object-cover rounded-lg">
                                <div class="action-buttons">
                                    <button class="action-btn edit-btn" title="Editar Metadatos" data-id="${imgId}"><i class="fas fa-pen text-xs"></i></button>
                                    <button class="action-btn archive-btn" title="Archivar" data-id="${imgId}"><i class="fas fa-box-archive text-xs"></i></button>
                                    <button class="action-btn delete-btn" title="Eliminar" data-id="${imgId}"><i class="fas fa-trash text-xs"></i></button>
                                </div>
                                <div class="archive-overlay" data-id="${imgId}">
                                    <i class="fas fa-box-open text-2xl text-gray-700"></i>
                                    <p class="text-sm font-semibold text-gray-700 mt-1">Desarchivar</p>
                                </div>
                            </div>`);
                    });
                }
            }

            async function selectSugerencia(idx){
                const it = descripcionResults[idx];
                if (!it) return;
                try {
                    const snap = await itemsCol.doc(it.id).get();
                    if (!snap.exists) return;
                    const data = snap.data();
                    const currentType = (itemTypeSwitcher?.value || '').toLowerCase();
                    const onSelectForDesc = (view._onSelectActions && Array.isArray(view._onSelectActions['descripcion'])) ? view._onSelectActions['descripcion'][0] : null;
                    const actionType = onSelectForDesc ? onSelectForDesc.type : null;
                    const wantsFillOnly = actionType === 'onSelectFillField';
                    // Si estamos creando un Combo y la acción configurada es llenar el campo, no navegar ni cambiar tipo
                    if (currentType === 'combo' && (wantsFillOnly || !actionType)){
                        descripcionInput.value = data.descripcion || '';
                        // Mostrar una pista visual de existencia sin navegar
                        try{
                            let hint = document.getElementById('descripcion-exists-hint');
                            if (!hint){
                                hint = document.createElement('div');
                                hint.id = 'descripcion-exists-hint';
                                hint.className = 'mt-1 text-[11px] text-cyan-700 bg-cyan-50 border border-cyan-200 rounded px-2 py-1';
                                const wrap = descripcionInput.closest('.relative');
                                if (wrap) wrap.insertAdjacentElement('afterend', hint); else descripcionInput.parentElement?.appendChild(hint);
                            }
                            const skuTxt = data.sku ? ` · SKU ${data.sku}` : '';
                            hint.textContent = `Existe en inventario${skuTxt}. Puedes agregarle más datos y guardarlo como Combo.`;
                        }catch(_){ /* noop */ }
                        hideSugerencias();
                        return;
                    }
                    // Comportamiento por defecto: cargar el ítem completo en el formulario (edición)
                    editingItemId = it.id;
                    descripcionInput.value = data.descripcion || '';
                    fillItemFormFromData(data);
                    // Cambiar botón a modo edición
                    btnRegistrarItem.innerHTML = '<i class="fas fa-save mr-2"></i>Guardar Cambios';
                    if (descNewBtn) descNewBtn.classList.remove('hidden');
                    hideSugerencias();
                } catch (err) {
                    console.warn('No se pudo cargar el ítem existente:', err);
                }
            }

            // Exponer cargador para modo edición solicitado desde el buscador
            let originalPrecioVenta = null;
            window.items_loadItemForEdit = async function(id, origin){
                try{
                    const snap = await itemsCol.doc(id).get();
                    if (!snap.exists) return;
                    const data = snap.data();
                    editingItemId = id;
                    cameFromSearch = (origin === 'search');
                    // Iniciar log de actividad
                    try{
                        const aRef = await activityLogsCol.add({
                            kind: 'item_edit',
                            itemId: id,
                            origin: origin || null,
                            userId: currentUser ? currentUser.id : null,
                            userName: currentUser ? currentUser.name : null,
                            startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            activeView: 'items'
                        });
                        currentActivityId = aRef.id;
                    }catch(e){ console.warn('No se pudo registrar actividad (inicio):', e); }
                    descripcionInput.value = data.descripcion || '';
                    fillItemFormFromData(data);
                    // Guardar precio original para confirmar cambios
                    originalPrecioVenta = (typeof data.precioVenta === 'number') ? data.precioVenta : (parseFloat(data.precio_venta_usd) || null);
                    btnRegistrarItem.innerHTML = '<i class="fas fa-save mr-2"></i>Guardar Cambios';
                    if (descNewBtn) descNewBtn.classList.remove('hidden');
                    hideSugerencias();
                }catch(e){ console.warn('items_loadItemForEdit error:', e); }
            };

            // Salir de modo edición si se limpia la descripción
            descripcionInput.addEventListener('input', () => {
                if (!descripcionInput.value.trim() && editingItemId){
                    editingItemId = null;
                    btnRegistrarItem.innerHTML = '<i class="fas fa-save mr-2"></i>Registrar Item';
                    if (descNewBtn) descNewBtn.classList.add('hidden');
                }
                if (!itemFormStartMs && descripcionInput.value.trim()){
                    itemFormStartMs = Date.now();
                    // Registrar inicio de creación si no es edición
                    if (!editingItemId){
                        (async ()=>{
                            try{
                                const a = await activityLogsCol.add({
                                    kind: 'item_create',
                                    userId: currentUser?.id || null,
                                    userName: currentUser?.name || null,
                                    status: 'started',
                                    startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    viewId: 'items',
                                    descripcion: descripcionInput.value.trim()
                                });
                                itemCreateActivityId = a.id;
                            }catch(e){}
                        })();
                    }
                }
            });

            function resetFormToNew(){
                editingItemId = null;
                originalPrecioVenta = null;
                // Básicos
                const set = (sel, val='') => { const el = view.querySelector(sel); if (el) el.value = val; };
                set('#descripcion','');
                set('#sku','');
                set('#marca','');
                set('#modelo','');
                set('#proposito','Para la Venta');
                set('#serviceSLA','');
                const svcSel = view.querySelector('#serviceChecklists'); if (svcSel){ Array.from(svcSel.options).forEach(o=> o.selected=false); }
                const chkCB = view.querySelector('#chkUsaCodigoBarra');
                const contCB = view.querySelector('#codigoBarraContent');
                if (chkCB){ chkCB.checked = false; }
                if (contCB){ contCB.classList.remove('visible'); }
                set('#codigoBarra','');
                // Logística
                set('#stockMinimo'); set('#stockMaximo'); set('#tiempoReposicion');
                set('#altoCm'); set('#anchoCm'); set('#profundoCm'); set('#pesoKg');
                // Trazabilidad
                set('#llevaNumeroSerie',''); set('#manejaLote',''); set('#manejaVencimiento','');
                // Precios
                set('#costo'); set('#utilidad'); set('#precioVenta'); set('#precioBase'); set('#diferencial'); set('#precioFinal');
                if (view.querySelector('#pricingModel')) view.querySelector('#pricingModel').value = 'fixed';
                if (view.querySelector('#hourlyRate')) view.querySelector('#hourlyRate').value = '';
                // Impuestos
                const chkEx = view.querySelector('#chkEsExento'); if (chkEx){ chkEx.checked = false; chkEx.dispatchEvent(new Event('change')); }
                set('#tipoImpuesto',''); set('#impuestoAsignado','');
                // Oferta
                const chkOf = view.querySelector('#chkEstaEnOferta'); if (chkOf){ chkOf.checked = false; chkOf.dispatchEvent(new Event('change')); }
                set('#ofertaTipo','Porcentaje (%)'); set('#ofertaValor'); set('#ofertaMotivo'); set('#ofertaInicio'); set('#ofertaFin');
                // Multimedia
                imagePreviewContainer.innerHTML = '';
                imageMetadata = {}; imageState = {};
                // Componentes de servicio
                serviceComponents = [];
                if (svcMatTableBody) svcMatTableBody.innerHTML = '';
                // Componentes de combo
                comboComponents = [];
                if (comboTableBody) comboTableBody.innerHTML = '';
                // Limpiar listas dinámicas (listWithSearch)
                try{
                    if (!view._dynamicLists) view._dynamicLists = {};
                    Object.keys(view._dynamicLists).forEach(k=>{ const body = view.querySelector(`#dyn_${k}_list`); if (body) body.innerHTML=''; });
                    view._dynamicLists = {};
                }catch(_){ /* noop */ }
                // UI
                btnRegistrarItem.innerHTML = '<i class="fas fa-save mr-2"></i>Registrar Item';
                if (descNewBtn) descNewBtn.classList.add('hidden');
                hideSugerencias();
                descripcionInput.focus();
            }

            if (descNewBtn) descNewBtn.addEventListener('click', resetFormToNew);

            // --- LÓGICA DE REGISTRO ---
            const btnRegistrarItem = view.querySelector('#btnRegistrarItem');
            let offersState = [];
            const offerListContainer = view.querySelector('#offerListContainer');
            const noOffersText = view.querySelector('#noOffersText');
            const ofertaTipo = view.querySelector('#ofertaTipo');
            const ofertaValor = view.querySelector('#ofertaValor');
            const ofertaMotivo = view.querySelector('#ofertaMotivo');
            const ofertaInicio = view.querySelector('#ofertaInicio');
            const ofertaFin = view.querySelector('#ofertaFin');

            function renderOffers(){
                if (!offersState.length){
                    if (noOffersText) noOffersText.classList.remove('hidden');
                    if (offerListContainer) offerListContainer.innerHTML = noOffersText ? '' : '';
                    return;
                }
                if (noOffersText) noOffersText.classList.add('hidden');
                if (offerListContainer) offerListContainer.innerHTML = offersState.map((o, idx)=>`
                    <div class="flex items-center justify-between p-2 border rounded bg-white">
                        <div class="text-sm">
                            <div class="font-medium">${o.tipo} - ${o.valor}${o.tipo.includes('%')?'%':' USD'}</div>
                            <div class="text-gray-600">${o.motivo || ''}</div>
                            <div class="text-gray-500 text-xs">${o.inicio || ''} → ${o.fin || ''}</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="px-2 py-1 bg-red-500 text-white rounded" data-del="${idx}"><i class="fa fa-trash"></i></button>
                        </div>
                    </div>`).join('');
            }
            view.querySelector('#btnRegisterOffer')?.addEventListener('click', ()=>{
                const tipo = ofertaTipo?.value || 'Porcentaje (%)';
                const valor = parseFloat(ofertaValor?.value||'');
                if (!valor || valor<=0){ alert('Ingrese un valor de descuento válido'); return; }
                const inicio = ofertaInicio?.value || '';
                const fin = ofertaFin?.value || '';
                offersState.push({ tipo, valor, motivo: (ofertaMotivo?.value||'').trim(), inicio, fin });
                renderOffers();
            });
            offerListContainer?.addEventListener('click', (e)=>{
                const btn = e.target.closest('button[data-del]'); if (!btn) return;
                const idx = parseInt(btn.dataset.del,10); if (isNaN(idx)) return;
                offersState.splice(idx,1); renderOffers();
            });
            // Auto-cerrar pickers de fecha/hora (blur al cambiar)
            ofertaInicio?.addEventListener('change', e=> e.target.blur());
            ofertaFin?.addEventListener('change', e=> e.target.blur());
            async function validateItemForm(){
                let ok = true;
                const setInvalid = (el, type) => { el.classList.add('invalid-' + type); ok = false; };
                const clearInvalid = (el) => { el.classList.remove('invalid-obligatorio','invalid-necesario'); };
                const type = itemTypeSwitcher.value;

                // Limpiar marcas anteriores
                Object.values(FIELD_MAP).forEach(sel=>{ const el = view.querySelector(sel); if (el) clearInvalid(el); });

                // Reglas dinámicas desde definiciones
                const defs = await loadFieldDefs();
                for (const [key, selector] of Object.entries(FIELD_MAP)){
                    const el = view.querySelector(selector); if (!el) continue;
                    const rule = getFieldRuleForType(key, type, defs);
                    // Si no es visible, no valida
                    const wrapHidden = (el.closest('div')?.style.display==='none') || el.closest('section')?.style.display==='none' || el.closest('div')?.classList?.contains('hidden');
                    if (!rule.required || wrapHidden) continue;
                    // Caso especial hourlyRate
                    if (key==='hourlyRate' && ((view.querySelector('#pricingModel')?.value)||'fixed')!=='hourly') continue;
                    // Validación por tipo de campo
                    if (el.type==='checkbox'){
                        if (!el.checked) setInvalid(el,'obligatorio');
                    } else if (el.tagName==='SELECT'){
                        if (!el.multiple && !el.value) setInvalid(el,'obligatorio');
                        if (el.multiple){ const any = Array.from(el.selectedOptions).some(o=>o.value); if (!any) setInvalid(el,'obligatorio'); }
                    } else {
                        if (!el.value || !el.value.toString().trim()) setInvalid(el,'obligatorio');
                    }
                }
                // Validación especial para campos listWithSearch requeridos: la "lista" no puede estar vacía
                try{
                    const listDefs = Array.isArray(defs) ? defs.filter(d=> d && d.fieldType==='listWithSearch') : [];
                    for (const d of listDefs){
                        const rule = getFieldRuleForType(d.key, type, defs);
                        if (!rule.required) continue;
                        const sel = FIELD_MAP[d.key];
                        const el = sel ? view.querySelector(sel) : null;
                        if (!el) continue;
                        const hidden = (el.closest('div')?.style.display==='none') || el.closest('section')?.style.display==='none' || el.closest('div')?.classList?.contains('hidden');
                        if (hidden) continue;
                        const listLen = Array.isArray(view._dynamicLists?.[d.key]) ? view._dynamicLists[d.key].length : 0;
                        if (listLen<=0) setInvalid(el, 'obligatorio');
                    }
                }catch(_){ /* noop */ }
                // Regla especial: comboItems requerido
                try{
                    const comboRule = getFieldRuleForType('comboItems', type, defs);
                    if (type==='combo' && comboRule && comboRule.required){
                        const hasDyn = Array.isArray(view._dynamicLists?.comboComponentsList) && view._dynamicLists.comboComponentsList.length>0;
                        if ((!Array.isArray(comboComponents) || comboComponents.length===0) && !hasDyn){
                            const el = comboSearch || view.querySelector('#comboSearch');
                            if (el){ setInvalid(el, 'obligatorio'); }
                        }
                    }
                }catch(_){ /* noop */ }

                // Validar taxonomía requerida
                const catId = categoriaItemSel.value;
                if (catId){
                    // Buscar definiciones y flags required en contenedor renderizado
                    taxonomyContainer.querySelectorAll('[id^="tax_"]').forEach(input=>{
                        const wrapper = input.closest('div');
                        if (!wrapper) return;
                        const hasStar = wrapper.querySelector('label span.text-red-500');
                        if (hasStar){
                            if ((input.tagName==='SELECT' && !input.multiple && !input.value) || (input.tagName==='INPUT' && input.type==='text' && !input.value.trim()) || (input.tagName==='INPUT' && input.type==='number' && (input.value==='' || input.value===null)) ){
                                input.classList.add('invalid-obligatorio'); ok=false;
                            }
                        }
                    });
                }
                return ok;
            }
            btnRegistrarItem.addEventListener('click', async () => {
                const itemData = {};
                const toast = view.querySelector('#toast-notification');
                if (!(await validateItemForm())){
                    toast.innerHTML = '<i class="fas fa-triangle-exclamation mr-2"></i>Complete los campos obligatorios.';
                    toast.style.backgroundColor = '#ef4444';
                    toast.classList.remove('hidden');
                    clearTimeout(toast._timerId);
                    toast._timerId = setTimeout(() => toast.classList.add('hidden'), 4000);
                    return;
                }
                // Recolectar datos
                itemData.tipo = itemTypeSwitcher.value;
                if (itemData.tipo === 'producto' || itemData.tipo === 'servicio' || itemData.tipo === 'combo') {
                    itemData.descripcion = view.querySelector('#descripcion').value;
                    if (itemData.tipo === 'producto'){
                        itemData.sku = view.querySelector('#sku').value;
                        itemData.marca = (view.querySelector('#marca')?.value || '').trim();
                        itemData.modelo = (view.querySelector('#modelo')?.value || '').trim();
                    } else {
                        itemData.sku = '';
                        itemData.marca = '';
                        itemData.modelo = '';
                    }
                    itemData.proposito = (view.querySelector('#proposito')?.value || '').trim();
                    const usaCB = !!view.querySelector('#chkUsaCodigoBarra')?.checked;
                    itemData.usaCodigoBarra = (itemData.tipo === 'producto') ? usaCB : false;
                    itemData.codigoBarra = (itemData.tipo === 'producto' && usaCB) ? (view.querySelector('#codigoBarra')?.value || '').trim() : '';
                    // Logística
                    if (itemData.tipo === 'producto'){
                        itemData.stockMinimo = parseFloat(view.querySelector('#stockMinimo')?.value) || null;
                        itemData.stockMaximo = parseFloat(view.querySelector('#stockMaximo')?.value) || null;
                        itemData.tiempoReposicion = parseFloat(view.querySelector('#tiempoReposicion')?.value) || null;
                        itemData.altoCm = parseFloat(view.querySelector('#altoCm')?.value) || null;
                        itemData.anchoCm = parseFloat(view.querySelector('#anchoCm')?.value) || null;
                        itemData.profundoCm = parseFloat(view.querySelector('#profundoCm')?.value) || null;
                        itemData.pesoKg = parseFloat(view.querySelector('#pesoKg')?.value) || null;
                    } else {
                        itemData.stockMinimo = null; itemData.stockMaximo = null; itemData.tiempoReposicion = null; itemData.altoCm = null; itemData.anchoCm = null; itemData.profundoCm = null; itemData.pesoKg = null;
                    }
                    // Trazabilidad
                    if (itemData.tipo === 'producto'){
                        itemData.llevaNumeroSerie = (view.querySelector('#llevaNumeroSerie')?.value || '');
                        itemData.manejaLote = (view.querySelector('#manejaLote')?.value || '');
                        itemData.manejaVencimiento = (view.querySelector('#manejaVencimiento')?.value || '');
                    } else {
                        itemData.llevaNumeroSerie = '';
                        itemData.manejaLote = '';
                        itemData.manejaVencimiento = '';
                    }
                    // Precios
                    const pm = (view.querySelector('#pricingModel')?.value) || 'fixed';
                    itemData.pricingModel = pm;
                    if (itemData.tipo === 'servicio' && pm === 'hourly'){
                        itemData.hourlyRate = parseFloat(view.querySelector('#hourlyRate')?.value) || null;
                        itemData.costo = null; itemData.utilidad = null; itemData.precioVenta = null; itemData.precioBase = null; itemData.diferencial = null; itemData.precioFinal = null;
                    } else {
                        itemData.hourlyRate = null;
                        itemData.costo = parseFloat(view.querySelector('#costo')?.value) || null;
                        itemData.utilidad = parseFloat(view.querySelector('#utilidad')?.value) || null;
                        itemData.precioVenta = parseFloat(view.querySelector('#precioVenta')?.value) || null;
                        itemData.precioBase = parseFloat(view.querySelector('#precioBase')?.value) || null;
                        itemData.diferencial = parseFloat(view.querySelector('#diferencial')?.value) || null;
                        itemData.precioFinal = parseFloat(view.querySelector('#precioFinal')?.value) || null;
                    }
                    // Impuestos
                    itemData.esExento = !!view.querySelector('#chkEsExento')?.checked;
                    itemData.tipoImpuesto = view.querySelector('#tipoImpuesto')?.value || null;
                    itemData.impuestoAsignado = parseFloat(view.querySelector('#impuestoAsignado')?.value) || null;
                    // Ofertas
                    itemData.estaEnOferta = !!view.querySelector('#chkEstaEnOferta')?.checked;
                    itemData.ofertaTipo = view.querySelector('#ofertaTipo')?.value || null;
                    itemData.ofertaValor = parseFloat(view.querySelector('#ofertaValor')?.value) || null;
                    itemData.ofertaMotivo = view.querySelector('#ofertaMotivo')?.value || null;
                    itemData.ofertaInicio = view.querySelector('#ofertaInicio')?.value || null;
                    itemData.ofertaFin = view.querySelector('#ofertaFin')?.value || null;
                    // Servicio/Combo: datos específicos
                    if (itemData.tipo === 'servicio'){
                        const sel = view.querySelector('#serviceChecklists');
                        const selected = sel ? Array.from(sel.selectedOptions).map(o=>o.value) : [];
                        // Preferir lista dinámica (listWithSearch) si existe dentro de #serviceExtras
                        let dynComponents = [];
                        try{
                            const lists = view._dynamicLists || {};
                            for (const k of Object.keys(lists||{})){
                                const selK = FIELD_MAP[k];
                                const el = selK ? view.querySelector(selK) : null;
                                if (el && el.closest('#serviceExtras') && Array.isArray(lists[k]) && lists[k].length){
                                    dynComponents = lists[k].map(c=>({ itemId:c.id, descripcion:c.descripcion, sku:c.sku, qty:(c.qty||1), allowSubstitution: (c.allowSubstitution!==false) }));
                                    break;
                                }
                            }
                        }catch(_){ /* noop */ }
                        itemData.service = {
                            defaultSLA: view.querySelector('#serviceSLA')?.value || '',
                            checklists: selected,
                            components: dynComponents.length ? dynComponents : serviceComponents.map(c=>({ itemId:c.itemId, descripcion:c.descripcion, sku:c.sku, qty: c.qty||1, allowSubstitution: c.allowSubstitution!==false }))
                        };
                        itemData.combo = null;
                    } else if (itemData.tipo === 'combo'){
                        itemData.service = null;
                        // Preferir cualquier lista dinámica (listWithSearch) dentro de la sección Combo si existe
                        try{
                            let dynArr = [];
                            const lists = view._dynamicLists || {};
                            for (const k of Object.keys(lists||{})){
                                const selK = FIELD_MAP[k];
                                const el = selK ? view.querySelector(selK) : null;
                                if (el && el.closest('#sectionCombo') && Array.isArray(lists[k]) && lists[k].length){ dynArr = lists[k]; break; }
                            }
                            if (dynArr && dynArr.length){
                                itemData.combo = { components: dynArr.map(c=>({ itemId:c.id, descripcion:c.descripcion, sku:c.sku, qty:(c.qty||1) })) };
                            } else {
                                itemData.combo = { components: comboComponents.map(c=>({ itemId:c.itemId, descripcion:c.descripcion, sku:c.sku, qty:c.qty||1 })) };
                            }
                        }catch(_){ itemData.combo = { components: comboComponents.map(c=>({ itemId:c.itemId, descripcion:c.descripcion, sku:c.sku, qty:c.qty||1 })) }; }
                    } else {
                        itemData.service = null;
                        itemData.combo = null;
                    }
                    // Multimedia
                    const imageOrder = Array.from(imagePreviewContainer.querySelectorAll('.image-preview-item')).map(el => el.dataset.id);
                    itemData.multimedia = imageOrder.map(id => ({ id, ...imageMetadata[id], archived: imageState[id]?.archived || false }));
                    // Taxonomía
                    const catId = categoriaItemSel.value || '';
                    if (catId){
                        itemData.taxonomy = await collectTaxonomyValues(catId);
                    } else {
                        itemData.taxonomy = null;
                    }
                }
                // Validación adicional: en modo "similar" exigir cambio de descripción
                try{
                    if (!editingItemId && similarMode.active && similarMode.mustChange){
                        const base = (similarMode.baseDescripcion||'').trim().toLowerCase();
                        const curr = (itemData.descripcion||'').trim().toLowerCase();
                        if (base && curr === base){
                            toast.innerHTML = '<i class="fas fa-triangle-exclamation mr-2"></i>Cambia la descripción para diferenciar el ítem (ej.: color/tamaño).';
                            toast.style.backgroundColor = '#ef4444';
                            toast.classList.remove('hidden');
                            clearTimeout(toast._timerId);
                            toast._timerId = setTimeout(() => toast.classList.add('hidden'), 4000);
                            return;
                        }
                    }
                }catch(_){ /* noop */ }
                const restoreButton = () => { btnRegistrarItem.disabled = false; btnRegistrarItem.innerHTML = '<i class="fas fa-save mr-2"></i>Registrar Item'; };
                // Confirmación si el precio de venta cambió en modo edición
                if (editingItemId && originalPrecioVenta !== null) {
                    const newPV = itemData.precioVenta;
                    const isNum = (v)=> typeof v === 'number' && !isNaN(v);
                    if (isNum(newPV) && isNum(originalPrecioVenta) && Math.abs(newPV - originalPrecioVenta) > 0.0001) {
                        const okChange = confirm(`El precio de venta cambió de $${items_formatNumber(originalPrecioVenta)} a $${items_formatNumber(newPV)}. ¿Deseas confirmar este cambio?`);
                        if (!okChange) {
                            toast.innerHTML = '<i class="fas fa-circle-info mr-2"></i>Cambio de precio cancelado.';
                            toast.style.backgroundColor = '#9ca3af';
                            toast.classList.remove('hidden');
                            clearTimeout(toast._timerId);
                            toast._timerId = setTimeout(() => toast.classList.add('hidden'), 3000);
                            return;
                        }
                    }
                }
                try{
                    btnRegistrarItem.disabled = true;
                    btnRegistrarItem.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Registrando...';
                    toast.classList.add('hidden');
                    const beforeSaveMs = Date.now();
                    let okMsg = '';
                    let savedId = editingItemId || null;
                    const returnToPreviousFocusIfAny = async ()=>{
                        const prev = lastViewBeforeItems;
                        if (prev && prev !== 'items'){
                            // Cerrar actividad de edición si aplica
                            if (currentActivityId){ try{ await activityLogsCol.doc(currentActivityId).update({ status: 'saved', endedAt: firebase.firestore.FieldValue.serverTimestamp() }); }catch(e){} currentActivityId = null; }
                            showView(prev);
                            if (prev === 'items-search' && itemsSearchIframeEl && itemsSearchIframeEl.contentWindow){
                                try{ itemsSearchIframeEl.contentWindow.postMessage({ type: 'focusSearch' }, '*'); }catch(e){}
                            }
                            lastViewBeforeItems = null;
                        }
                    };
                    if (editingItemId) {
                        await itemsCol.doc(editingItemId).update(itemData);
                        okMsg = `Ítem actualizado con éxito (ID: ${editingItemId}).`;
                    } else {
                        const docRef = await itemsCol.add(itemData);
                        savedId = docRef.id;
                        okMsg = `Item registrado con éxito (ID: ${docRef.id}).`;
                        // Cerrar actividad de creación si existe
                        if (itemCreateActivityId){ try{ await activityLogsCol.doc(itemCreateActivityId).update({ status:'saved', endedAt: firebase.firestore.FieldValue.serverTimestamp(), itemId: savedId, descripcion: itemData.descripcion||'' }); }catch(e){} itemCreateActivityId = null; }
                        // Eliminar borrador de este usuario si existe
                        try{ await itemDraftsCol.doc(currentUser?.id || getDeviceId()).delete(); }catch(e){}
                        // Limpiar formulario tras registrar
                        try{
                            if (similarMode.series && similarMode.templateData){
                                // Mantener plantilla para crear otro similar
                                fillItemFormFromData(similarMode.templateData);
                                descripcionInput.value = '';
                                itemFormStartMs = Date.now();
                                showSimilarHint();
                            } else {
                                resetFormToNew(); itemFormStartMs = null; setSimilarMode(false);
                            }
                        }catch(e){}
                    }
                    // Evaluar faltantes opcionales
                    const missing = [];
                    const addIfMissing = (key, label) => { const v = itemData[key]; if (v===null || v===undefined || v==='') missing.push(label); };
                    if (itemData.tipo === 'producto'){
                        ['marca','modelo'].forEach(k=>addIfMissing(k, k));
                        ['stockMinimo','stockMaximo','tiempoReposicion','altoCm','anchoCm','profundoCm','pesoKg'].forEach(k=>addIfMissing(k, k));
                        ['manejaLote','manejaVencimiento'].forEach(k=>addIfMissing(k, k));
                    } else if (itemData.tipo === 'servicio'){
                        if ((itemData.pricingModel||'fixed')==='hourly' && (itemData.hourlyRate===null || itemData.hourlyRate==='')) missing.push('hourlyRate');
                    }
                    // Taxonomía faltantes
                    if (itemData.taxonomy && itemData.taxonomy.attributes){
                        Object.entries(itemData.taxonomy.attributes).forEach(([attrId, obj])=>{
                            if (obj && obj.required){
                                const v = obj.value;
                                const empty = v===null || v===undefined || v==='' || (Array.isArray(v) && v.length===0);
                                if (empty) missing.push('attr:'+ (obj.label || attrId));
                            }
                        });
                    }
                    if (missing.length){
                        const durationSec = itemFormStartMs ? Math.round((beforeSaveMs - itemFormStartMs)/1000) : null;
                        try{ await incompleteItemsCol.add({ itemId: savedId, descripcion: itemData.descripcion||'', userId: currentUser?currentUser.id:null, userName: currentUser?currentUser.name:null, createdAt: firebase.firestore.FieldValue.serverTimestamp(), durationSec, missingFields: missing, status:'pending' }); }catch(e){ console.warn('No se pudo registrar faltantes:', e); }
                    }
                    toast.innerHTML = `<i class=\"fas fa-check-circle mr-2\"></i>${okMsg}`;
                    toast.style.backgroundColor = '#22c55e';
                    toast.classList.remove('hidden');
                    clearTimeout(toast._timerId);
                    toast._timerId = setTimeout(() => toast.classList.add('hidden'), 4000);
                    // Volver a la vista previa desde la que se llegó a Crear/Editar
                    await returnToPreviousFocusIfAny();
                } catch (error) {
                    console.error('Error al agregar el documento: ', error);
                    let msg = 'Error al registrar el item.';
                    if (error.message.includes('quota')) msg = 'Error: La imagen es muy grande (Máx 1MB).';
                    else if (error.message.includes('permission-denied')) msg = 'Error: Permiso denegado. Revisa las reglas de seguridad.';
                    toast.innerHTML = `<i class=\"fas fa-triangle-exclamation mr-2\"></i>${msg}`;
                    toast.style.backgroundColor = '#ef4444';
                    toast.classList.remove('hidden');
                    clearTimeout(toast._timerId);
                    toast._timerId = setTimeout(() => toast.classList.add('hidden'), 5000);
                } finally { restoreButton(); }
            });

            // --- INICIALIZACIÓN DEL FORMULARIO ---
            itemTypeSwitcher.dispatchEvent(new Event('change'));
            // Tracking de borradores: guardar al salir de la vista y restaurar al volver
            document.addEventListener('viewchanged', async (ev)=>{
                const nextView = ev.detail?.viewId;
                // Saliendo de Crear Ítem: si hay datos sin guardar y no es edición, guardar borrador y limpiar
                if (currentViewId === 'items' && nextView !== 'items'){
                    const descVal = (view.querySelector('#descripcion')?.value||'').trim();
                    const hasDraft = !!itemFormStartMs || !!descVal;
                    if (hasDraft && !editingItemId){
                        try{
                            // Recolectar datos como borrador
                            const draft = {};
                            draft.tipo = itemTypeSwitcher.value;
                            if (draft.tipo === 'producto' || draft.tipo === 'servicio' || draft.tipo === 'combo') {
                                draft.descripcion = view.querySelector('#descripcion')?.value || '';
                                draft.sku = view.querySelector('#sku')?.value || '';
                                draft.marca = view.querySelector('#marca')?.value || '';
                                draft.modelo = view.querySelector('#modelo')?.value || '';
                                draft.proposito = view.querySelector('#proposito')?.value || '';
                                draft.usaCodigoBarra = !!view.querySelector('#chkUsaCodigoBarra')?.checked;
                                draft.codigoBarra = view.querySelector('#codigoBarra')?.value || '';
                                draft.stockMinimo = view.querySelector('#stockMinimo')?.value || '';
                                draft.stockMaximo = view.querySelector('#stockMaximo')?.value || '';
                                draft.tiempoReposicion = view.querySelector('#tiempoReposicion')?.value || '';
                                draft.altoCm = view.querySelector('#altoCm')?.value || '';
                                draft.anchoCm = view.querySelector('#anchoCm')?.value || '';
                                draft.profundoCm = view.querySelector('#profundoCm')?.value || '';
                                draft.pesoKg = view.querySelector('#pesoKg')?.value || '';
                                draft.llevaNumeroSerie = view.querySelector('#llevaNumeroSerie')?.value || '';
                                draft.manejaLote = view.querySelector('#manejaLote')?.value || '';
                                draft.manejaVencimiento = view.querySelector('#manejaVencimiento')?.value || '';
                                draft.costo = view.querySelector('#costo')?.value || '';
                                draft.utilidad = view.querySelector('#utilidad')?.value || '';
                                draft.precioVenta = view.querySelector('#precioVenta')?.value || '';
                                draft.precioBase = view.querySelector('#precioBase')?.value || '';
                                draft.diferencial = view.querySelector('#diferencial')?.value || '';
                                draft.precioFinal = view.querySelector('#precioFinal')?.value || '';
                                draft.esExento = !!view.querySelector('#chkEsExento')?.checked;
                                draft.tipoImpuesto = view.querySelector('#tipoImpuesto')?.value || '';
                                draft.impuestoAsignado = view.querySelector('#impuestoAsignado')?.value || '';
                                draft.estaEnOferta = !!view.querySelector('#chkEstaEnOferta')?.checked;
                                draft.ofertaTipo = view.querySelector('#ofertaTipo')?.value || '';
                                draft.ofertaValor = view.querySelector('#ofertaValor')?.value || '';
                                draft.ofertaMotivo = view.querySelector('#ofertaMotivo')?.value || '';
                                draft.ofertaInicio = view.querySelector('#ofertaInicio')?.value || '';
                                draft.ofertaFin = view.querySelector('#ofertaFin')?.value || '';
                                // Taxonomía (categoría y atributos)
                                try{
                                    const catId = categoriaItemSel.value || '';
                                    draft.categoriaItemId = catId;
                                    if (catId){
                                        const tvals = await collectTaxonomyValues(catId);
                                        draft.taxonomyDraft = tvals?.attributes || {};
                                    } else {
                                        draft.taxonomyDraft = {};
                                    }
                                }catch(_){ /* noop */ }
                                // Campos específicos en borrador
                                if (draft.tipo === 'servicio'){
                                    draft.pricingModel = view.querySelector('#pricingModel')?.value || 'fixed';
                                    draft.hourlyRate = view.querySelector('#hourlyRate')?.value || '';
                                    draft.serviceSLA = view.querySelector('#serviceSLA')?.value || '';
                                    const sel = view.querySelector('#serviceChecklists');
                                    draft.serviceChecklists = sel ? Array.from(sel.options).filter(o=>o.selected).map(o=>o.value) : [];
                                    // Copiar componentes actuales del servicio
                                    try{ draft.serviceComponents = Array.isArray(serviceComponents) ? serviceComponents.map(c=>({ itemId:c.itemId, descripcion:c.descripcion, sku:c.sku, qty:c.qty||1, allowSubstitution: c.allowSubstitution!==false })) : []; }catch(_){ draft.serviceComponents = []; }
                                } else if (draft.tipo === 'combo'){
                                    try{
                                        // Preferir lista dinámica si existe
                                        const dyn = Array.isArray(view._dynamicLists?.comboComponentsList) ? view._dynamicLists.comboComponentsList : [];
                                        if (dyn && dyn.length){
                                            draft.comboComponents = dyn.map(c=>({ itemId:c.id, descripcion:c.descripcion, sku:c.sku, qty:1 }));
                                        } else {
                                            draft.comboComponents = Array.isArray(comboComponents) ? comboComponents.map(c=>({ itemId:c.itemId, descripcion:c.descripcion, sku:c.sku, qty:c.qty||1 })) : [];
                                        }
                                    }catch(_){ draft.comboComponents = []; }
                                }
                                // Guardar listas dinámicas crudas para campos listWithSearch
                                try{ if (view._dynamicLists){ draft.dynamicLists = JSON.parse(JSON.stringify(view._dynamicLists)); } }catch(_){ /* ignore */ }
                            }
                            await itemDraftsCol.doc(currentUser?.id || getDeviceId()).set({
                                userId: currentUser?.id || null,
                                userName: currentUser?.name || null,
                                status: 'draft',
                                startedAt: itemFormStartMs ? new Date(itemFormStartMs) : null,
                                lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                data: draft
                            }, { merge: true });
                        }catch(e){ console.warn('No se pudo guardar borrador:', e); }
                    }
                    // Limpiar formulario y presencia básica para evitar datos obsoletos en Dashboard
                    try{ resetFormToNew(); itemFormStartMs = null; }catch(e){}
                    try{ await presenceCol.doc(currentUser?.id || getDeviceId()).set({ basic: {}, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }); }catch(e){}
                }
                // Entrando a Crear Ítem: ofrecer continuar borrador
                if (nextView === 'items'){
                    try{
                        const snap = await itemDraftsCol.doc(currentUser?.id || getDeviceId()).get();
                        const draft = snap.exists ? snap.data() : null;
                        if (draft && draft.status === 'draft' && draft.data && !editingItemId){
                            const cont = confirm('Tienes un borrador sin guardar. ¿Deseas continuar donde lo dejaste?');
                            if (cont){
                                // Rellenar formulario con el borrador
                                const d = draft.data || {};
                                const set = (sel, val='') => { const el = view.querySelector(sel); if (el) el.value = val; };
                                itemTypeSwitcher.value = d.tipo || 'producto'; itemTypeSwitcher.dispatchEvent(new Event('change'));
                                set('#descripcion', d.descripcion||'');
                                set('#sku', d.sku||'');
                                set('#marca', d.marca||'');
                                set('#modelo', d.modelo||'');
                                set('#proposito', d.proposito||'Para la Venta');
                                const chkCB = view.querySelector('#chkUsaCodigoBarra'); if (chkCB){ chkCB.checked = !!d.usaCodigoBarra; }
                                const contCB = view.querySelector('#codigoBarraContent'); if (contCB){ contCB.classList.toggle('visible', !!d.usaCodigoBarra); }
                                set('#codigoBarra', d.codigoBarra||'');
                                set('#stockMinimo', d.stockMinimo||''); set('#stockMaximo', d.stockMaximo||''); set('#tiempoReposicion', d.tiempoReposicion||'');
                                set('#altoCm', d.altoCm||''); set('#anchoCm', d.anchoCm||''); set('#profundoCm', d.profundoCm||''); set('#pesoKg', d.pesoKg||'');
                                set('#llevaNumeroSerie', d.llevaNumeroSerie||''); set('#manejaLote', d.manejaLote||''); set('#manejaVencimiento', d.manejaVencimiento||'');
                                set('#costo', d.costo||''); set('#utilidad', d.utilidad||''); set('#precioVenta', d.precioVenta||''); set('#precioBase', d.precioBase||''); set('#diferencial', d.diferencial||''); set('#precioFinal', d.precioFinal||'');
                                const chkEx = view.querySelector('#chkEsExento'); if (chkEx){ chkEx.checked = !!d.esExento; chkEx.dispatchEvent(new Event('change')); }
                                set('#tipoImpuesto', d.tipoImpuesto||''); set('#impuestoAsignado', d.impuestoAsignado||'');
                                const chkOf = view.querySelector('#chkEstaEnOferta'); if (chkOf){ chkOf.checked = !!d.estaEnOferta; chkOf.dispatchEvent(new Event('change')); }
                                set('#ofertaTipo', d.ofertaTipo||'Porcentaje (%)'); set('#ofertaValor', d.ofertaValor||''); set('#ofertaMotivo', d.ofertaMotivo||''); set('#ofertaInicio', d.ofertaInicio||''); set('#ofertaFin', d.ofertaFin||'');
                                // Restaurar taxonomía (categoría y atributos)
                                try{
                                    if (d.categoriaItemId){
                                        await loadCategoriesOptions(d.categoriaItemId);
                                        await renderTaxonomyFields(d.categoriaItemId, d.taxonomyDraft || {});
                                    } else {
                                        await loadCategoriesOptions();
                                    }
                                }catch(_){ /*noop*/ }
                                // Restaurar campos específicos de servicio/combos si aplica
                                if ((d.tipo||'') === 'servicio'){
                                    set('#pricingModel', d.pricingModel || 'fixed');
                                    updatePricingVisibility();
                                    set('#hourlyRate', d.hourlyRate || '');
                                    set('#serviceSLA', d.serviceSLA || '');
                                    const svcSel = view.querySelector('#serviceChecklists'); if (svcSel){
                                        const vals = Array.isArray(d.serviceChecklists)? d.serviceChecklists : [];
                                        Array.from(svcSel.options).forEach(o=> o.selected = vals.includes(o.value));
                                    }
                                    // Componentes
                                    serviceComponents = Array.isArray(d.serviceComponents)? d.serviceComponents.map(c=>({ itemId:c.itemId, descripcion:c.descripcion, sku:c.sku, qty:c.qty||1, allowSubstitution: c.allowSubstitution!==false })) : [];
                                    renderServiceComponents();
                                } else if ((d.tipo||'') === 'combo'){
                                    comboComponents = Array.isArray(d.comboComponents)? d.comboComponents.map(c=>({ itemId:c.itemId, descripcion:c.descripcion, sku:c.sku, qty:c.qty||1 })) : [];
                                    renderComboComponents();
                                }
                                // Restaurar listas dinámicas si existen (para listWithSearch)
                                try{
                                    if (d.dynamicLists && typeof d.dynamicLists==='object'){
                                        view._dynamicLists = d.dynamicLists || {};
                                        Object.keys(view._dynamicLists).forEach(k=>{ renderDynamicList(k); });
                                    }
                                }catch(_){ /* noop */ }
                                // iniciar temporizador de formulario
                                itemFormStartMs = Date.now();
                            } else {
                                // Iniciar nuevo: limpiar y borrar borrador
                                try{ resetFormToNew(); itemFormStartMs = null; }catch(e){}
                                try{ await itemDraftsCol.doc(currentUser?.id || getDeviceId()).delete(); }catch(e){}
                            }
                        }
                    }catch(e){ console.warn('Error revisando borradores:', e); }
                }
            });
            // IMPUESTOS: cargar y gestionar
            const tipoImpuestoSel = view.querySelector('#tipoImpuesto');
            const impuestoAsignadoInput = view.querySelector('#impuestoAsignado');
            const btnManageTaxes = view.querySelector('#btnManageTaxes');
            const taxesTableBody = document.getElementById('taxesTableBody');
            const btnAddTax = document.getElementById('btnAddTax');
            async function loadTaxesToSelect(){
                try{
                    const snap = await taxesCol.orderBy('name').get();
                    const taxes = snap.docs.map(d=>({id:d.id, ...d.data()})).filter(t=>t.visible!==false);
                    tipoImpuestoSel.innerHTML = '<option value="">Seleccione…</option>' + taxes.map(t=>`<option data-percent="${t.percent}" value="${t.id}">${t.name} (${t.percent}%)</option>`).join('') + '<option value="__manage__">-- Agregar/Gestionar Impuestos --</option>';
                }catch(e){ console.warn('No se pudieron cargar impuestos', e); }
            }
            async function loadTaxesToTable(){
                try{
                    const snap = await taxesCol.orderBy('name').get();
                    if (taxesTableBody) taxesTableBody.innerHTML = snap.docs.map(doc=>{
                        const t = {id:doc.id, ...doc.data()};
                        const eye = (t.visible===false)?'fa-eye-slash':'fa-eye';
                        return `<tr data-id="${t.id}"><td class="p-2">${t.name}</td><td class="p-2">${t.key||''}</td><td class="p-2">${t.percent}</td><td class="p-2 text-center"><button class="px-2 py-1 bg-gray-200 rounded toggle-vis"><i class="fa ${eye}"></i></button></td><td class="p-2 text-center"><button class="px-2 py-1 bg-blue-600 text-white rounded edit-tax"><i class="fa fa-pen"></i></button> <button class="px-2 py-1 bg-red-500 text-white rounded del-tax"><i class="fa fa-trash"></i></button></td></tr>`;
                    }).join('');
                }catch(e){}
            }
            btnManageTaxes?.addEventListener('click', async ()=>{ await loadTaxesToTable(); toggleModal('taxesModal', true); });
            tipoImpuestoSel?.addEventListener('change', async (e)=>{
                const val = e.target.value;
                if (val === '__manage__'){ await loadTaxesToTable(); toggleModal('taxesModal', true); return; }
                const opt = e.target.selectedOptions[0];
                const pct = parseFloat(opt?.dataset?.percent || '0');
                if (impuestoAsignadoInput) impuestoAsignadoInput.value = isNaN(pct)? '' : pct;
            });
            btnAddTax?.addEventListener('click', async ()=>{
                const name = (document.getElementById('taxName')?.value||'').trim();
                const key = (document.getElementById('taxKey')?.value||'').trim();
                const percent = parseFloat(document.getElementById('taxPercent')?.value||'');
                const visible = !!document.getElementById('taxVisible')?.checked;
                if (!name || isNaN(percent)){ alert('Nombre y % requeridos'); return; }
                const editingId = btnAddTax.getAttribute('data-editing-id');
                if (editingId){
                    await taxesCol.doc(editingId).update({ name, key, percent, visible });
                    btnAddTax.removeAttribute('data-editing-id'); btnAddTax.textContent='Agregar';
                } else {
                    await taxesCol.add({ name, key, percent, visible, country:'VE', created_at: firebase.firestore.FieldValue.serverTimestamp() });
                }
                await Promise.all([loadTaxesToTable(), loadTaxesToSelect()]);
                document.getElementById('taxName').value=''; document.getElementById('taxKey').value=''; document.getElementById('taxPercent').value=''; document.getElementById('taxVisible').checked=true;
            });
            taxesTableBody?.addEventListener('click', async (e)=>{
                const row = e.target.closest('tr[data-id]'); if (!row) return;
                const id = row.dataset.id;
                if (e.target.closest('.del-tax')){ await taxesCol.doc(id).delete(); await Promise.all([loadTaxesToTable(), loadTaxesToSelect()]); return; }
                if (e.target.closest('.toggle-vis')){
                    const doc = await taxesCol.doc(id).get(); const vis = !(doc.data()?.visible!==false ? true : false);
                    await taxesCol.doc(id).update({ visible: vis }); await Promise.all([loadTaxesToTable(), loadTaxesToSelect()]); return;
                }
                if (e.target.closest('.edit-tax')){
                    const doc = await taxesCol.doc(id).get(); const t = doc.data();
                    document.getElementById('taxName').value=t.name||''; document.getElementById('taxKey').value=t.key||''; document.getElementById('taxPercent').value=t.percent||''; document.getElementById('taxVisible').checked=!(t.visible===false);
                    btnAddTax.setAttribute('data-editing-id', id);
                    btnAddTax.textContent = 'Actualizar';
                }
            });
            (async ()=>{
                try{
                    const snap = await taxesCol.limit(1).get();
                    if (snap.empty){
                        const base = [
                            { name:'IVA General', key:'IVA_GENERAL', percent:16, visible:true },
                            { name:'IVA Reducido', key:'IVA_REDUCIDO', percent:8, visible:true },
                            { name:'IVA Adicional (Bienes y Servicios de Lujo)', key:'IVA_LUJO', percent:15, visible:true },
                            { name:'Exento', key:'EXENTO', percent:0, visible:true },
                            { name:'IGTF Monedas Extranjeras', key:'IGTF_3', percent:3, visible:false }
                        ];
                        for (const t of base){ await taxesCol.add({ ...t, country:'VE', created_at: firebase.firestore.FieldValue.serverTimestamp() }); }
                    }
                }catch(e){}
                loadTaxesToSelect();
            })();

            // === PLANTILLAS DE TÍTULO (Multimedia) ===
            async function ensureDefaultTitlePresets(){
                try{
                    const s = await imageTitlePresetsCol.limit(1).get();
                    if (s.empty){
                        const defs = [
                            { title:'Imagen Principal', visible:true, order:1 },
                            { title:'Frontal', visible:true, order:2 },
                            { title:'Lateral', visible:true, order:3 },
                            { title:'Vista Aérea', visible:true, order:4 },
                        ];
                        for (const p of defs){ await imageTitlePresetsCol.add({ ...p, created_at: firebase.firestore.FieldValue.serverTimestamp() }); }
                    }
                }catch(e){ console.warn('ensureDefaultTitlePresets', e); }
            }
            async function loadTitlePresets(){
                try{
                    const snap = await imageTitlePresetsCol.orderBy('order','asc').get();
                    const presets = snap.docs.map(d=>({ id:d.id, ...d.data() }));
                    if (imageTitlePresetsDL){
                        imageTitlePresetsDL.innerHTML = presets.filter(p=>p.visible!==false).map(p=>`<option value="${p.title}"></option>`).join('');
                    }
                    const list = document.getElementById('presetsList');
                    if (list){
                        list.innerHTML = presets.map(p=>{
                            const eye = (p.visible===false)?'fa-eye-slash':'fa-eye';
                            return `<li class="flex items-center justify-between border rounded p-2" data-id="${p.id}">
                                <span>${p.title}</span>
                                <div class="flex gap-2">
                                    <button class="px-2 py-1 bg-gray-200 rounded toggle-vis"><i class="fa ${eye}"></i></button>
                                    <button class="px-2 py-1 bg-red-500 text-white rounded del-preset"><i class="fa fa-trash"></i></button>
                                </div>
                            </li>`;
                        }).join('');
                    }
                }catch(e){ console.warn('loadTitlePresets', e); }
            }
            manageTitlePresetsBtn?.addEventListener('click', async ()=>{ await ensureDefaultTitlePresets(); await loadTitlePresets(); toggleModal('titlePresetsModal', true); });
            document.getElementById('btnAddPreset')?.addEventListener('click', async ()=>{
                const input = document.getElementById('presetInput');
                const title = (input?.value||'').trim();
                if (!title) return;
                await imageTitlePresetsCol.add({ title, visible:true, order: Date.now() });
                input.value='';
                await loadTitlePresets();
            });
            document.getElementById('presetsList')?.addEventListener('click', async (e)=>{
                const li = e.target.closest('li[data-id]'); if (!li) return;
                const id = li.dataset.id;
                if (e.target.closest('.del-preset')){ await imageTitlePresetsCol.doc(id).delete(); await loadTitlePresets(); return; }
                if (e.target.closest('.toggle-vis')){
                    const d = await imageTitlePresetsCol.doc(id).get();
                    const vis = !(d.data()?.visible===false);
                    await imageTitlePresetsCol.doc(id).update({ visible: !vis });
                    await loadTitlePresets();
                }
            });
            ensureDefaultTitlePresets().then(loadTitlePresets);
        }

        function initItemsSearchView() {
            const view = views['items-search'];
            view.innerHTML = `
                <div class="rounded-xl overflow-hidden border">
                    <iframe src="Items_Buscador.html" class="w-full min-h-[calc(100vh-180px)] bg-white" style="border:0;" loading="lazy"></iframe>
                </div>
            `;
            // Guardar referencia del iframe para coordinar retorno de foco
            itemsSearchIframeEl = view.querySelector('iframe');
        }

        function initItemsTaxonomyView() {
            const view = views['items-taxonomy'];
            view.innerHTML = `
                <div class="rounded-xl overflow-hidden border">
                    <iframe src="Items_Taxonomia.html" class="w-full min-h-[calc(100vh-180px)] bg-white" style="border:0;" loading="lazy"></iframe>
                </div>
            `;
        }

        function initItemsTypeConfigView() {
            const view = views['items-type-config'];
            view.innerHTML = `
                <div class="rounded-xl overflow-hidden border">
                    <iframe src="Items_SeccionesPorTipo.html" class="w-full min-h-[calc(100vh-180px)] bg-white" style="border:0;" loading="lazy"></iframe>
                </div>
            `;
        }

        async function ensureBaseData() {
             const batch = db.batch();
            
            const predefinedPermissions = [
                { key: 'view_dashboard', description: 'Ver dashboard gerencial', module: 'Dashboard' },
                { key: 'manage_items', description: 'Gestionar ítems (CRUD)', module: 'Inventario' }, // <-- NUEVO PERMISO
                { key: 'delete_items', description: 'Eliminar ítems del inventario', module: 'Inventario' },
                { key: 'delete_item_media', description: 'Eliminar archivos multimedia/documentos de ítems', module: 'Inventario' },
                { key: 'view_technician_panel', description: 'Acceder al panel de técnico', module: 'Técnico' },
                { key: 'manage_clients', description: 'Gestionar clientes (CRUD)', module: 'Clientes' },
                { key: 'view_bonus_report', description: 'Ver reporte de bonos', module: 'Bonos' },
                { key: 'manage_bonus_config', description: 'Configurar bonos', module: 'Bonos' },
                { key: 'manage_processes', description: 'Gestionar procesos y subprocesos', module: 'Configuración' },
                { key: 'manage_users', description: 'Gestionar usuarios', module: 'Sistema' },
                { key: 'manage_roles_permissions', description: 'Gestionar roles y permisos', module: 'Sistema' },
            ];

            const permPromises = predefinedPermissions.map(async (perm) => {
                const q = await permissionsCol.where('key', '==', perm.key).limit(1).get();
                if (q.empty) {
                    const docRef = permissionsCol.doc();
                    batch.set(docRef, perm);
                    return { ...perm, id: docRef.id };
                }
                return { ...q.docs[0].data(), id: q.docs[0].id };
            });
            const createdPermissions = await Promise.all(permPromises);
            const permissionsMap = createdPermissions.reduce((acc, perm) => ({...acc, [perm.key]: perm.id }), {});

            const predefinedRoles = {
                'Administrador': Object.keys(permissionsMap),
                'Supervisor': ['view_dashboard', 'manage_clients', 'manage_items'],
                'Técnico': ['view_technician_panel']
            };

            const rolePromises = Object.keys(predefinedRoles).map(async (roleName) => {
                const q = await rolesCol.where('name', '==', roleName).limit(1).get();
                if (q.empty) {
                    const docRef = rolesCol.doc();
                    batch.set(docRef, { name: roleName });
                    return { name: roleName, id: docRef.id };
                }
                return { name: q.docs[0].data().name, id: q.docs[0].id };
            });
            const createdRoles = await Promise.all(rolePromises);
            const rolesMap = createdRoles.reduce((acc, role) => ({...acc, [role.name]: role.id }), {});

            for (const roleName in predefinedRoles) {
                const roleId = rolesMap[roleName];
                const permissionKeys = predefinedRoles[roleName];
                for (const permKey of permissionKeys) {
                    const permissionId = permissionsMap[permKey];
                    if (roleId && permissionId) {
                        const q = await rolePermissionsCol.where('rol_id', '==', roleId).where('permission_id', '==', permissionId).limit(1).get();
                        if (q.empty) {
                            batch.set(rolePermissionsCol.doc(), { rol_id: roleId, permission_id: permissionId });
                        }
                    }
                }
            }
             await batch.commit();
        }


        async function loadMasterDataAndStart() {
            toggleLoading(true, 'Configurando sistema...');
            try {
                await ensureFirebaseAuth();
                // Intentar sembrar base de datos, pero no bloquear si hay 'permission-denied'
                try { await ensureBaseData(); } catch (seedErr) {
                    const msg = (seedErr && (seedErr.code || seedErr.message || '')).toString();
                    if (!/permission/i.test(msg)) {
                        console.warn('ensureBaseData falló (continuando igual):', seedErr);
                    } else {
                        console.warn('ensureBaseData: permiso denegado, se continua sin sembrar.');
                    }
                }
                toggleLoading(true, 'Cargando datos maestros...');
                const [usersSnap, rolesSnap, permsSnap, rolePermsSnap] = await Promise.all([
                    employeesCol.orderBy('order').get(),
                    rolesCol.orderBy('name').get(),
                    permissionsCol.get(),
                    rolePermissionsCol.get()
                ]);
                allUsers = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allRoles = rolesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allPermissions = permsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                rolePermissionsMap = {};
                rolePermsSnap.forEach(doc => {
                    const { rol_id, permission_id } = doc.data();
                    if (!rolePermissionsMap[rol_id]) rolePermissionsMap[rol_id] = [];
                    rolePermissionsMap[rol_id].push(permission_id);
                });

                userSelect.innerHTML = '';
                allUsers.filter(u => u.is_active).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    userSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error fatal cargando datos maestros:", error);
                loginMessage.textContent = 'No se pudo conectar con Firebase.';
            } finally {
                toggleLoading(false);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
            loadMasterDataAndStart();
        });

        window.addEventListener('message', (event) => {
            // Aquí puedes manejar mensajes que vengan de los iframes
            // Por ejemplo, si un iframe necesita notificar algo al contenedor principal
            if (event.data && event.data.type === 'requestUserData') {
                // Un iframe está pidiendo datos del usuario, se los enviamos
                respondWithAuthContext(event.source);
            } else if (event.data && event.data.type === 'typeFieldConfigChanged') {
                // Desde Items_SeccionesPorTipo: cambios en secciones/campos por tipo
                if (window.items_refreshPerTypeRules) window.items_refreshPerTypeRules();
            } else if (event.data && event.data.type === 'fieldFunctionsChanged') {
                // Desde Items_SeccionesPorTipo: cambios en funciones por campo
                try { if (window.items_clearTypeConfigCache) window.items_clearTypeConfigCache(); } catch(_){}
                try { attachSpecialFunctions(); } catch(_){}
            } else if (event.data && event.data.type === 'editItem' && event.data.id) {
                // Editar ítem solicitado desde el buscador
                // Registrar vista previa para devolver foco al finalizar
                if (currentViewId && currentViewId !== 'items') lastViewBeforeItems = currentViewId;
                showView('items');
                if (window.items_loadItemForEdit) window.items_loadItemForEdit(event.data.id, 'search');
            } else if (event.data && event.data.type === 'searchSelection') {
                // Actualizar presencia con selección en buscador y registrar actividad
                (async ()=>{
                    try{
                        const presRef = presenceCol.doc(currentUser?.id || getDeviceId());
                        const basic = { selectedItemDesc: (event.data.descripcion||'').toString() };
                        await presRef.set({ basic, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), selectionSince: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                    }catch(e){}
                    try{
                        if (searchSelectionActivityId){ await activityLogsCol.doc(searchSelectionActivityId).update({ status:'ended', endedAt: firebase.firestore.FieldValue.serverTimestamp() }); }
                        const a = await activityLogsCol.add({
                            kind: 'search_select',
                            userId: currentUser?.id || null,
                            userName: currentUser?.name || null,
                            status: 'selected',
                            selectedItemId: event.data.id || null,
                            selectedDescripcion: event.data.descripcion || '',
                            startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            viewId: 'items-search'
                        });
                        searchSelectionActivityId = a.id;
                    }catch(e){}
                })();
            } else if (event.data && event.data.type === 'taxonomyFocus') {
                // Desde Items_Taxonomia: enfoque en categoría/atributo
                (async ()=>{
                    try{
                        const presRef = presenceCol.doc(currentUser?.id || getDeviceId());
                        const basic = { taxonomyPath: (event.data.path||'').toString() };
                        await presRef.set({ basic, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), taxonomySince: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                    }catch(e){}
                    try{
                        await activityLogsCol.add({
                            kind: 'taxonomy_focus',
                            userId: currentUser?.id || null,
                            userName: currentUser?.name || null,
                            status: 'focused',
                            path: event.data.path || '',
                            startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            viewId: 'items-taxonomy'
                        });
                    }catch(e){}
                })();
            } else if (event.data && event.data.type === 'technicianTask') {
                // Desde Panel Técnico: información de tarea actual
                (async ()=>{
                    try{
                        const presRef = presenceCol.doc(currentUser?.id || getDeviceId());
                        const basic = { taskTitle: (event.data.title||'').toString(), taskId: event.data.id || null };
                        await presRef.set({ basic, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), taskSince: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                    }catch(e){}
                    try{
                        await activityLogsCol.add({
                            kind: 'technician_task',
                            userId: currentUser?.id || null,
                            userName: currentUser?.name || null,
                            status: 'started',
                            taskId: event.data.id || null,
                            taskTitle: event.data.title || '',
                            startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            viewId: 'technician'
                        });
                    }catch(e){}
                })();
            } else if (event.data && event.data.type === 'technicianTaskEnd') {
                // Desde Panel Técnico: fin/pausa/anulación de tarea
                (async ()=>{
                    const presRef = presenceCol.doc(currentUser?.id || getDeviceId());
                    let lastTitle = '';
                    try{
                        const snap = await presRef.get();
                        const data = snap.exists ? snap.data() : null;
                        lastTitle = data && data.basic && data.basic.taskTitle ? String(data.basic.taskTitle) : '';
                    }catch(e){}
                    try{
                        await presRef.set({
                            'basic.taskTitle': firebase.firestore.FieldValue.delete(),
                            'basic.taskId': firebase.firestore.FieldValue.delete(),
                            taskSince: firebase.firestore.FieldValue.delete(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    }catch(e){}
                    try{
                        await activityLogsCol.add({
                            kind: 'technician_task',
                            userId: currentUser?.id || null,
                            userName: currentUser?.name || null,
                            status: 'ended',
                            taskId: event.data.id || null,
                            taskTitle: lastTitle,
                            endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            viewId: 'technician'
                        });
                    }catch(e){}
                })();
            }
        });

    </script>
</body>
</html>

